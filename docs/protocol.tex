\documentclass{article}
\usepackage{ifxetex}
\usepackage{ifluatex}

% Dark magic. Woooooo.
% <https://tex.stackexchange.com/a/488473/78411>
\ifluatex
\directlua{
  luatexbase.add_to_callback("luaotfload.patch_font", function (fontdata)
    local parameters = fontdata.parameters
    if not parameters then return end
    if not (parameters.x_height or parameters[5] or 0) == 0 then return end
    if fontdata.characters and fontdata.characters[120] then
      parameters.x_height = fontdata.characters[120].height
    else
      parameters.x_height = (parameters.ascender or 0)*0.5
    end
  end, "Fix x-height")
}
\fi

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{bytefield}
\usepackage{graphicx}
\usepackage{mathtools}
\usepackage{xspace}
\usepackage{url}
\usepackage{changepage}
\usepackage{enumitem}
\usepackage{tabularx}
\usepackage{hhline}
\usepackage[usestackEOL]{stackengine}
\usepackage{comment}
\usepackage{needspace}
\usepackage[nobottomtitles,explicit]{titlesec}
\usepackage[hang]{footmisc}
\usepackage{xstring}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{etoolbox}
\usepackage{subdepth}
\usepackage{fix-cm}
\usepackage{hyphenat}
\usepackage{tocloft}
\usepackage{pict2e}
\usepackage{upgreek}
% Must be loaded before hyperref. <https://tex.stackexchange.com/a/22014/78411>
% noautomatic is used because either latexmk or the Makefile will take care of running
% mymakeindex.sh (which runs makeindex and then fixes duplicate page numbers).
\usepackage[nonewpage]{imakeidx}
\makeindex[noautomatic,columnsep=2.5em]

% This is used by the output of mymakeindex.sh in some cases.
% <https://stackoverflow.com/a/49406814/393146>
\newcommand{\increment}[1]{\the\numexpr #1+1\relax}

\tracinggroups=1
\tracingnesting=2


% The destlabel option creates "destination names" in the PDF, which allows
% linking to sections in URL fragments when viewing the PDF in a web browser:
% <https://tex.stackexchange.com/a/65049/78411>
%
% The Makefile previously supported processing the PDF through Ghostscript in
% order to optimize its size. Since TeXLive 2019, this is no longer an effective
% optimization. However, in case processing through Ghostscript is needed for other
% reasons, we retain the pdfa option, which has the side effect of preserving
% hyperlinks through such processing. (An alternative way of doing that would be
% to use -dPrinted=false on the Ghostscript command line.) The resulting document
% will not actually be PDF/A.
%
% To preserve destination names through Ghostscript processing, extractpdfmark
% would need to be used as described at <https://github.com/trueroad/extractpdfmark>.
%
\usepackage[unicode,bookmarksnumbered,bookmarksopen,allbordercolors=MidnightBlue,
            citebordercolor=Plum,urlbordercolor=BrickRed,pdfa,destlabel]{hyperref}

\usepackage[amsmath,amsthm,thmmarks,hyperref]{ntheorem}

\usepackage[printocg=never,exportocg=never]{ocgx2}

\usepackage{cleveref}
\usepackage{nameref}

\usepackage{silence}
\WarningFilter{latex}{Reference}
\WarningFilter{latex}{Citation}
\WarningFilter{latex}{Hyper reference}
\WarningFilter{imakeidx}{Remember to run}
\WarningFilter{microtype}{Unknown slot number of character}

\usepackage{microtype}

% Target biblatex >= v3.5. <https://tex.stackexchange.com/a/231215/78411>
\WarningFilter{biblatex}{'edtf'}
\WarningFilter{biblatex}{'\mkdaterangeedtf'}

\usepackage[style=alphabetic,maxbibnames=99,dateabbrev=false,urldate=edtf,seconds=true,
            backref=true,backrefstyle=none,backend=biber]{biblatex}
%\addbibresource{zcash.bib}

% Fonts
\usepackage{lmodern}
\usepackage{quattrocento}
\usepackage[bb=ams]{mathalfa}
\usepackage[scr]{rsfso}

% Quattrocento is beautiful but doesn't have an italic face. So we scale
% New Century Schoolbook italic to fit in with slanted Quattrocento and
% match its x height.
% (This has the side effect of making all italic text into boxes, so
% it won't linebreak, which has pluses and minuses.)
%
% XeTeX and LuaLaTeX require the \fontencoding{T1}:
% <https://tex.stackexchange.com/a/426300/78411>
%
\renewcommand{\emph}[1]{\hspace{0.15em}{\fontencoding{T1}\fontfamily{pnc}\selectfont\scalebox{1.02}[0.999]{\textit{#1}}}\hspace{0.02em}}

% While we're at it, let's match the tt x height to Quattrocento as well,
% and compress it a little to save space in tables.
\let\oldtexttt\texttt
\let\oldmathtt\mathtt
\renewcommand{\texttt}[1]{\scalebox{0.97}[1.07]{\oldtexttt{#1}}}
\renewcommand{\mathtt}[1]{\scalebox{0.97}[1.07]{$\oldmathtt{#1}$}}

% <https://tex.stackexchange.com/a/236822/78411>
\makeatletter
\def\@idxitem{\par\vspace{0.75ex plus 0.1ex minus 0.1ex}\hangindent 4em}
\def\subitem{\par\hangindent 6.5em \hspace*{2.5em}}
\def\subsubitem{\par\hangindent 9em \hspace*{5em}}
\makeatother

\crefformat{footnote}{#2\footnotemark[#1]#3}

\DeclareLabelalphaTemplate{
  \labelelement{\field{citekey}}
}

\DefineBibliographyStrings{english}{
  page  = {page},
  pages = {pages},
  backrefpage = {\mbox{$\uparrow$ p\!}},
  backrefpages = {\mbox{$\uparrow$ p\!}}
}

\setlength{\oddsidemargin}{-0.25in}
\setlength{\textwidth}{7in}
\setlength{\topmargin}{-0.75in}
\setlength{\textheight}{9.2in}
\setlength{\parindent}{0ex}

\newcommand{\defaultarraystretch}{1.4}
\renewcommand{\arraystretch}{\defaultarraystretch}

% <https://tex.stackexchange.com/a/49898/78411>
\makeatletter
\renewcommand{\@pnumwidth}{2em}
\makeatother

\newcommand{\pagenumfont}{\fontencoding{T1}\fontfamily{pnc}\selectfont\rule[-.2\baselineskip]{0pt}{1.32\baselineskip}}
\renewcommand{\cftsecpagefont}{\pagenumfont}
\renewcommand{\cftsubsecpagefont}{\pagenumfont}
\renewcommand{\cftsubsubsecpagefont}{\pagenumfont}
\renewcommand{\cftparapagefont}{\pagenumfont}

\hfuzz=1pt
\vfuzz=2pt
\overfullrule=2cm

\renewcommand{\footnotelayout}{\leftskip=1.4em}
\setlength{\footnotemargin}{0.55em}
\setlength{\footnotesep}{2ex}
\addtolength{\skip\footins}{3ex}

\renewcommand{\bottomtitlespace}{8ex}

% Use rubber lengths between paragraphs to improve default pagination.
% <https://tex.stackexchange.com/questions/17178/vertical-spacing-pagination-and-ideal-results>
\setlength{\parskip}{1.5ex plus 2pt minus 2pt}
%\setlength{\parskip}{6.3pt plus 2pt minus 2pt}

\widowpenalties 3 10000 1000 0

\setlength{\bibitemsep}{1.2ex}  % default is too cramped!
\setlength{\biblabelsep}{0.5em} % default is not cramped enough! :-)

\setlist[enumerate]{itemsep=0.3ex,before=\vspace{-0.8ex}}
\setlist[itemize]{itemsep=0.3ex,topsep=0.2ex,before=\vspace{-0.8ex},after=\vspace{1.5ex}}

\newlist{compactitemize}{itemize}{3}
\setlist[compactitemize]{itemsep=-1ex,topsep=0ex,before=\vspace{-0.2ex},leftmargin=1.2em,label=$\cdot$,after=\vspace{-3.3ex}}

\newlist{formulae}{itemize}{3}
\setlist[formulae]{itemsep=0.2ex,topsep=0ex,leftmargin=1.5em,label=,after=\vspace{1.5ex}}

\newlist{algorithm}{itemize}{3}
\setlist[algorithm]{itemsep=0ex,topsep=0ex,leftmargin=1.5em,label=,after=\vspace{1.5ex}}

\newlist{lines}{itemize}{3}
\setlist[lines]{itemsep=-0.5ex,topsep=0ex,before=\vspace{1ex},leftmargin=1.6em,label=,after=\vspace{1ex}}

\newlist{poetry}{itemize}{3}
\setlist[poetry]{itemsep=-0.5ex,topsep=0ex,leftmargin=0em,label=}

% <https://tex.stackexchange.com/a/12712/78411> (with X in place of m)
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}X{#1}}

% <https://tex.stackexchange.com/a/112585/78411>
\newcolumntype{R}{>{$}r<{,\,\;$}}
\newcolumntype{S}{>{$}r<{\;$}}
\newcolumntype{T}{>{$}l<{\;$}}
\newcolumntype{U}{>{$}l<{$}}
\newcolumntype{C}{>{$}c<{$}}

\makeatletter
\renewcommand*{\@fnsymbol}[1]{\ensuremath{\ifcase#1\or \dagger\or \ddagger\or \mathsection\or \mathparagraph\else\@ctrerr\fi}}
\makeatother

% Fix the height of citation link underlines.
% Also, biblatex really doesn't want to support Unicode citation labels, but I will not be beaten.
\newcommand{\linkstrut}{\rule[-0.4ex]{0ex}{\fontcharht\font`X}}
\DeclareFieldFormat{labelalpha}{\linkstrut\smash{\StrSubstitute{#1}{MAEA2010}{MAE√Å2010}}}
\DeclareFieldFormat{postnote}{\linkstrut\smash{#1}}
\let\oldcite\cite
\renewcommand{\cite}[2][]{\raisebox{0ex}{\oldcite[{#1}]{#2}}}

\let\oldfootnote\footnote
\renewcommand{\footnote}[1]{\hairspace\oldfootnote{#1}}
\newcommand{\footnotewithlabel}[2]{\hairspace\oldfootnote{\label{#1}{#2}}}

\newcommand{\noborders}[1]{% no nations
  \hypersetup{pdfborderstyle=/W 0}{#1}\hypersetup{pdfborderstyle=/S/U/W 0.7}}

\newcommand{\headingandlabel}[2]{\texorpdfstring{\noborders{\switchocg{labels}{#1}}}{}\hfill%
  \begin{ocg}{Labels}{labels}{false}\fcolorbox{black}{\labelcolor}{%
  \normalfont\normalsize\noborders{\href{\baseurl#2}{\color{black}\raisebox{0.2ex}{\linkstrut}\smash{#2}}}}\end{ocg}}

\newcommand{\refprefix}{\linkstrut\S\!\!}
\newcommand{\crossref}[1]{\raisebox{0ex}{\refprefix\autoref{#1}}\hspace{0.2em}\emph{`\nameref*{#1}\kern -0.05em'} on p.\,\pageref*{#1}}
\newcommand{\shortcrossref}[1]{\raisebox{0ex}{\refprefix\autoref{#1}} on p.\,\pageref*{#1}}
\newcommand{\theoremref}[1]{\raisebox{0ex}{\hyperref[#1]{Theorem \ref*{#1}\vphantom{,}}} on p.\,\pageref*{#1}}
\newcommand{\lemmaref}[1]{\raisebox{0ex}{\hyperref[#1]{Lemma \ref*{#1}\vphantom{,}}} on p.\,\pageref*{#1}}
\newcommand{\footnoteref}[1]{\hairspace\raisebox{0ex}{\cref{#1}}}
\newcommand{\snarkref}[2]{\raisebox{0ex}{\hyperref[#2]{\linkstrut\smash{\textbf{#1}}}}}

\newcommand{\callout}[2]{\vspace{1ex plus 2pt minus 2pt}#1\textbf{#2}\hspace{1em}}
\newcommand{\historyentry}[2]{\introlist\headingandlabel{\callout{}{#1}{#2}}{\##1}\label{#1}}

\renewcommand{\appendixautorefname}{ }
\renewcommand{\sectionautorefname}{ }
\renewcommand{\subsectionautorefname}{ }
\renewcommand{\subsubsectionautorefname}{ }
\renewcommand{\paragraphautorefname}{ }
\renewcommand{\subparagraphautorefname}{ }

%\let\oldhref\href
%\renewcommand{\href}[2]{\raisebox{0ex}{\oldhref{#1}{\linkstrut\smash{#2}}}}
%\let\oldurl\url
%\renewcommand{\url}[1]{\href{#1}{\nolinkurl{#1}}}

% <https://tex.stackexchange.com/a/60212/78411>
\newcommand{\subsubsubsection}[1]{\paragraph{#1}}
\newcommand{\subsubsubsubsection}[1]{\subparagraph{#1}}
\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4}

\newcommand{\slightlylarge}{\fontsize{10.5}{10.5}\selectfont}
\newcommand{\notsolarge}{\fontsize{11}{11}\selectfont}
\newcommand{\largeish}{\fontsize{12}{12}\selectfont}
\newcommand{\larger}{\fontsize{13}{13}\selectfont}
\newcommand{\Larger}{\fontsize{16}{16}\selectfont}

\titleformat{\section}{\Large\bfseries}{\thesection}{1em}{\headingandlabel{#1}{\#\sectionlabel}}
\titleformat{\subsection}{\larger\bfseries}{\thesubsection}{1em}{\headingandlabel{#1}{\#\sectionlabel}}
\titleformat{\subsubsection}{\largeish\bfseries}{\thesubsubsection}{1em}{\headingandlabel{#1}{\#\sectionlabel}}
\titleformat{\paragraph}{\notsolarge\bfseries}{\theparagraph}{1em}{\headingandlabel{#1}{\#\sectionlabel}}
\titleformat{\subparagraph}{\slightlylarge\bfseries}{\thesubparagraph}{1em}{\headingandlabel{#1}{\#\sectionlabel}}

\newcommand{\addparttocontents}[1]{\phantomsection\addcontentsline{toc}{section}{\larger{#1}}}

\newcommand{\phantompart}[2]{\def\sectionlabel{#2} \addparttocontents{#1}\label{#2}}
\newcommand{\lpart}[2]{\def\sectionlabel{#2} \intropart\vspace{20ex}\addparttocontents{#1}\section*{#1}\label{#2}}
\newcommand{\lsection}[2]{\def\sectionlabel{#2} \section{#1}\label{#2}}
\newcommand{\lsubsection}[2]{\def\sectionlabel{#2} \subsection{#1}\label{#2}}
\newcommand{\lsubsubsection}[2]{\def\sectionlabel{#2} \subsubsection{#1}\label{#2}}
\newcommand{\lsubsubsubsection}[2]{\def\sectionlabel{#2} \subsubsubsection{#1}\label{#2}}
\newcommand{\lsubsubsubsubsection}[2]{\def\sectionlabel{#2} \subsubsubsubsection{#1}\label{#2}}

\newcommand{\introlist}{\needspace{15ex}}
\newcommand{\introsection}{\needspace{35ex}}
\newcommand{\intropart}{\needspace{55ex}}

\newcommand{\theoremlabel}[1]{\def\sectionlabel{#1}}

\theorempreskip{5ex}

% <https://tex.stackexchange.com/a/30265/78411>
% <https://stackoverflow.com/a/36706487/393146> for the \phantomsection hack (to link to exactly the right place).
\newtheoremstyle{labelledtheorem}%
  {\item[] \headingandlabel{\normalfont\bfseries ##1\ ##2.\hspace{1em}}{\#\sectionlabel}\phantomsection\label{\sectionlabel}\normalfont\itshape}%
  {\item[] \headingandlabel{\normalfont\bfseries ##1\ ##2.\hspace{1em}\normalfont\itshape ##3.}{\#\sectionlabel}\phantomsection\label{\sectionlabel}\normalfont\itshape}
\theoremstyle{labelledtheorem} % switch to newly defined theorem style

% \cftdotfill{\cftdotsep} matches the dot spacing from the Contents (found in the documentation of tocloft).
\newcommand{\theoremlistentry}[5]{\vspace{0.5ex}\makebox[\textwidth][l]{\hyperlink{#5}{\vphantom{p}\makebox[4.5em][l]{#1}\makebox[3em][l]{#2}#3}\cftdotfill{\cftdotsep} #4}\\}

% We intentionally pass only 4 parameters to \theoremlistentry. The extra one (the target link)
% is effectively "curried". This works around a bug in ntheorem when its \newtheoremlisttype macro
% is used with hyperref.
\newtheoremlisttype{labelledtheorem}%
{\begin{tabular*}{\textwidth}{@{}l}}%
{\theoremlistentry{##1}{##2}{##3}{##4}}%
{\end{tabular*}}
\theoremlisttype{labelledtheorem}

% Theorems and lemmata are numbered together and consecutively within a subsection.
\newtheorem{theorem}{Theorem}[subsection]
\newtheorem{lemma}[theorem]{Lemma}


\mathchardef\mhyphen="2D

\newcommand{\lrarrow}{\texorpdfstring{$\leftrightarrow$}{‚Üî}}

% Using the astral plane character ùïä works, but triggers bugs in PDF readers üòõ
\newcommand{\rS}{\texorpdfstring{$\ParamS{r}$}{rS}}

% <https://tex.stackexchange.com/a/309445/78411>
\DeclareFontFamily{U}{FdSymbolA}{}
\DeclareFontShape{U}{FdSymbolA}{m}{n}{
    <-> s*[.4] FdSymbolA-Regular
}{}
\DeclareSymbolFont{fdsymbol}{U}{FdSymbolA}{m}{n}
\DeclareMathSymbol{\smallcirc}{\mathord}{fdsymbol}{"60}

\makeatletter
\newcommand{\hollowcolon}{\mathpalette\hollow@colon\relax}
\newcommand{\hollow@colon}[2]{
  \mspace{0.7mu}
  \vbox{\hbox{$\m@th#1\smallcirc$}\nointerlineskip\kern.45ex \hbox{$\m@th#1\smallcirc$}\kern-.06ex}
  \mspace{1mu}
}
\makeatother
\newcommand{\typecolon}{\;\hollowcolon\;}

% <https://tex.stackexchange.com/a/235120/78411>
\makeatletter
\newcommand*\bigcdot{\mathpalette\bigcdot@{.5}}
\newcommand*\bigcdot@[2]{\mathbin{\vcenter{\hbox{\scalebox{#2}{$\m@th#1\bullet$}}}}}
\makeatother

% <https://tex.stackexchange.com/a/269020/78411>, with explicit size parameter
\makeatletter
\newcommand*{\bigboxplus}[1]{\mathop{\mathpalette\big@boxplus{#1}\relax}\slimits@}
\newcommand*{\bigboxminus}[1]{\mathop{\mathpalette\big@boxminus{#1}\relax}\slimits@}
\newcommand*{\bigdiamondplus}[1]{\mathop{\mathpalette\big@diamondplus{#1}\relax}\slimits@}
\newcommand*{\bigdiamondminus}[1]{\mathop{\mathpalette\big@diamondminus{#1}\relax}\slimits@}
\newcommand*{\bigvartimes}[1]{\mathop{\mathpalette\big@vartimes{#1}\relax}\slimits@}

\newcommand{\big@boxplus}[2]{%
  \vcenter{\m@th\bigbox@thickness{#1}\hbox{%
    \setlength{\unitlength}{#2}%
    \begin{picture}(1,1)
    \polyline(0.1,0.1)(0.9,0.1)(0.9,0.9)(0.1,0.9)(0.1,0.1)(0.5,0.1)
    \polyline(0.5,0.1)(0.5,0.9)
    \polyline(0.1,0.5)(0.9,0.5)
    \end{picture}}}}

\newcommand{\big@boxminus}[2]{%
  \vcenter{\m@th\bigbox@thickness{#1}\hbox{%
    \setlength{\unitlength}{#2}%
    \begin{picture}(1,1)
    \polyline(0.1,0.1)(0.9,0.1)(0.9,0.9)(0.1,0.9)(0.1,0.1)(0.5,0.1)
    \polyline(0.1,0.5)(0.9,0.5)
    \end{picture}}}}

\newcommand{\big@diamondplus}[2]{%
  \vcenter{\m@th\bigbox@thickness{#1}\hbox{%
    \setlength{\unitlength}{#2}%
    \begin{picture}(1,1)
    \polyline(0,0.5)(0.5,0)(1,0.5)(0.5,1)(0,0.5)(0.5,0)
    \polyline(0.5,0)(0.5,1)
    \polyline(0,0.5)(1,0.5)
    \end{picture}}}}

\newcommand{\big@diamondminus}[2]{%
  \vcenter{\m@th\bigbox@thickness{#1}\hbox{%
    \setlength{\unitlength}{#2}%
    \begin{picture}(1,1)
    \polyline(0,0.5)(0.5,0)(1,0.5)(0.5,1)(0,0.5)(0.5,0)
    \polyline(0,0.5)(1,0.5)
    \end{picture}}}}

\newcommand{\big@vartimes}[2]{%
  \vcenter{\m@th\bigbox@thickness{#1}\hbox{%
    \setlength{\unitlength}{#2}%
    \begin{picture}(1,1)
    \polyline(0.2,0.08)(0.8,1)
    \polyline(0.2,1)(0.8,0.08)
    \end{picture}}}}

\newcommand{\bigbox@thickness}[1]{%
  \ifx#1\displaystyle
    \linethickness{0.2ex}%
  \else
    \ifx#1\textstyle
      \linethickness{0.16ex}%
    \else
      \ifx#1\scriptstyle
        \linethickness{0.12ex}%
      \else
        \linethickness{0.1ex}%
      \fi
    \fi
  \fi
}
\makeatother

% We just want one ampersand symbol from boisik.
\DeclareSymbolFont{bskadd}{U}{bskma}{m}{n}
\DeclareFontFamily{U}{bskma}{\skewchar\font130 }
\DeclareFontShape{U}{bskma}{m}{n}{<->bskma10}{}
\DeclareMathSymbol{\binampersand}{\mathbin}{bskadd}{"EE}

% $v$ is too close to $u$.
% <https://tex.stackexchange.com/questions/130569/sharp-or-angled-v-in-math-mode-varv>
\DeclareSymbolFont{matha}{OML}{txmi}{m}{it}
\DeclareMathSymbol{\varv}{\mathord}{matha}{118}

% newtxmath defines some nice characters, but has too many side effects
% and is completely incompatible with lmodern. We pull these definitions out
% of <newtxmath.sty>.

% from <https://tex.stackexchange.com/q/452081/78411>
\makeatletter
\newif\iftx@libertine
\newif\iftx@minion
\newif\iftx@coch
\newif\iftx@ch
\newif\iftx@stxtwo
\makeatother

%\DeclareSymbolFont{lettersA}{U}{ntxmia}{m}{it}
%\SetSymbolFont{lettersA}{bold}{U}{ntxmia}{b}{it}
%\DeclareFontSubstitution{U}{ntxmia}{m}{it}

%\DeclareMathSymbol{\uprho}{\mathord}{lettersA}{26}
%\DeclareMathSymbol{\upvarphi}{\mathord}{lettersA}{39}

\DeclareSymbolFont{AMSm}{U}{ntxsym}{m}{n}
\SetSymbolFont{AMSm}{bold}{U}{ntxsym}{b}{n}
\DeclareFontSubstitution{U}{ntxsym}{m}{n}

\DeclareMathSymbol{\Game}{\mathord}{AMSm}{97}
\DeclareMathSymbol{\ggg}{\mathrel}{AMSm}{239}
\DeclareMathSymbol{\circledast}{\mathbin}{AMSm}{254}

% end of characters from newtxmath

\newcommand{\hairspace}{~\!}
\newcommand{\oparen}{\big(}
\newcommand{\hparen}{\phantom{\oparen}}
\newcommand{\cparen}{\big)}
\newcommand{\mhspace}[1]{\mbox{\hspace{#1}}}
\newcommand{\tab}{\hspace{1.5em}}

\newcommand{\raisedstrut}{\raisebox{0.3ex}{\strut}}

% <https://tex.stackexchange.com/a/415155/78411>
\newcommand{\clasp}[3][0pt]{\stackengine{0pt}{#3}{\kern#1#2}{O}{c}{F}{F}{L}}

\newcommand{\plus}{\hairspace +\hairspace}
\newcommand{\vv}{\hspace{0.071em}\varv\hspace{0.064em}}
\newcommand{\varvv}{\varv\kern 0.02em\varv}
\newcommand{\yy}{\hspace{0.022em}y\hspace{0.021em}}

\newcommand{\hfrac}[2]{\scalebox{0.8}{$\genfrac{}{}{0.5pt}{0}{#1}{#2}$}}
\newcommand{\ssqrt}[1]{\rlap{\scalebox{0.64}[1]{$\sqrt{\scalebox{1.5625}[1]{${#1}\vphantom{b}$}}$}} %
             \hspace{0.005em}\scalebox{0.64}[1]{$\sqrt{\scalebox{1.5625}[1]{$\phantom{#1}\vphantom{b}$}}$}}

\newcommand{\sbitbox}[2]{\bitbox{#1}{\strut #2}}


\newcommand{\docversion}{}
\newcommand{\SproutSpec}{Sprout}
\newcommand{\SaplingSpec}{Overwinter+Sapling}
\newcommand{\BlossomSpec}{Overwinter+Sapling+Blossom}
\newcommand{\HeartwoodSpec}{Overwinter+Sapling+Blossom+Heartwood}
\newcommand{\NufourSpec}{Overwinter+Sapling+Blossom+Heartwood+NU4}
\newtoggle{issapling}
\togglefalse{issapling}
\newtoggle{isblossom}
\togglefalse{isblossom}
\newtoggle{isheartwood}
\togglefalse{isheartwood}
\newtoggle{isnufour}
\togglefalse{isnufour}
\InputIfFileExists{protocol.ver}{}{}

\newcommand{\doctitle}{Multi-Asset Shielded Pool Specification}
\newcommand{\leadauthor}{Daira Hopwood}
\newcommand{\coauthora}{Sean Bowe}
\newcommand{\coauthorb}{Taylor Hornby}
\newcommand{\coauthorc}{Nathan Wilcox}

\newcommand{\keywords}{anonymity, applications, cryptographic protocols,\
electronic commerce and payment, financial privacy, proof of work, zero knowledge}


% <https://en.wikibooks.org/wiki/LaTeX/Colors#The_68_standard_colors_known_to_dvips>

\newcommand{\todo}[1]{{\color{Sepia}\sf{TODO: #1}}}
\definecolor{green}{RGB}{0,100,10}

\newcommand{\vulncolor}{BrickRed}
\newcommand{\setwarning}{\color{\warningcolor}}
\newcommand{\warningcolor}{BrickRed}
\newcommand{\changedcolor}{magenta}
\newcommand{\changedcolorname}{\changedcolor}
\newcommand{\setchanged}{\color{\changedcolor}}
\newcommand{\changed}[1]{\texorpdfstring{{\setchanged{#1}}}{#1}}
\newcommand{\saplingcolor}{green}
\newcommand{\saplingcolorname}{\saplingcolor}
\newcommand{\overwintercolor}{blue}
\newcommand{\overwintercolorname}{\overwintercolor}
\newcommand{\blossomcolor}{red}
\newcommand{\blossomcolorname}{\blossomcolor}
\newcommand{\heartwoodcolor}{red!30!orange}
\newcommand{\heartwoodcolorname}{orange}
\newcommand{\nufourcolor}{red!50!blue!85}
\newcommand{\nufourcolorname}{purple}
\newcommand{\labelcolor}{yellow!20}

\iftoggle{isnufour}{
  \providecommand{\baseurl}{https://zips.z.cash/protocol/nufour.pdf}
  \toggletrue{isheartwood}
  \newcommand{\setnufour}{\color{\nufourcolor}}
  \newcommand{\nufour}[1]{\texorpdfstring{{\setnufour{#1}}}{#1}}
  \newcommand{\notnufour}[1]{}
  \newcommand{\notbeforenufour}[1]{#1}
} {
  \newcommand{\setnufour}{}
  \newcommand{\nufour}[1]{}
  \newcommand{\notnufour}[1]{#1}
  \newcommand{\notbeforenufour}[1]{}
}

\iftoggle{isheartwood}{
  \providecommand{\baseurl}{https://zips.z.cash/protocol/protocol.pdf}
  \toggletrue{isblossom}
  \newcommand{\setheartwood}{\color{\heartwoodcolor}}
  \newcommand{\heartwood}[1]{\texorpdfstring{{\setheartwood{#1}}}{#1}}
  \newcommand{\notheartwood}[1]{}
  \newcommand{\notbeforeheartwood}[1]{#1}
} {
  \newcommand{\setheartwood}{}
  \newcommand{\heartwood}[1]{}
  \newcommand{\notheartwood}[1]{#1}
  \newcommand{\notbeforeheartwood}[1]{}
}

\iftoggle{isblossom}{
  \providecommand{\baseurl}{https://zips.z.cash/protocol/blossom.pdf}
  \toggletrue{issapling}
  \newcommand{\setblossom}{\color{\blossomcolor}}
  \newcommand{\blossom}[1]{\texorpdfstring{{\setblossom{#1}}}{#1}}
  \newcommand{\notblossom}[1]{}
  \newcommand{\notbeforeblossom}[1]{#1}
} {
  \newcommand{\setblossom}{}
  \newcommand{\blossom}[1]{}
  \newcommand{\notblossom}[1]{#1}
  \newcommand{\notbeforeblossom}[1]{}
}

\iftoggle{issapling}{
  \providecommand{\baseurl}{https://zips.z.cash/protocol/sapling.pdf}
  \newcommand{\sprout}[1]{}
  \newcommand{\notsprout}[1]{#1}
  \newcommand{\setsapling}{\color{\saplingcolor}}
  \newcommand{\sapling}[1]{\texorpdfstring{{\setsapling{#1}}}{#1}}
  \newcommand{\setoverwinter}{\color{\overwintercolor}}
  \newcommand{\overwinter}[1]{\texorpdfstring{{\setoverwinter{#1}}}{#1}}
  \newcommand{\optSprout}[1]{{#1}^\mathsf{Sprout}}
} {
  \providecommand{\baseurl}{https://zips.z.cash/protocol/sprout.pdf}
  \newcommand{\sprout}[1]{#1}
  \newcommand{\notsprout}[1]{}
  \newcommand{\setsapling}{}
  \newcommand{\sapling}[1]{}
  \newcommand{\setoverwinter}{}
  \newcommand{\overwinter}[1]{}
  \newcommand{\optSprout}[1]{#1}
}


\hypersetup{
  pdfborderstyle={/S/U/W 0.7},
  pdfinfo={
    Title={\doctitle, \docversion},
    Author={\leadauthor, \coauthora, \coauthorb, \coauthorc},
    Keywords={\keywords}
  },
  baseurl={\baseurl}
}


% Terminology

\newcommand{\indextype}{normalstyle}
\newcommand{\normalstyle}[1]{#1}
\newcommand{\definingstyle}[1]{\textit{\textbf{#1}}\kern 0.05em}
\newcommand{\defining}[1]{{\renewcommand{\indextype}{definingstyle}#1}}

% The arguments are: {link_as_formatted}{index_sort_key}{index_as_formatted}.
%
% \index goes after the term so that the page reference is correct if at the start of a page (see
% <https://tex.stackexchange.com/questions/476644/how-can-i-define-an-new-index-command-that-works-better-for-paragraphs>,
% although our solution is different).
% The method of linking to the index is inspired by <https://tex.stackexchange.com/a/399776/78411>.
% \texorpdfstring doesn't actually work here other than to cause an error if we would end up with a
% link in a heading, rather than a hang.
\newcommand{\indexlink}[3]{\texorpdfstring{\hypersetup{pdfborderstyle=/W 0}\hyperlink{index:#2}{#1}%
\hypersetup{pdfborderstyle={/S/U/W 0.7}}\index{#2@{\protect\hypertarget{index:#2}{}\linkstrut\smash{#3}}|\indextype}}{}\xspace}

\newcommand{\rawterm}[1]{\textsl{#1}\kern 0.05em}
\newcommand{\termnoindex}[1]{\rawterm{#1}\xspace}
\newcommand{\termandindex}[2]{\indexlink{\rawterm{#1}}{#2}{#2}}
\newcommand{\term}[1]{\termandindex{#1}{#1}}
\newcommand{\terms}[1]{\termandindex{#1s}{#1}}
\newcommand{\termes}[1]{\termandindex{#1es}{#1}}
\newcommand{\termx}[1]{\termandindex{\MakeUppercase #1}{#1}}
\newcommand{\termxs}[1]{\termandindex{\MakeUppercase #1s}{#1}}
\newcommand{\termxes}[1]{\termandindex{\MakeUppercase #1es}{#1}}
\newcommand{\titleterm}[1]{#1}
\newcommand{\titleterms}[1]{#1s}
\newcommand{\titletermes}[1]{#1es}
\newcommand{\termbfnoindex}[1]{\textbf{#1}\xspace}
\newcommand{\termbf}[1]{\indexlink{\textbf{#1}}{#1}{\textbf{#1}}}
\newcommand{\termsf}[1]{\indexlink{\textsf{#1}}{#1}{\textsf{#1}}}
\newcommand{\conformance}[1]{\indexlink{\textbf{#1}}{#1}{\textbf{#1}}}
\newcommand{\quotedtermnoindex}[1]{``~\!\!\termnoindex{#1}''}
\newcommand{\quotedtermandindex}[2]{``~\!\!\termandindex{#1}{#2}''}
\newcommand{\quotedterm}[1]{``~\!\!\term{#1}''}
\newcommand{\definingquotedterm}[1]{\defining{\quotedterm{#1}}}

\newcommand{\Zcash}{\termbfnoindex{Zcash}}
\newcommand{\Zerocash}{\termbf{Zerocash}}
\newcommand{\ZerocashText}{\textbf{Zerocash}}
\newcommand{\Sprout}{\termbf{Sprout}}
\newcommand{\SproutText}{\textbf{Sprout}}
\newcommand{\SproutOrZcash}{\notsprout{\Sprout}\sprout{\Zcash}}
\newcommand{\SproutOrNothing}{\notsprout{\Sprout}}
\newcommand{\SproutOrNothingText}{\notsprout{\SproutText}}
\newcommand{\pSproutOrNothing}{\notsprout{ (\Sprout)}}
\newcommand{\pSproutOrNothingText}{\notsprout{ (\SproutText)}}
\newcommand{\Overwinter}{\termbf{Overwinter}}
\newcommand{\OverwinterText}{\textbf{Overwinter}}
\newcommand{\Sapling}{\termbf{Sapling}}
\newcommand{\SaplingText}{\textbf{Sapling}}
\newcommand{\Blossom}{\termbf{Blossom}}
\newcommand{\BlossomText}{\textbf{Blossom}}
\newcommand{\Heartwood}{\termbf{Heartwood}}
\newcommand{\HeartwoodText}{\textbf{Heartwood}}
\newcommand{\Nufour}{\termbf{NU4}}
\newcommand{\NufourText}{\textbf{NU4}}
\newcommand{\Bitcoin}{\termbf{Bitcoin}}
\newcommand{\BitcoinText}{\textbf{Bitcoin}}
\newcommand{\CryptoNote}{\termbf{CryptoNote}}
\newcommand{\Mimblewimble}{\termbf{Mimblewimble}}
\newcommand{\Bulletproofs}{\termbf{Bulletproofs}}
\newcommand{\ZEC}{\termbf{ZEC}}
\newcommand{\zatoshi}{\term{zatoshi}}
\newcommand{\zcashd}{\termsf{zcashd}}
\newcommand{\Makefile}{\texttt{Makefile}\xspace}

\newcommand{\MUST}{\conformance{MUST}}
\newcommand{\MUSTNOT}{\conformance{MUST NOT}}
\newcommand{\SHOULD}{\conformance{SHOULD}}
\newcommand{\SHOULDNOT}{\conformance{SHOULD NOT}}
\newcommand{\RECOMMENDED}{\conformance{RECOMMENDED}}
\newcommand{\MAY}{\conformance{MAY}}
\newcommand{\ALLCAPS}{\conformance{ALL CAPS}}

\newcommand{\collisionResistant}{\termandindex{collision\hyp resistant}{collision resistance}}
\newcommand{\collisionResistance}{\term{collision resistance}}
\newcommand{\xCollisionResistance}{\termx{collision resistance}}

\newcommand{\publicKey}{\term{public key}}
\newcommand{\publicKeys}{\terms{public key}}
\newcommand{\privateKey}{\term{private key}}
\newcommand{\privateKeys}{\terms{private key}}
\newcommand{\keyPrivacy}{\term{key privacy}}
\newcommand{\xKeyPrivacy}{\termx{key privacy}}
\newcommand{\keyPrivate}{\termandindex{key\hyp private}{key privacy}}
\newcommand{\xKeyPrivate}{\termandindex{Key\hyp private}{key privacy}}

\newcommand{\note}{\term{note}}
\newcommand{\notes}{\terms{note}}
\newcommand{\Note}{\titleterm{Note}}
\newcommand{\Notes}{\titleterms{Note}}
\newcommand{\dummy}{\term{dummy}}
\newcommand{\DummyNotes}{\titleterms{Dummy Note}}
\newcommand{\commitmentScheme}{\term{commitment scheme}}
\newcommand{\commitmentSchemes}{\terms{commitment scheme}}
\newcommand{\commitmentTrapdoor}{\term{commitment trapdoor}}
\newcommand{\commitmentTrapdoors}{\terms{commitment trapdoor}}
\newcommand{\trapdoor}{\termandindex{trapdoor}{commitment trapdoor}}
\newcommand{\trapdoors}{\termandindex{trapdoors}{commitment trapdoor}}
\newcommand{\noteCommitment}{\term{note commitment}}
\newcommand{\noteCommitments}{\terms{note commitment}}
\newcommand{\xNoteCommitments}{\termxs{note commitment}}
\newcommand{\notesCommitment}{\termandindex{note's commitment}{note commitment}}
\newcommand{\NoteCommitment}{\titleterm{Note Commitment}}
\newcommand{\NoteCommitments}{\titleterms{Note Commitment}}
\newcommand{\noteCommitmentTree}{\term{note commitment tree}}
\newcommand{\noteCommitmentTrees}{\terms{note commitment tree}}
\newcommand{\NoteCommitmentTrees}{\titleterms{Note Commitment Tree}}
\newcommand{\notePosition}{\term{note position}}
\newcommand{\notePositions}{\terms{note position}}
\newcommand{\positionedNote}{\term{positioned note}}
\newcommand{\positionedNotes}{\terms{positioned note}}
\newcommand{\noteTraceabilitySet}{\term{note traceability set}}
\newcommand{\noteTraceabilitySets}{\terms{note traceability set}}
\newcommand{\KeyComponents}{\titleterms{Key Component}}
\newcommand{\valueCommitment}{\term{value commitment}}
\newcommand{\valueCommitments}{\terms{value commitment}}
\newcommand{\valueCommitmentScheme}{\term{value commitment scheme}}
\newcommand{\joinSplitDescription}{\term{JoinSplit description}}
\newcommand{\joinSplitDescriptions}{\terms{JoinSplit description}}
\newcommand{\JoinSplitDescriptions}{\titleterms{JoinSplit Description}}
\newcommand{\sequenceOfJoinSplitDescriptions}{\changed{sequence of} \joinSplitDescription{}\kern -0.05em\changed{\textsl{s}}}
\newcommand{\joinSplitTransfer}{\term{JoinSplit transfer}}
\newcommand{\joinSplitTransfers}{\terms{JoinSplit transfer}}
\newcommand{\JoinSplitTransfer}{\titleterm{JoinSplit Transfer}}
\newcommand{\JoinSplitTransfers}{\titleterms{JoinSplit Transfer}}
\newcommand{\joinSplitSignature}{\term{JoinSplit signature}}
\newcommand{\joinSplitSignatures}{\terms{JoinSplit signature}}
\newcommand{\JoinSplitSignature}{\titleterm{JoinSplit Signature}}
\newcommand{\joinSplitSigningKey}{\term{JoinSplit signing key}}
\newcommand{\joinSplitVerifyingKey}{\term{JoinSplit verifying key}}
\newcommand{\joinSplitCircuit}{\term{JoinSplit circuit}}
\newcommand{\joinSplitStatement}{\term{JoinSplit statement}}
\newcommand{\joinSplitStatements}{\terms{JoinSplit statement}}
\newcommand{\JoinSplitStatement}{\titleterm{JoinSplit Statement}}
\newcommand{\joinSplitProof}{\term{JoinSplit proof}}
\newcommand{\shieldedTransfer}{\term{shielded transfer}}
\newcommand{\shieldedTransfers}{\terms{shielded transfer}}
\newcommand{\shieldedSpend}{\term{shielded spend}}
\newcommand{\shieldedSpends}{\terms{shielded spend}}
\newcommand{\shieldedInput}{\term{shielded input}}
\newcommand{\shieldedInputs}{\terms{shielded input}}
\newcommand{\spendDescription}{\term{Spend description}}
\newcommand{\spendDescriptions}{\terms{Spend description}}
\newcommand{\SpendDescriptions}{\titleterms{Spend Description}}
\newcommand{\spendTransfer}{\term{Spend transfer}}
\newcommand{\spendTransfers}{\terms{Spend transfer}}
\newcommand{\SpendTransfers}{\titleterms{Spend Transfer}}
\newcommand{\spendCircuit}{\term{Spend circuit}}
\newcommand{\spendStatement}{\term{Spend statement}}
\newcommand{\spendStatements}{\terms{Spend statement}}
\newcommand{\SpendStatement}{\titleterm{Spend Statement}}
\newcommand{\spendProof}{\term{Spend proof}}
\newcommand{\spendAuthSignature}{\term{spend authorization signature}}
\newcommand{\spendAuthSignatures}{\terms{spend authorization signature}}
\newcommand{\spendAuthRandomizer}{\term{spend authorization randomizer}}
\newcommand{\spendAuthRandomizers}{\terms{spend authorization randomizer}}
\newcommand{\spendAuthAddressKey}{\term{spend authorization address key}}
\newcommand{\spendAuthAddressKeys}{\term{spend authorization address key}}
\newcommand{\spendAuthPrivateKey}{\term{spend authorization private key}}
\newcommand{\spendAuthPrivateKeys}{\term{spend authorization private key}}
\newcommand{\SpendAuthSignature}{\titleterm{Spend Authorization Signature}}
\newcommand{\spendAuthSignatureScheme}{\term{spend authorization signature scheme}}
\newcommand{\outputDescription}{\term{Output description}}
\newcommand{\outputDescriptions}{\terms{Output description}}
\newcommand{\OutputDescriptions}{\titleterms{Output Description}}
\newcommand{\outputTransfer}{\term{Output transfer}}
\newcommand{\outputTransfers}{\terms{Output transfer}}
\newcommand{\OutputTransfers}{\titleterms{Output Transfer}}
\newcommand{\outputCircuit}{\term{Output circuit}}
\newcommand{\outputStatement}{\term{Output statement}}
\newcommand{\outputStatements}{\terms{Output statement}}
\newcommand{\OutputStatement}{\titleterm{Output Statement}}
\newcommand{\outputProof}{\term{Output proof}}
\newcommand{\bindingSignature}{\term{binding signature}}
\newcommand{\bindingSignatures}{\terms{binding signature}}
\newcommand{\BindingSignature}{\titleterm{Binding Signature}}
\newcommand{\bindingSignatureScheme}{\term{binding signature scheme}}
\newcommand{\txBindingVerificationKey}{\term{transaction binding verification key}}
\newcommand{\balancingValue}{\term{balancing value}}
\newcommand{\shieldedOutput}{\term{shielded output}}
\newcommand{\shieldedOutputs}{\terms{shielded output}}
\newcommand{\statement}{\term{statement}}
\newcommand{\statements}{\terms{statement}}
\newcommand{\ZkSNARKStatements}{\titleterm{Zk-SNARK Statement}\notsprout{s}}
\newcommand{\zkProof}{\termandindex{zk proof}{zero-knowledge proof}}
\newcommand{\zeroKnowledgeProof}{\term{zero-knowledge proof}}
\newcommand{\zeroKnowledgeProofs}{\terms{zero-knowledge proof}}
\newcommand{\proofNonmalleability}{\termandindex{nonmalleability}{nonmalleability (of proofs)}}
\newcommand{\proofBatchEntries}{\termandindex{proof batch entries}{proof batch entry}}
\newcommand{\provingSystem}{\term{proving system}}
\newcommand{\provingSystems}{\terms{proving system}}
\newcommand{\zeroKnowledgeProvingSystem}{\term{zero-knowledge proving system}}
\newcommand{\ZeroKnowledgeProvingSystem}{\titleterm{Zero-Knowledge Proving System}}
\newcommand{\ZeroKnowledgeProvingSystems}{\titleterms{Zero-Knowledge Proving System}}
\newcommand{\quadraticConstraintProgram}{\term{quadratic constraint program}}
\newcommand{\quadraticConstraintPrograms}{\terms{quadratic constraint program}}
\newcommand{\QuadraticConstraintPrograms}{\titleterms{Quadratic Constraint Program}}
\newcommand{\quadraticArithmeticProgram}{\term{Quadratic Arithmetic Program}}
\newcommand{\quadraticArithmeticPrograms}{\terms{Quadratic Arithmetic Program}}
\newcommand{\linearCombination}{\term{linear combination}}
\newcommand{\linearCombinations}{\terms{linear combination}}
\newcommand{\representedGroup}{\term{represented group}}
\newcommand{\representedGroups}{\terms{represented group}}
\newcommand{\RepresentedGroup}{\titleterm{Represented Group}}
\newcommand{\representedSubgroup}{\term{represented subgroup}}
\newcommand{\representedSubgroups}{\terms{represented subgroup}}
\newcommand{\hashExtractor}{\term{hash extractor}}
\newcommand{\HashExtractor}{\titleterm{Hash Extractor}}
\newcommand{\groupHash}{\term{group hash}}
\newcommand{\groupHashes}{\termes{group hash}}
\newcommand{\familyOfGroupHashesIntoTheSubgroup}{\termandindex{family of group hashes into the subgroup}{family of group hashes into a subgroup}}
\newcommand{\representedPairing}{\term{represented pairing}}
\newcommand{\RepresentedPairing}{\titleterm{Represented Pairing}}
\newcommand{\RepresentedGroupsAndPairings}{\titleterms{Represented Groups and Pairing}}
\newcommand{\BCTV}{\mathsf{BCTV14}}
\newcommand{\Groth}{\mathsf{Groth16}}
\newcommand{\GrothText}{\texorpdfstring{$\Groth$}{Groth16}}
\newcommand{\EncodingOfBCTVProofs}{\titleterm{Encoding of BCTV14 Proofs}}
\newcommand{\EncodingOfGrothProofs}{\titleterm{Encoding of Groth16 Proofs}}
\newcommand{\BCTVProvingSystem}{\titleterm{BCTV14}}
\newcommand{\GrothProvingSystem}{\titleterm{Groth16}}
\newcommand{\BNCurve}{\mathsf{BN\mhyphen{}254}}
\newcommand{\BLSCurve}{\mathsf{BLS12\mhyphen{}381}}
\newcommand{\JubjubCurve}{\mathsf{Jubjub}}
\newcommand{\jubjubCurve}{\term{Jubjub curve}}
\newcommand{\Jubjub}{\titleterm{Jubjub}}
\newcommand{\completeTwistedEdwardsEllipticCurve}{\term{complete twisted Edwards elliptic curve}}
\newcommand{\completeTwistedEdwardsEllipticCurves}{\terms{complete twisted Edwards elliptic curve}}
\newcommand{\xCtEdwards}{\term{ctEdwards}}
\newcommand{\ctEdwardsCurve}{\termandindex{ctEdwards curve}{complete twisted Edwards elliptic curve}}
\newcommand{\ctEdwardsCurves}{\termandindex{ctEdwards curves}{complete twisted Edwards elliptic curve}}
\newcommand{\ctEdwardsCompressedEncoding}{\termandindex{ctEdwards compressed encoding}{complete twisted Edwards compressed encoding}}
\newcommand{\ctEdwardsCompressedEncodings}{\termandindex{ctEdwards compressed encodings}{complete twisted Edwards compressed encoding}}
\newcommand{\affineCtEdwards}{\termandindex{affine-ctEdwards}{complete twisted Edwards affine coordinates}}
\newcommand{\xAffineCtEdwards}{\termandindex{Affine-ctEdwards}{complete twisted Edwards affine coordinates}}
\newcommand{\AffineCtEdwards}{\titleterm{Affine-ctEdwards}}
\newcommand{\MontgomeryEllipticCurve}{\term{Montgomery elliptic curve}}
\newcommand{\MontgomeryEllipticCurves}{\terms{Montgomery elliptic curve}}
\newcommand{\MontgomeryCurve}{\termandindex{Montgomery curve}{Montgomery elliptic curve}}
\newcommand{\MontgomeryCurves}{\termandindex{Montgomery curves}{Montgomery elliptic curve}}
\newcommand{\affineMontgomery}{\termandindex{affine-Montgomery}{Montgomery affine coordinates}}
\newcommand{\xAffineMontgomery}{\termandindex{Affine-Montgomery}{Montgomery affine coordinates}}
\newcommand{\AffineMontgomery}{\titleterm{Affine-Montgomery}}
\newcommand{\uniformRandomString}{\term{Uniform Random String}}
\newcommand{\uniformRandomStrings}{\terms{Uniform Random String}}
\newcommand{\BNRepresentedPairing}{\titleterm{BN-254}}
\newcommand{\BLSRepresentedPairing}{\titleterm{BLS12-381}}
\newcommand{\ppzkSNARK}{\term{preprocessing zk-SNARK}}
\newcommand{\provingKey}{\term{proving key}}
\newcommand{\provingKeys}{\terms{proving key}}
\newcommand{\zkProvingKeys}{\terms{zero-knowledge proving key}}
\newcommand{\verifyingKey}{\term{verifying key}}
\newcommand{\verifyingKeys}{\terms{verifying key}}
\newcommand{\zkVerifyingKeys}{\terms{zero-knowledge verifying key}}
\newcommand{\joinSplitParameters}{\term{JoinSplit parameters}}
\newcommand{\BCTVZKParameters}{\titleterm{BCTV14 zk-SNARK Parameters}}
\newcommand{\GrothZKParameters}{\titleterm{Groth16 zk-SNARK Parameters}}
\newcommand{\rankOneConstraintSystem}{\term{Rank 1 Constraint System}}
\newcommand{\primary}{\termandindex{primary}{primary input}}
\newcommand{\primaryInput}{\term{primary input}}
\newcommand{\primaryInputs}{\terms{primary input}}
\newcommand{\auxiliaryInput}{\term{auxiliary input}}
\newcommand{\auxiliaryInputs}{\terms{auxiliary input}}
\newcommand{\fullValidator}{\term{full validator}}
\newcommand{\fullValidators}{\terms{full validator}}
\newcommand{\consensusRuleChange}{\term{consensus rule change}}
\newcommand{\networkUpgrade}{\term{network upgrade}}
\newcommand{\anchor}{\term{anchor}}
\newcommand{\anchors}{\terms{anchor}}
\newcommand{\block}{\term{block}}
\newcommand{\blocks}{\terms{block}}
\newcommand{\header}{\term{header}}
\newcommand{\headers}{\terms{header}}
\newcommand{\blockHeader}{\term{block header}}
\newcommand{\blockHeaders}{\terms{block header}}
\newcommand{\Blockheader}{\termx{block header}}
\newcommand{\BlockHeader}{\titleterm{Block Header}}
\newcommand{\blockVersionNumber}{\term{block version number}}
\newcommand{\blockVersionNumbers}{\terms{block version number}}
\newcommand{\Blockversions}{\termandindex{Block versions}{block version number}}
\newcommand{\blockTargetSpacing}{\term{block target spacing}}
\newcommand{\blockTimestamp}{\term{block timestamp}}
\newcommand{\blockHeight}{\term{block height}}
\newcommand{\blockHeights}{\terms{block height}}
\newcommand{\activationHeight}{\term{activation block height}}
\newcommand{\activationHeights}{\terms{activation block height}}
\newcommand{\genesisBlock}{\term{genesis block}}
\newcommand{\medianTimePast}{\term{median-time-past}}
\newcommand{\transaction}{\term{transaction}}
\newcommand{\transactions}{\terms{transaction}}
\newcommand{\Transaction}{\titleterm{Transaction}}
\newcommand{\Transactions}{\titleterms{Transaction}}
\newcommand{\transactionFee}{\term{transaction fee}}
\newcommand{\transactionFees}{\terms{transaction fee}}
\newcommand{\transactionVersion}{\termandindex{transaction version}{transaction version number}}
\newcommand{\transactionVersionNumber}{\term{transaction version number}}
\newcommand{\transactionVersionNumbers}{\terms{transaction version number}}
\newcommand{\Transactionversion}{\termandindex{Transaction version}{transaction version number}}
\newcommand{\versionGroupID}{\term{version group ID}}
\newcommand{\consensusBranchID}{\term{consensus branch ID}}
\newcommand{\coinbaseTransaction}{\term{coinbase transaction}}
\newcommand{\coinbaseTransactions}{\terms{coinbase transaction}}
\newcommand{\CoinbaseTransactions}{\titleterms{Coinbase Transaction}}
\newcommand{\transparent}{\term{transparent}}
\newcommand{\xTransparent}{\termx{transparent}}
\newcommand{\Transparent}{\titleterm{Transparent}}
\newcommand{\transparentValuePool}{\term{transparent value pool}}
\newcommand{\transparentAddress}{\term{transparent address}}
\newcommand{\transparentAddresses}{\termes{transparent address}}
\newcommand{\xTransparentAddresses}{\termxes{transparent address}}
\newcommand{\TransparentAddresses}{\titletermes{Transparent Address}}
\newcommand{\transparentTransfers}{\terms{transparent transfer}}
\newcommand{\transparentInput}{\term{transparent input}}
\newcommand{\transparentInputs}{\terms{transparent input}}
\newcommand{\xTransparentInputs}{\termxs{transparent input}}
\newcommand{\transparentOutput}{\term{transparent output}}
\newcommand{\transparentOutputs}{\terms{transparent output}}
\newcommand{\xTransparentOutputs}{\termxs{transparent output}}
\newcommand{\saplingValuePool}{\termandindex{\Sapling value pool}{value pool (Sapling)}}
\newcommand{\shielded}{\term{shielded}}
\newcommand{\shieldedNote}{\term{shielded note}}
\newcommand{\shieldedNotes}{\terms{shielded note}}
\newcommand{\xShielded}{\termx{shielded}}
\newcommand{\Shielded}{\titleterm{Shielded}}
\newcommand{\blockchain}{\term{block chain}}
\newcommand{\blockchains}{\terms{block chain}}
\newcommand{\Blockchain}{\titleterm{Block Chain}}
\newcommand{\validBlockchain}{\term{valid block chain}}
\newcommand{\bestValidBlockchain}{\term{best valid block chain}}
\newcommand{\blockchainReorganization}{\term{block chain reorganization}}
\newcommand{\blockchainReorganizations}{\terms{block chain reorganization}}
\newcommand{\blockhainBranch}{\term{block chain branch}}
\newcommand{\blockchainBranches}{\termes{block chain branch}}
\newcommand{\mempool}{\term{mempool}}
\newcommand{\treestate}{\term{treestate}}
\newcommand{\treestates}{\terms{treestate}}
\newcommand{\nullifier}{\term{nullifier}}
\newcommand{\nullifiers}{\terms{nullifier}}
\newcommand{\xNullifier}{\termx{nullifier}}
\newcommand{\xNullifiers}{\termxs{nullifier}}
\newcommand{\Nullifier}{\titleterm{Nullifier}}
\newcommand{\Nullifiers}{\titleterms{Nullifier}}
\newcommand{\nullifierSet}{\term{nullifier set}}
\newcommand{\nullifierSets}{\terms{nullifier set}}
\newcommand{\NullifierSets}{\titleterms{Nullifier Set}}
\newcommand{\paymentAddress}{\term{shielded payment address}}
\newcommand{\paymentAddresses}{\termes{shielded payment address}}
\newcommand{\PaymentAddresses}{\titletermes{Shielded Payment Address}}
\newcommand{\diversifiedPaymentAddress}{\term{diversified payment address}}
\newcommand{\diversifiedPaymentAddresses}{\termes{diversified payment address}}
\newcommand{\defaultDiversifiedPaymentAddress}{\term{default diversified payment address}}
\newcommand{\diversifiedBase}{\term{diversified base}}
\newcommand{\diversifiedBases}{\terms{diversified base}}
\newcommand{\diversifier}{\term{diversifier}}
\newcommand{\diversifiers}{\terms{diversifier}}
\newcommand{\incomingViewingKey}{\term{incoming viewing key}}
\newcommand{\incomingViewingKeys}{\terms{incoming viewing key}}
\newcommand{\IncomingViewingKeys}{\titleterms{Incoming Viewing Key}}
\newcommand{\outgoingViewingKey}{\term{outgoing viewing key}}
\newcommand{\outgoingViewingKeys}{\terms{outgoing viewing key}}
\newcommand{\outgoingCipherKey}{\term{outgoing cipher key}}
\newcommand{\outgoingCipherKeys}{\terms{outgoing cipher key}}
\newcommand{\fullViewingKey}{\term{full viewing key}}
\newcommand{\fullViewingKeys}{\terms{full viewing key}}
\newcommand{\FullViewingKeys}{\titleterms{Full Viewing Key}}
\newcommand{\receivingKey}{\term{receiving key}}
\newcommand{\receivingKeys}{\terms{receiving key}}
\newcommand{\spendingKey}{\term{spending key}}
\newcommand{\spendingKeys}{\terms{spending key}}
\newcommand{\SpendingKeys}{\titleterms{Spending Key}}
\newcommand{\payingKey}{\term{paying key}}
\newcommand{\transmissionKey}{\term{transmission key}}
\newcommand{\transmissionKeys}{\terms{transmission key}}
\newcommand{\diversifiedTransmissionKey}{\term{diversified transmission key}}
\newcommand{\diversifiedTransmissionKeys}{\terms{diversified transmission key}}
\newcommand{\diversifiedTransmissionBase}{\term{diversified transmission base}}
\newcommand{\diversifiedTransmissionBases}{\terms{diversified transmission base}}
\newcommand{\authSigningKey}{\term{spend authorizing key}}
\newcommand{\authSigningKeys}{\terms{spend authorizing key}}
\newcommand{\authRandomizedVerifyingKey}{\term{randomized spend verifying key}}
\newcommand{\authRandomizedVerifyingKeys}{\terms{randomized spend verifying key}}
\newcommand{\authProvingKey}{\term{proof authorizing key}}
\newcommand{\authProvingKeys}{\terms{proof authorizing key}}
\newcommand{\nullifierKey}{\term{nullifier deriving key}}
\newcommand{\nullifierKeys}{\terms{nullifier deriving key}}
\newcommand{\humanReadablePart}{\term{Human-Readable Part}}
\newcommand{\notePlaintext}{\term{note plaintext}}
\newcommand{\notePlaintexts}{\terms{note plaintext}}
\newcommand{\NotePlaintexts}{\titleterms{Note Plaintext}}
\newcommand{\noteCiphertext}{\termandindex{transmitted note ciphertext}{transmitted note(s) ciphertext}}
\newcommand{\noteCiphertexts}{\termandindex{transmitted note ciphertexts}{transmitted note(s) ciphertext}}
\newcommand{\notesCiphertext}{\termandindex{transmitted notes ciphertext}{transmitted note(s) ciphertext}}
\newcommand{\noteOrNotesCiphertext}{\term{transmitted note(s) ciphertext}}
\newcommand{\outputCiphertext}{\term{output ciphertext}}
\newcommand{\outputCiphertexts}{\terms{output ciphertext}}
\newcommand{\incrementalMerkleTree}{\term{incremental Merkle tree}}
\newcommand{\MerkleTree}{\titleterm{Merkle Tree}}
\newcommand{\merkleRoot}{\termandindex{root}{root (of a Merkle tree)}}
\newcommand{\merkleNode}{\termandindex{node}{node (of a Merkle tree)}}
\newcommand{\merkleNodes}{\termandindex{nodes}{node (of a Merkle tree)}}
\newcommand{\merkleHash}{\termandindex{hash value}{hash value (of a Merkle tree node)}}
\newcommand{\merkleHashes}{\termandindex{hash values}{hash value (of a Merkle tree node)}}
\newcommand{\merkleLeafNode}{\termandindex{leaf node}{leaf node (of a Merkle tree)}}
\newcommand{\merkleLeafNodes}{\termandindex{leaf nodes}{leaf node (of a Merkle tree)}}
\newcommand{\merkleInternalNode}{\termandindex{internal node}{internal node (of a Merkle tree)}}
\newcommand{\merkleInternalNodes}{\termandindex{internal nodes}{internal node (of a Merkle tree)}}
\newcommand{\MerkleInternalNodes}{\termandindex{Internal nodes}{internal node (of a Merkle tree)}}
\newcommand{\merklePath}{\term{Merkle path}}
\newcommand{\merkleLayer}{\termandindex{layer}{layer (of a Merkle tree)}}
\newcommand{\merkleLayers}{\termandindex{layers}{layer (of a Merkle tree)}}
\newcommand{\merkleIndex}{\termandindex{index}{index (of a Merkle tree node)}}
\newcommand{\merkleIndices}{\termandindex{indices}{index (of a Merkle tree node)}}
\newcommand{\zkSNARK}{\term{zk-SNARK}}
\newcommand{\zkSNARKs}{\terms{zk-SNARK}}
\newcommand{\zkSNARKProof}{\term{zk-SNARK proof}}
\newcommand{\zkSNARKProofs}{\terms{zk-SNARK proof}}
\newcommand{\zkSNARKCircuit}{\term{zk-SNARK circuit}}
\newcommand{\zkSNARKCircuits}{\terms{zk-SNARK circuit}}
\newcommand{\libsnark}{\termandindex{libsnark}{libsnark (Zcash fork)}}
\newcommand{\bellman}{\term{bellman}}
\newcommand{\memo}{\term{memo field}}
\newcommand{\memos}{\terms{memo field}}
\newcommand{\Memos}{\titleterms{Memo Field}}
\newcommand{\keyAgreementScheme}{\term{key agreement scheme}}
\newcommand{\keyAgreementSchemes}{\terms{key agreement scheme}}
\newcommand{\keyDerivationFunction}{\term{Key Derivation Function}}
\newcommand{\keyDerivationFunctions}{\terms{Key Derivation Function}}
\newcommand{\KeyAgreement}{\titleterm{Key Agreement}}
\newcommand{\KeyDerivation}{\titleterm{Key Derivation}}
\newcommand{\KeyAgreementAndDerivation}{\titleterm{Key Agreement and Derivation}}
\newcommand{\hashFunction}{\term{hash function}}
\newcommand{\hashFunctions}{\terms{hash function}}
\newcommand{\HashFunction}{\titleterm{Hash Function}}
\newcommand{\HashFunctions}{\titleterms{Hash Function}}
\newcommand{\encryptionScheme}{\term{encryption scheme}}
\newcommand{\oneTime}{\termandindex{one-time}{one-time (authenticated symmetric encryption)}}
\newcommand{\symmetricEncryptionScheme}{\termandindex{authenticated one-time symmetric encryption scheme}{authenticated one-time symmetric encryption}}
\newcommand{\SymmetricEncryption}{\titleterm{Authenticated One-Time Symmetric Encryption}}
\newcommand{\signatureScheme}{\term{signature scheme}}
\newcommand{\signatureSchemes}{\terms{signature scheme}}
\newcommand{\oneTimeSignatureScheme}{\termandindex{one-time signature scheme}{one-time (signature scheme)}}
\newcommand{\rerandomizableSignatureScheme}{\termandindex{signature scheme with re\hyp randomizable keys}{signature scheme with re-randomizable keys}}
\newcommand{\keyMonomorphicSignatureScheme}{\term{signature scheme with key monomorphism}}
\newcommand{\sigNonmalleable}{\termandindex{nonmalleable}{nonmalleability (of signatures)}}
\newcommand{\sigBatchEntries}{\termandindex{signature batch entries}{signature batch entry}}
\newcommand{\xPRF}{\termandindex{PRF}{Pseudo Random Function}}
\newcommand{\xPRFs}{\termandindex{PRFs}{Pseudo Random Function}}
\newcommand{\pseudoRandomFunction}{\term{Pseudo Random Function}}
\newcommand{\pseudoRandomFunctions}{\terms{Pseudo Random Function}}
\newcommand{\PseudoRandomFunctions}{\titleterms{Pseudo Random Function}}
\newcommand{\pseudoRandomPermutation}{\term{Pseudo Random Permutation}}
\newcommand{\pseudoRandomGenerators}{\termnoindex{Pseudo Random Generators}} % only in history
\newcommand{\expandedSeed}{\term{expanded seed}}
\newcommand{\shaHashFunction}{\term{SHA-256 hash function}}
\newcommand{\shaCompress}{\termandindex{SHA-256 compression}{SHA-256 compression function}}
\newcommand{\shaCompressFunction}{\term{SHA-256 compression function}}
\newcommand{\BlakeTwo}{\titleterm{BLAKE2}}
\newcommand{\xPedersenHash}{\term{Pedersen hash}}
\newcommand{\xPedersenHashes}{\termes{Pedersen hash}}
\newcommand{\PedersenHashFunction}{\titleterm{Pedersen Hash Function}}
\newcommand{\xPedersenCommitment}{\term{Pedersen commitment}}
\newcommand{\xPedersenCommitments}{\terms{Pedersen commitment}}
\newcommand{\xPedersenValueCommitment}{\term{Pedersen value commitment}}
\newcommand{\xPedersenValueCommitments}{\terms{Pedersen value commitment}}
\newcommand{\windowedPedersenCommitment}{\term{windowed Pedersen commitment}}
\newcommand{\windowedPedersenCommitments}{\terms{windowed Pedersen commitment}}
\newcommand{\WindowedPedersenCommitment}{\titleterm{Windowed Pedersen Commitment}}
\newcommand{\homomorphicPedersenCommitment}{\term{homomorphic Pedersen commitment}}
\newcommand{\homomorphicPedersenCommitments}{\terms{homomorphic Pedersen commitment}}
\newcommand{\HomomorphicPedersenCommitment}{\titleterm{Homomorphic Pedersen Commitment}}
\newcommand{\distinctXCriterion}{\term{distinct-$x$ criterion}}
\newcommand{\Nary}{\mbox{$N$-ary}}

% Conventions

\newcommand{\bytes}[1]{\underline{\raisebox{-0.3ex}{}\smash{#1}}}
\newcommand{\zeros}[1]{[0]^{#1}}
\newcommand{\zerobytes}[1]{[\hexint{00}]^{#1}}
\newcommand{\ones}[1]{[1]^{#1}}
\newcommand{\bit}{\mathbb{B}}
\newcommand{\overlap}[2]{\rlap{#2}\hspace{#1}{#2}}
\newcommand{\plap}[2]{\rlap{\hphantom{#2}}{#1}}
\newcommand{\byte}{\mathbb{B}\kern -0.1em\raisebox{0.55ex}{\overlap{0.0001em}{\scalebox{0.7}{$\mathbb{Y}$}}}}
\newcommand{\Nat}{\mathbb{N}}
\newcommand{\PosInt}{\mathbb{N}^+}
\newcommand{\Int}{\mathbb{Z}}
\newcommand{\Rat}{\mathbb{Q}}
\newcommand{\GF}[1]{\mathbb{F}_{\!#1}}
\newcommand{\GFstar}[1]{\mathbb{F}^\ast_{#1}}
\newcommand{\typeexp}[2]{{#1}\vphantom{)}^{[{#2}]}}
\newcommand{\bitseq}[1]{\typeexp{\bit}{#1}}
\newcommand{\bitseqs}{\bitseq{\Nat}}
\newcommand{\byteseq}[1]{\typeexp{\byte}{#1}}
\newcommand{\byteseqs}{\byteseq{\Nat}}
\newcommand{\concatbits}{\mathsf{concat}_\bit}
\newcommand{\bconcat}{\mathop{\kern 0.05em||}}
\newcommand{\listcomp}[1]{\overlap{0.06em}{\ensuremath{[}}~{#1}~\overlap{0.06em}{\ensuremath{]}}}
\newcommand{\fun}[2]{{#1} \mapsto {#2}}
\newcommand{\exclusivefun}[3]{{#1} \mapsto_{\neq\kern 0.05em{#3}\!} {#2}}
\newcommand{\first}{\mathsf{first}}
\newcommand{\for}{\text{ for }}
\newcommand{\from}{\text{ from }}
\newcommand{\upto}{\text{ up to }}
\newcommand{\downto}{\text{ down to }}
\newcommand{\tand}{\text{ \;and\, }}
\newcommand{\tor}{\text{ \;or\, }}
\newcommand{\squash}{\!\!\!}
\newcommand{\caseif}{\squash\text{if }}
\newcommand{\caseotherwise}{\squash\text{otherwise}}
\newcommand{\sorted}{\mathsf{sorted}}
\newcommand{\length}{\mathsf{length}}
\newcommand{\truncate}[1]{\mathsf{truncate}_{#1}}
\newcommand{\mean}{\mathsf{mean}}
\newcommand{\median}{\mathsf{median}}
\newcommand{\bound}[2]{\mathsf{bound\,}_{#1}^{#2}}
\newcommand{\Lower}{\mathsf{lower}}
\newcommand{\Upper}{\mathsf{upper}}
\newcommand{\bitlength}{\mathsf{bitlength}}
\newcommand{\size}{\mathsf{size}}
\newcommand{\mantissa}{\mathsf{mantissa}}
\newcommand{\ToCompact}{\mathsf{ToCompact}}
\newcommand{\ToTarget}{\mathsf{ToTarget}}
\newcommand{\ToScalar}{\mathsf{ToScalar}}
\newcommand{\hexint}[1]{\mathtt{0x{#1}}}
\newcommand{\dontcare}{\kern -0.06em\raisebox{0.1ex}{\footnotesize{$\times$}}}
\newcommand{\ascii}[1]{\textbf{``\texttt{#1}''}}
\newcommand{\Justthebox}[2][-1.8ex]{\raisebox{#1}{\;\usebox{#2}\;}}
\newcommand{\setof}[1]{\{{#1}\}}
\newcommand{\bigsetof}[1]{\left\{{#1}\right\}}
\newcommand{\powerset}[1]{\raisebox{-0.28ex}{\scalebox{1.25}{$\mathscr{P}$}}\kern -0.2em\big(\strut{#1}\big)}
\newcommand{\barerange}[2]{{{#1}\,..\,{#2}}}
\newcommand{\range}[2]{\setof{\barerange{#1}{#2}}}
\newcommand{\bigrange}[2]{\bigsetof{\barerange{#1}{#2}}}
\newcommand{\rangenozero}[2]{\range{#1}{#2} \setminus \setof{0}}
\newcommand{\bigrangenozero}[2]{\bigrange{#1}{#2} \setminus \setof{0}}
\newcommand{\binaryrange}[1]{\range{0}{2^{#1}\!-\!1}}
\newcommand{\oneto}[1]{\mathrm{1}..{#1}}
\newcommand{\alln}{\oneto{n}}
\newcommand{\allm}{\oneto{m}}
\newcommand{\minimum}{\mathsf{min}}
\newcommand{\maximum}{\mathsf{max}}
\newcommand{\floor}[1]{\mathsf{floor}\!\left({#1}\right)}
\newcommand{\trunc}[1]{\mathsf{trunc}\!\left({#1}\right)}
\newcommand{\ceiling}[1]{\mathsf{ceiling}\kern-0.06em\left({#1}\right)}
\newcommand{\sceiling}[1]{\mathsf{ceiling}\left({#1}\right)}
\newcommand{\vop}[3]{\,\raisebox{0.29ex}{\scalebox{0.89}{$\smashoperator[r]{#3_{#1}^{#2}}$\,}}}
\newcommand{\sop}[3]{\!\scalebox{0.89}{$\scalebox{1.404}{$\strut#3$}_{#1}^{#2}$}}
\newcommand{\vsum}[2]{\vop{#1}{#2}{\sum}}
\newcommand{\ssum}[2]{\sop{#1}{#2}{\sum}}
\newcommand{\vproduct}[2]{\vop{#1}{#2}{\prod}}
\newcommand{\sproduct}[2]{\sop{#1}{#2}{\prod}}
\newcommand{\vxor}[2]{\vop{#1}{#2}{\bigoplus}}
\newcommand{\sxor}[2]{\sop{#1}{#2}{\bigoplus}}
\newcommand{\vcombsum}[2]{\vop{#1}{#2}{\biggercombplus}}
\newcommand{\scombsum}[2]{\sop{#1}{#2}{\bigcombplus}}
\newcommand{\vgrpsum}[2]{\vop{#1}{#2}{\biggergrpplus}}
\newcommand{\sgrpsum}[2]{\sop{#1}{#2}{\biggrpplus}}
\newcommand{\xor}{\oplus}
\newcommand{\biggercombplus}{\bigdiamondplus{4.6ex}}
\newcommand{\bigcombplus}{\bigdiamondplus{3.3ex}}
\newcommand{\combplus}{\bigdiamondplus{1.8ex}\,}
\newcommand{\subcombplus}{\bigdiamondplus{1.4ex}}
\newcommand{\combzero}{\Zero_{\subcombplus}}
\newcommand{\combminus}{\bigdiamondminus{1.8ex}\,}
\newcommand{\combneg}{\bigdiamondminus{1.8ex}}
\newcommand{\biggergrpplus}{\bigboxplus{4.6ex}}
\newcommand{\biggrpplus}{\bigboxplus{3.3ex}}
\newcommand{\grpplus}{\bigboxplus{1.8ex}\,}
\newcommand{\subgrpplus}{\bigboxplus{1.4ex}}
\newcommand{\grpzero}{\Zero_{\subgrpplus}}
\newcommand{\grpminus}{\bigboxminus{1.8ex}\,}
\newcommand{\grpneg}{\bigboxminus{1.8ex}}
\newcommand{\vartimes}{\bigvartimes{1.8ex}}
\newcommand{\band}{\binampersand}
\newcommand{\bor}{\lor}
\newcommand{\suband}{\raisebox{-0.6ex}{\kern-0.06em\scalebox{0.65}{$\binampersand$}}}
\newcommand{\bchoose}{\;\scalebox{1.2}[1]{\textsf{?}}\;}
\newcommand{\rotr}{\ggg}
\newcommand{\mult}{\cdot}
\newcommand{\smult}{\!\cdot\!}
\newcommand{\scalarmult}[2]{\boldsymbol{[}{#1}\boldsymbol{]}\,{#2}}
\newcommand{\Bigscalarmult}[2]{\Big[{#1}\Big]{#2}}
\newcommand{\Biggscalarmult}[2]{\Bigg[{#1}\Bigg]{#2}}
\newcommand{\rightarrowR}{\mathop{\clasp[-0.18em]{\raisebox{1.15ex}{\scriptsize R}}{$\,\rightarrow\,$}}}
\newcommand{\leftarrowR}{\mathop{\clasp[0.15em]{\raisebox{1.15ex}{\scriptsize R}}{$\,\leftarrow\,$}}}
\newcommand{\union}{\cup}
\newcommand{\intersection}{\cap}
\newcommand{\suchthat}{\,\vert\;}
\newcommand{\paramdot}{\bigcdot}
\newcommand{\lincomb}[1]{\left(\strut\kern-.025em{#1}\kern-0.04em\right)}
\newcommand{\constraint}[3]{\lincomb{#1}\hairspace \vartimes\hairspace \lincomb{#2}\hairspace =\hairspace \lincomb{#3}}
\newcommand{\lconstraint}[1]{\lincomb{#1}\hairspace \vartimes\mhspace{0.25em}}
\newcommand{\maybe}[1]{{#1} \union \setof{\bot}}
\newcommand{\Of}[1]{\!\left({#1}\right)\!}

% <https://tex.stackexchange.com/a/87423/78411>
\newcommand{\hexints}[1]{
  \def\nextitem{\def\nextitem{, }}
  \renewcommand*{\do}[1]{\nextitem\hexint{##1}}
  \docsvlist{#1}
}
\newcommand{\hexarray}[1]{[\,\hexints{#1}\,]}


% Hashes

\newcommand{\hSigCRH}{\mathsf{hSigCRH}}
\newcommand{\hSigLength}{\mathsf{\ell_{hSig}}}
\newcommand{\hSigType}{\bitseq{\hSigLength}}
\newcommand{\EquihashGen}[1]{\mathsf{EquihashGen}_{#1}}
\newcommand{\CRH}{\mathsf{CRH}}
\newcommand{\SHACompress}{\mathsf{SHA256Compress}}
\newcommand{\SHACompressBox}[1]{\SHACompress\left(\Justthebox{#1}\right)}
\newcommand{\SHAFull}{\mathsf{SHA\mhyphen256}}
\newcommand{\SHAFullBox}[1]{\SHAFull\left(\Justthebox{#1}\right)}
\newcommand{\BlakeTwoGeneric}{\mathsf{BLAKE2}}
\newcommand{\BlakeTwobGeneric}{\mathsf{BLAKE2b}}
\newcommand{\BlakeTwob}[1]{\mathsf{BLAKE2b\kern 0.05em\mhyphen{#1}}}
\newcommand{\BlakeTwobOf}[2]{\BlakeTwob{#1}\!\left({#2}\right)}
\newcommand{\BlakeTwosGeneric}{\mathsf{BLAKE2s}}
\newcommand{\BlakeTwos}[1]{\mathsf{BLAKE2s\kern 0.05em\mhyphen{#1}}}
\newcommand{\BlakeTwosOf}[2]{\BlakeTwos{#1}\!\left({#2}\right)}
\newcommand{\BlakeParamBlock}{\mathsf{PB}}
\newcommand{\BlakeIV}{\mathsf{IV}}
\newcommand{\CRHivk}{\mathsf{CRH^{\InViewingKey}}}
\newcommand{\CRHivkText}{\texorpdfstring{$\CRHivk$}{CRHivk}}
\newcommand{\CRHivkOutput}{\CRHivk\mathsf{.Output}}
\newcommand{\CRHivkBox}[1]{\CRHivk\!\left(\Justthebox{#1}\right)}
\newcommand{\DiversifyHash}{\mathsf{DiversifyHash}}
\newcommand{\DiversifyHashText}{\texorpdfstring{$\DiversifyHash$}{DiversifyHash}}
\newcommand{\DefaultDiversifier}{\mathsf{DefaultDiversifier}}
\newcommand{\CheckDiversifier}{\mathsf{CheckDiversifier}}
\newcommand{\NotUpMySleeve}{U}

\newcommand{\tx}{\mathsf{tx}}
\newcommand{\ReceivedSet}{\mathsf{ReceivedSet}}
\newcommand{\SpentSet}{\mathsf{SpentSet}}
\newcommand{\NullifierMap}{\mathsf{NullifierMap}}

% Key pairs

\newcommand{\PaymentAddress}{\mathsf{addr_{pk}}}
\newcommand{\DiversifiedPaymentAddress}{\mathsf{addr_{d}}}
\newcommand{\PaymentAddressLeadByte}{\hexint{16}}
\newcommand{\PaymentAddressSecondByte}{\hexint{9A}}
\newcommand{\InViewingKey}{\mathsf{ivk}}
\newcommand{\InViewingKeyLength}{\ell_{\InViewingKey}}
\newcommand{\InViewingKeyTypeSapling}{\binaryrange{\InViewingKeyLength}}
\newcommand{\InViewingKeyRepr}{{\InViewingKey\Repr}}
\newcommand{\InViewingKeyLeadByte}{\hexint{A8}}
\newcommand{\InViewingKeySecondByte}{\hexint{AB}}
\newcommand{\InViewingKeyThirdByte}{\hexint{D3}}
\newcommand{\SpendingKeyLeadByte}{\hexint{AB}}
\newcommand{\SpendingKeySecondByte}{\hexint{36}}
\newcommand{\PtoSHAddressLeadByte}{\hexint{1C}}
\newcommand{\PtoSHAddressSecondByte}{\hexint{BD}}
\newcommand{\PtoPKHAddressLeadByte}{\hexint{1C}}
\newcommand{\PtoPKHAddressSecondByte}{\hexint{B8}}
\newcommand{\PaymentAddressTestnetLeadByte}{\hexint{16}}
\newcommand{\PaymentAddressTestnetSecondByte}{\hexint{B6}}
\newcommand{\InViewingKeyTestnetLeadByte}{\hexint{A8}}
\newcommand{\InViewingKeyTestnetSecondByte}{\hexint{AC}}
\newcommand{\InViewingKeyTestnetThirdByte}{\hexint{0C}}
\newcommand{\SpendingKeyTestnetLeadByte}{\hexint{AC}}
\newcommand{\SpendingKeyTestnetSecondByte}{\hexint{08}}
\newcommand{\PtoSHAddressTestnetLeadByte}{\hexint{1C}}
\newcommand{\PtoSHAddressTestnetSecondByte}{\hexint{BA}}
\newcommand{\PtoPKHAddressTestnetLeadByte}{\hexint{1D}}
\newcommand{\PtoPKHAddressTestnetSecondByte}{\hexint{25}}
\newcommand{\NotePlaintextLeadByteSprout}{\hexint{00}}
\newcommand{\NotePlaintextLeadByteSapling}{\hexint{01}}
\newcommand{\AuthPublic}{\mathsf{a_{pk}}}
\newcommand{\AuthPrivate}{\mathsf{a_{sk}}}
\newcommand{\AuthPrivateSup}[1]{\mathsf{a^\mathrm{#1}_{sk}}}
\newcommand{\AuthPrivateLength}{\mathsf{\ell_{\AuthPrivate}}}
\newcommand{\AuthPublicOld}[1]{\mathsf{a^{old}_{pk,\mathnormal{#1}}}}
\newcommand{\AuthPrivateOld}[1]{\mathsf{a^{old}_{sk,\mathnormal{#1}}}}
\newcommand{\AuthEmphPublicOld}[1]{\mathsf{a^{old}_{\textsf{\textbf{pk}},\mathnormal{#1}}}}
\newcommand{\AuthPublicOldX}[1]{\mathsf{a^{old}_{pk,\mathrm{#1}}}}
\newcommand{\AuthPrivateOldX}[1]{\mathsf{a^{old}_{sk,\mathrm{#1}}}}
\newcommand{\AuthPublicNew}[1]{\mathsf{a^{new}_{pk,\mathnormal{#1}}}}
\newcommand{\AuthPrivateNew}[1]{\mathsf{a^{new}_{sk,\mathnormal{#1}}}}
\newcommand{\AddressPublicNew}[1]{\mathsf{addr^{new}_{pk,\mathnormal{#1}}}}
\newcommand{\ScalarLength}{\ell_{\mathsf{scalar}}}
\newcommand{\enc}{\mathsf{enc}}
\newcommand{\DHSecret}[1]{\mathsf{sharedSecret}_{#1}}
\newcommand{\EphemeralPublic}{\mathsf{epk}}
\newcommand{\Repr}{\star}
\newcommand{\MakeRepr}[2]{{#1}\rlap{\raisebox{-0.32ex}{$\Repr$}}\rule{0ex}{2.2ex}^{#2}}
\newcommand{\EphemeralPublicRepr}{{\EphemeralPublic\Repr}}
\newcommand{\EphemeralPrivate}{\mathsf{esk}}
\newcommand{\EphemeralPrivateRepr}{{\EphemeralPrivate\Repr}}
\newcommand{\EphemeralPrivateBytes}{\bytes{\EphemeralPrivate}}
\newcommand{\EphemeralPrivateBytesType}{\byteseq{32}}
\newcommand{\TransmitPublic}{\mathsf{pk_{enc}}}
\newcommand{\TransmitPublicSup}[1]{\mathsf{pk}^{#1}_\mathsf{enc}}
\newcommand{\TransmitPublicNew}[1]{\mathsf{pk^{new}_{\enc,\mathnormal{#1}}}}
\newcommand{\TransmitPrivate}{\mathsf{sk_{enc}}}
\newcommand{\TransmitPrivateSup}[1]{\mathsf{sk}^{#1}_\mathsf{enc}}
\newcommand{\TransmitBase}{\mathsf{g}}

% Sapling

\newcommand{\SpendingKey}{\mathsf{sk}}
\newcommand{\SpendingKeyLength}{\mathsf{\ell_{\SpendingKey}}}
\newcommand{\SpendingKeyType}{\bitseq{\SpendingKeyLength}}
\newcommand{\AuthSignPrivate}{\mathsf{ask}}
\newcommand{\AuthSignBase}{\mathcal{G}}
\newcommand{\AuthSignPublic}{\mathsf{ak}}
\newcommand{\AuthSignPublicRepr}{{\AuthSignPublic\Repr}}
\newcommand{\AuthSignRandomizedPublic}{\mathsf{rk}}
\newcommand{\AuthSignRandomizedPublicRepr}{{\AuthSignRandomizedPublic\Repr}}
\newcommand{\AuthSignRandomizedPrivate}{\mathsf{rsk}}
\newcommand{\AuthSignRandomizer}{\alpha}
\newcommand{\AuthSignRandomizerRepr}{{\AuthSignRandomizer\Repr}}
\newcommand{\AuthProvePrivate}{\mathsf{nsk}}
\newcommand{\AuthProvePrivateRepr}{{\AuthProvePrivate\Repr}}
\newcommand{\AuthProveBase}{\mathcal{H}}
\newcommand{\AuthProvePublic}{\mathsf{nk}}
\newcommand{\AuthProvePublicRepr}{{\AuthProvePublic\Repr}}
\newcommand{\OutViewingKey}{\mathsf{ovk}}
\newcommand{\OutViewingKeyLength}{\mathsf{\ell_{\OutViewingKey}}}
\newcommand{\OutViewingKeyType}{\byteseq{\OutViewingKeyLength/8}}
\newcommand{\OutCipherKey}{\mathsf{ock}}
\newcommand{\NotePosition}{\mathsf{pos}}
\newcommand{\NotePositionRepr}{{\NotePosition\Repr}}
\newcommand{\NotePositionBase}{\mathcal{J}}
\newcommand{\NotePositionTypeSprout}{\binaryrange{\MerkleDepthSprout}}
\newcommand{\NotePositionTypeSapling}{\binaryrange{\MerkleDepthSapling}}
\newcommand{\Diversifier}{\mathsf{d}}
\newcommand{\DiversifierLength}{\mathsf{\ell_{\Diversifier}}}
\newcommand{\DiversifierType}{\bitseq{\DiversifierLength}}
\newcommand{\DiversifiedTransmitBase}{\mathsf{g_d}}
\newcommand{\DiversifiedTransmitBaseRepr}{\mathsf{g\Repr_d}}
\newcommand{\DiversifiedTransmitBaseNew}{\mathsf{g^{new}_d}}
\newcommand{\DiversifiedTransmitPublic}{\mathsf{pk_d}}
\newcommand{\DiversifiedTransmitPublicRepr}{\mathsf{pk\Repr_d}}
\newcommand{\DiversifiedTransmitPublicNew}{\mathsf{pk^{new}_d}}
\newcommand{\vOldRepr}{\MakeRepr{\mathsf{v}}{\mathsf{old}}}

% PRFs

\newcommand{\PRF}[2]{\mathsf{{PRF}^{#2}_\mathnormal{#1}}}
\newcommand{\PRFaddr}[1]{\PRF{#1}{addr}}
\newcommand{\PRFexpand}[1]{\PRF{#1}{expand}}
\newcommand{\PRFock}[1]{\PRF{#1}{\OutCipherKey}}
\newcommand{\PRFnf}[1]{\PRF{#1}{\nf}}
\newcommand{\PRFsn}[1]{\PRF{#1}{sn}}
\newcommand{\PRFpk}[1]{\PRF{#1}{pk}}
\newcommand{\PRFrho}[1]{\PRF{#1}{\NoteAddressRand}}
\newcommand{\PRFnfSapling}[1]{\PRF{#1}{nf\kern-0.01em Sapling}}
\newcommand{\PRFvcgMASP}[1]{\PRF{}{vcg\kern-0.01em MASP}\left(#1\right)}
\newcommand{\PRFOutputLengthSprout}{\mathsf{\ell_{PRF\notsprout{Sprout}}}}
\newcommand{\PRFOutputSprout}{\bitseq{\PRFOutputLengthSprout}}
\newcommand{\PRFOutputLengthNfSapling}{\mathsf{\ell_{PRFnfSapling}}}
\newcommand{\PRFOutputNfSapling}{\bitseq{\PRFOutputLengthNfSapling}}
\newcommand{\PRFOutputLengthExpand}{\mathsf{\ell_{PRFexpand}}}
\newcommand{\PRFOutputExpand}{\byteseq{\PRFOutputLengthExpand/8}}
\newcommand{\PRFInputExpand}{\byteseqs}

% Commitments

\newcommand{\UncommittedSprout}{\optSprout{\mathsf{Uncommitted}}}
\newcommand{\UncommittedSapling}{\mathsf{Uncommitted^{Sapling}}}
\newcommand{\NoteCommitmentSprout}{\optSprout{\mathsf{NoteCommitment}}}
\newcommand{\NoteCommitmentSapling}{\mathsf{NoteCommitment^{Sapling}}}
\newcommand{\NoteCommitmentMASP}{\mathsf{NoteCommitment^{MASP}}}

\newcommand{\CommitAlg}{\mathsf{COMM}}
\newcommand{\Commit}[1]{\CommitAlg_{#1}}
\newcommand{\CommitTrapdoor}{\CommitAlg\mathsf{.Trapdoor}}
\newcommand{\CommitGenTrapdoor}{\CommitAlg\mathsf{.GenTrapdoor}}
\newcommand{\CommitInput}{\CommitAlg\mathsf{.Input}}
\newcommand{\CommitOutput}{\CommitAlg\mathsf{.Output}}
\newcommand{\NoteCommitSproutAlg}{\mathsf{\sprout{COMM}\notsprout{NoteCommit}}^{\mathsf{Sprout}}}
\newcommand{\NoteCommitSprout}[1]{\NoteCommitSproutAlg_{#1}}
\newcommand{\NoteCommitSproutTrapdoor}{\NoteCommitSproutAlg\mathsf{.Trapdoor}}
\newcommand{\NoteCommitSproutGenTrapdoor}{\NoteCommitSproutAlg\mathsf{.GenTrapdoor}}
\newcommand{\NoteCommitSproutInput}{\NoteCommitSproutAlg\mathsf{.Input}}
\newcommand{\NoteCommitSproutOutput}{\NoteCommitSproutAlg\mathsf{.Output}}
\newcommand{\NoteCommitSaplingAlg}{\mathsf{NoteCommit}^{\mathsf{Sapling}}}
\newcommand{\NoteCommitSapling}[1]{\NoteCommitSaplingAlg_{#1}}

\newcommand{\NoteCommitMASPAlg}{\mathsf{NoteCommit}^{\mathsf{MASP}}}
\newcommand{\NoteCommitMASP}[1]{\NoteCommitMASPAlg_{#1}}

\newcommand{\NoteCommitSaplingTrapdoor}{\NoteCommitSaplingAlg\mathsf{.Trapdoor}}
\newcommand{\NoteCommitSaplingTrapdoorBytes}{\byteseq{32}}
\newcommand{\NoteCommitSaplingGenTrapdoor}{\NoteCommitSaplingAlg\mathsf{.GenTrapdoor}}
\newcommand{\NoteCommitSaplingInput}{\NoteCommitSaplingAlg\mathsf{.Input}}
\newcommand{\NoteCommitSaplingOutput}{\NoteCommitSaplingAlg\mathsf{.Output}}
\newcommand{\ValueCommitAlg}{\mathsf{ValueCommit}}
\newcommand{\ValueCommit}[1]{\ValueCommitAlg_{#1}}
\newcommand{\ValueCommitTrapdoor}{\ValueCommitAlg\mathsf{.Trapdoor}}
\newcommand{\ValueCommitGenTrapdoor}{\ValueCommitAlg\mathsf{.GenTrapdoor}}
\newcommand{\ValueCommitInput}{\ValueCommitAlg\mathsf{.Input}}
\newcommand{\ValueCommitOutput}{\ValueCommitAlg\mathsf{.Output}}
\newcommand{\ValueCommitValueBase}{\mathcal{V}}
\newcommand{\ValueCommitRandBase}{\mathcal{R}}

% Symmetric encryption

\newcommand{\Sym}{\mathsf{Sym}}
\newcommand{\SymEncrypt}[1]{\Sym\mathsf{.Encrypt}_{#1}}
\newcommand{\SymDecrypt}[1]{\Sym\mathsf{.Decrypt}_{#1}}
\newcommand{\SymSpecific}{\mathsf{AEAD\_CHACHA20\_POLY1305}}
\newcommand{\SymCipher}{\mathsf{ChaCha20}}
\newcommand{\SymAuth}{\mathsf{Poly1305}}
\newcommand{\Ptext}{\mathsf{P}}
\newcommand{\Plaintext}{\mathsf{Sym.}\mathbf{P}}
\newcommand{\Ctext}{\mathsf{C}}
\newcommand{\Ciphertext}{\mathsf{Sym.}\mathbf{C}}
\newcommand{\Key}{\mathsf{K}}
\newcommand{\Keyspace}{\mathsf{Sym.}\mathbf{K}}
\newcommand{\TransmitPlaintext}[1]{\Ptext^\enc_{#1}}
\newcommand{\TransmitCiphertext}[1]{\Ctext^\enc_{#1}}
\newcommand{\TransmitKey}[1]{\Key^\enc_{#1}}
\newcommand{\OutCiphertext}{\Ctext^\mathsf{out}}
\newcommand{\Extractor}[1]{\mathcal{E}_{\kern-0.05em{#1}}}
\newcommand{\Adversary}{\mathcal{A}}
\newcommand{\Oracle}{\mathsf{O}}
\newcommand{\CryptoBoxSeal}{\mathsf{crypto\_box\_seal}}

% Key agreement

\newcommand{\KA}{\mathsf{KA}}
\newcommand{\KAPublic}{\KA\mathsf{.Public}}
\newcommand{\KAPublicPrimeOrder}{\KA\mathsf{.PublicPrimeOrder}}
\newcommand{\KAPrivate}{\KA\mathsf{.Private}}
\newcommand{\KASharedSecret}{\KA\mathsf{.SharedSecret}}
\newcommand{\KAFormatPrivate}{\KA\mathsf{.FormatPrivate}}
\newcommand{\KADerivePublic}{\KA\mathsf{.DerivePublic}}
\newcommand{\KAAgree}{\KA\mathsf{.Agree}}
\newcommand{\KABase}{\KA\mathsf{.Base}}

\newcommand{\KASprout}{\mathsf{\optSprout{KA}}}
\newcommand{\KASproutPublic}{\KASprout\mathsf{.Public}}
\newcommand{\KASproutPrivate}{\KASprout\mathsf{.Private}}
\newcommand{\KASproutSharedSecret}{\KASprout\mathsf{.SharedSecret}}
\newcommand{\KASproutFormatPrivate}{\KASprout\mathsf{.FormatPrivate}}
\newcommand{\KASproutDerivePublic}{\KASprout\mathsf{.DerivePublic}}
\newcommand{\KASproutAgree}{\KASprout\mathsf{.Agree}}
\newcommand{\KASproutBase}{\KASprout\mathsf{.Base}}

\newcommand{\KASproutCurve}{\mathsf{Curve25519}}
\newcommand{\KASproutCurveMultiply}{\mathsf{Curve25519}}
\newcommand{\KASproutCurveBase}{\bytes{9}}
\newcommand{\KASproutCurveClamp}{\mathsf{clamp_{Curve25519}}}

\newcommand{\KASapling}{\mathsf{KA^{Sapling}}}
\newcommand{\KASaplingPublic}{\KASapling\mathsf{.Public}}
\newcommand{\KASaplingPublicPrimeOrder}{\KASapling\mathsf{.PublicPrimeOrder}}
\newcommand{\KASaplingPrivate}{\KASapling\mathsf{.Private}}
\newcommand{\KASaplingSharedSecret}{\KASapling\mathsf{.SharedSecret}}
\newcommand{\KASaplingDerivePublic}{\KASapling\mathsf{.DerivePublic}}
\newcommand{\KASaplingAgree}{\KASapling\mathsf{.Agree}}

% KDF

\newcommand{\KDF}{\mathsf{KDF}}
\newcommand{\KDFSprout}{\optSprout{\KDF}}
\newcommand{\KDFSapling}{\mathsf{KDF^{Sapling}}}
\newcommand{\kdftag}{\mathsf{kdftag}}
\newcommand{\kdfinput}{\mathsf{kdfinput}}

% Notes

\newcommand{\Value}{\mathsf{v}}
\newcommand{\ValueNew}[1]{\Value^\mathsf{new}_{#1}}
\newcommand{\ValueOld}[1]{\Value^\mathsf{old}_{#1}}
\newcommand{\ValueLength}{\ell_{\mathsf{value}}}
\newcommand{\ValueType}{\binaryrange{\ValueLength}}
\newcommand{\ValueCommitType}{\bigrange{-\SignedScalarLimitJ}{\SignedScalarLimitJ}}
\newcommand{\ValueCommitRand}{\mathsf{rcv}}
\newcommand{\ValueCommitRandRepr}{{\ValueCommitRand\Repr}}
\newcommand{\ValueCommitRandLength}{\mathsf{\ell_{\ValueCommitRand}}}
\newcommand{\ValueCommitRandOld}[1]{\ValueCommitRand^\mathsf{old}_{#1}}
\newcommand{\ValueCommitRandNew}[1]{\ValueCommitRand^\mathsf{new}_{#1}}
\newcommand{\NoteTuple}[1]{\mathbf{n}_{#1}}
\newcommand{\NoteTypeSprout}{\optSprout{\mathsf{Note}}}
\newcommand{\NoteTypeSapling}{\mathsf{Note^{Sapling}}}
\newcommand{\NoteTypeMASP}{\mathsf{Note^{MASP}}}
\newcommand{\NoteToken}{\mathsf{t}}
\newcommand{\NoteValueBase}{\mathsf{vb}}
\newcommand{\NoteTokenLength}{\mathsf{\ell_{\NoteToken}}}
\newcommand{\NoteTokenType}{\bitseq{\NoteTokenLength}}
\newcommand{\NotePlaintext}[1]{\mathbf{np}_{#1}}
\newcommand{\OutPlaintext}{\mathbf{op}}
\newcommand{\NoteCommitRand}{\mathsf{\sprout{r}\notsprout{rcm}}}
\newcommand{\NoteCommitRandRepr}{{\NoteCommitRand\Repr}}
\newcommand{\NoteCommitRandBytes}{\bytes{\NoteCommitRand}}
\newcommand{\NoteCommitRandBytesType}{\byteseq{32}}
\newcommand{\NoteCommitRandLength}{\mathsf{\ell_{\NoteCommitRand}}}
\newcommand{\NoteCommitRandOld}[1]{\NoteCommitRand^\mathsf{old}_{#1}}
\newcommand{\NoteCommitRandNew}[1]{\NoteCommitRand^\mathsf{new}_{#1}}
\newcommand{\NoteAddressRand}{\mathsf{\uprho}}
\newcommand{\NoteAddressRandRepr}{{\NoteAddressRand\Repr}}
\newcommand{\NoteAddressRandOld}[1]{\NoteAddressRand^\mathsf{old}_{#1}}
\newcommand{\NoteAddressRandNew}[1]{\NoteAddressRand^\mathsf{new}_{#1}}
\newcommand{\NoteAddressPreRand}{\mathsf{\upvarphi}}
\newcommand{\NoteAddressPreRandLength}{\mathsf{\ell_{\NoteAddressPreRand}}}
\newcommand{\NoteCommitS}{\mathsf{s}}
\newcommand{\cv}{\mathsf{cv}}
\newcommand{\cvOld}[1]{\cv^\mathsf{old}_{#1}}
\newcommand{\cvNew}[1]{\cv^\mathsf{new}_{#1}}
\newcommand{\cm}{\mathsf{cm}}
\newcommand{\cmU}{\cm_{\kern -0.06em u}}
\newcommand{\cmOld}[1]{\cm^\mathsf{old}_{#1}}
\newcommand{\cmNew}[1]{\cm^\mathsf{new}_{#1}}
\newcommand{\snOld}[1]{\mathsf{sn}^\mathsf{old}_{#1}}
\newcommand{\nf}{\mathsf{nf}}
\newcommand{\nfOld}[1]{\nf^\mathsf{old}_{#1}}
\newcommand{\Memo}{\mathsf{memo}}
\newcommand{\MemoByteLength}{512}
\newcommand{\MemoType}{\byteseq{\MemoByteLength}}
\newcommand{\DecryptNoteSprout}{\mathtt{DecryptNote\notsprout{Sprout}}}
\newcommand{\DecryptNoteSapling}{\mathtt{DecryptNoteSapling}}
\newcommand{\ReplacementCharacter}{\textsf{U+FFFD}}

% Money supply

\newcommand{\MAXMONEY}{\mathsf{MAX\_MONEY}}
\newcommand{\BlockSubsidy}{\mathsf{BlockSubsidy}}
\newcommand{\MinerSubsidy}{\mathsf{MinerSubsidy}}
\newcommand{\FoundersReward}{\mathsf{FoundersReward}}
\newcommand{\SlowStartInterval}{\mathsf{SlowStartInterval}}
\newcommand{\SlowStartShift}{\mathsf{SlowStartShift}}
\newcommand{\SlowStartRate}{\mathsf{SlowStartRate}}
\newcommand{\PreBlossomHalvingInterval}{\mathsf{\notbeforeblossom{PreBlossom}HalvingInterval}}
\newcommand{\PostBlossomHalvingInterval}{\mathsf{PostBlossomHalvingInterval}}
\newcommand{\MaxBlockSubsidy}{\mathsf{MaxBlockSubsidy}}
\newcommand{\NumFounderAddresses}{\mathsf{NumFounderAddresses}}
\newcommand{\FounderAddressChangeInterval}{\mathsf{FounderAddressChangeInterval}}
\newcommand{\FoundersFraction}{\mathsf{FoundersFraction}}
\newcommand{\BlockHeight}{\mathsf{height}}
\newcommand{\FounderAddressAdjustedHeight}{\mathsf{FounderAddressAdjustedHeight}}
\newcommand{\FoundersRewardLastBlockHeight}{\mathsf{FoundersRewardLastBlockHeight}}
\newcommand{\Halving}{\mathsf{Halving}}
\newcommand{\FounderAddress}{\mathsf{FounderAddress}}
\newcommand{\FounderAddressList}{\mathsf{FounderAddressList}}
\newcommand{\FounderAddressIndex}{\mathsf{FounderAddressIndex}}
\newcommand{\RedeemScriptHash}{\mathsf{RedeemScriptHash}}

\newcommand{\blockSubsidy}{\term{block subsidy}}
\newcommand{\minerSubsidy}{\term{miner subsidy}}
\newcommand{\foundersReward}{\term{Founders' Reward}}
\newcommand{\FoundersRewardText}{\titleterm{Founders' Reward}}
\newcommand{\slowStartPeriod}{\term{slow-start period}}
\newcommand{\halvingInterval}{\term{halving interval}}
\newcommand{\utxoSet}{\term{unspent transaction output set}}
\newcommand{\fundingStream}{\term{funding stream}}

\newcommand{\BlossomActivationHeight}{\mathsf{BlossomActivationHeight}}
\newcommand{\IsBlossomActivated}{\mathsf{IsBlossomActivated}}
\newcommand{\PoWLimit}{\mathsf{PoWLimit}}
\newcommand{\PoWAveragingWindow}{\mathsf{PoWAveragingWindow}}
\newcommand{\PoWMedianBlockSpan}{\mathsf{PoWMedianBlockSpan}}
\newcommand{\PoWMaxAdjustDown}{\mathsf{PoWMaxAdjustDown}}
\newcommand{\PoWMaxAdjustUp}{\mathsf{PoWMaxAdjustUp}}
\newcommand{\PoWDampingFactor}{\mathsf{PoWDampingFactor}}
\newcommand{\PreBlossomPoWTargetSpacing}{\mathsf{\notbeforeblossom{PreBlossom}PoWTargetSpacing}}
\newcommand{\PostBlossomPoWTargetSpacing}{\mathsf{PostBlossomPoWTargetSpacing}}
\newcommand{\BlossomPoWTargetSpacingRatio}{\mathsf{BlossomPoWTargetSpacingRatio}}
\newcommand{\PoWTargetSpacingFunc}{\mathsf{PoWTargetSpacing}}
\newcommand{\MeanTarget}{\mathsf{MeanTarget}}
\newcommand{\MedianTime}{\mathsf{MedianTime}}
\newcommand{\AveragingWindowTimespan}{\mathsf{AveragingWindowTimespan}}
\newcommand{\MinActualTimespan}{\mathsf{MinActualTimespan}}
\newcommand{\MaxActualTimespan}{\mathsf{MaxActualTimespan}}
\newcommand{\ActualTimespan}{\mathsf{ActualTimespan}}
\newcommand{\ActualTimespanDamped}{\mathsf{ActualTimespanDamped}}
\newcommand{\ActualTimespanBounded}{\mathsf{ActualTimespanBounded}}
\newcommand{\Threshold}{\mathsf{Threshold}}
\newcommand{\ThresholdBits}{\mathsf{ThresholdBits}}

\newcommand{\targetThreshold}{\term{target threshold}}
\newcommand{\targetThresholds}{\terms{target threshold}}

% Signatures

\newcommand{\Sig}{\mathsf{Sig}}
\newcommand{\SigPublic}{\Sig\mathsf{.Public}}
\newcommand{\SigPrivate}{\Sig\mathsf{.Private}}
\newcommand{\SigMessage}{\Sig\mathsf{.Message}}
\newcommand{\SigSignature}{\Sig\mathsf{.Signature}}
\newcommand{\SigGenPrivate}{\Sig\mathsf{.GenPrivate}}
\newcommand{\SigGen}{\Sig\mathsf{.Gen}}
\newcommand{\SigDerivePublic}{\Sig\mathsf{.DerivePublic}}
\newcommand{\SigSign}[1]{\Sig\mathsf{.Sign}_{#1}}
\newcommand{\SigVerify}[1]{\Sig\mathsf{.Verify}_{#1}}
\newcommand{\SigRandom}{\Sig\mathsf{.Random}}
\newcommand{\SigGenRandom}{\Sig\mathsf{.GenRandom}}
\newcommand{\SigRandomizePublic}{\Sig\mathsf{.RandomizePublic}}
\newcommand{\SigRandomizePrivate}{\Sig\mathsf{.RandomizePrivate}}
\newcommand{\SigRandomizerId}{\Zero_{\SigRandom}}
\newcommand{\SigRandomizer}{\alpha}

\newcommand{\EdDSA}{\mathsf{EdDSA}}
\newcommand{\EdDSAReprR}{\bytes{R}}
\newcommand{\EdDSAReprS}{\bytes{S}}

\newcommand{\RedDSA}{\mathsf{RedDSA}}
\newcommand{\RedDSAPublic}{\RedDSA\mathsf{.Public}}
\newcommand{\RedDSAPrivate}{\RedDSA\mathsf{.Private}}
\newcommand{\RedDSAMessage}{\RedDSA\mathsf{.Message}}
\newcommand{\RedDSASignature}{\RedDSA\mathsf{.Signature}}
\newcommand{\RedDSAGenPrivate}{\RedDSA\mathsf{.GenPrivate}}
\newcommand{\RedDSADerivePublic}{\RedDSA\mathsf{.DerivePublic}}
\newcommand{\RedDSASign}[1]{\RedDSA\mathsf{.Sign}_{#1}}
\newcommand{\RedDSAVerify}[1]{\RedDSA\mathsf{.Verify}_{#1}}
\newcommand{\RedDSABatchVerify}{\RedDSA\mathsf{.BatchVerify}}
\newcommand{\RedDSABatchEntry}{\RedDSA\mathsf{.BatchEntry}}
\newcommand{\RedDSARandom}{\RedDSA\mathsf{.Random}}
\newcommand{\RedDSAGenRandom}{\RedDSA\mathsf{.GenRandom}}
\newcommand{\RedDSARandomizePublic}{\RedDSA\mathsf{.RandomizePublic}}
\newcommand{\RedDSARandomizePrivate}{\RedDSA\mathsf{.RandomizePrivate}}
\newcommand{\RedDSARandomizerId}{\Zero_{\RedDSARandom}}
\newcommand{\RedDSARandomizer}{\alpha}
\newcommand{\RedDSASigR}[1]{R_{#1}}
\newcommand{\RedDSASigS}[1]{S_{#1}}
\newcommand{\RedDSAReprR}[1]{\bytes{\RedDSASigR{#1}}}
\newcommand{\RedDSAReprS}[1]{\bytes{\RedDSASigS{#1}}}
\newcommand{\RedDSASigc}[1]{c_{#1}}
\newcommand{\RedDSAHash}{\mathsf{H}}
\newcommand{\RedDSAHashToScalar}{\RedDSAHash^{\circledast}}
\newcommand{\RedDSAHashLength}{\ell_{\RedDSAHash}}
\newcommand{\Entry}[1]{\mathsf{entry}_{#1}}

\newcommand{\RedJubjub}{\mathsf{RedJubjub}}
\newcommand{\RedDSAText}{\texorpdfstring{$\RedDSA$}{RedDSA}}
\newcommand{\RedDSAAndRedJubjub}{\texorpdfstring{$\RedDSA$ and $\RedJubjub$}{RedDSA and RedJubjub}}
\newcommand{\RedJubjubHashName}{\BlakeTwob{512}}

\newcommand{\JoinSplitSig}{\mathsf{JoinSplitSig}}
\newcommand{\JoinSplitSigPublic}{\JoinSplitSig\mathsf{.Public}}
\newcommand{\JoinSplitSigPrivate}{\JoinSplitSig\mathsf{.Private}}
\newcommand{\JoinSplitSigMessage}{\JoinSplitSig\mathsf{.Message}}
\newcommand{\JoinSplitSigSignature}{\JoinSplitSig\mathsf{.Signature}}
\newcommand{\JoinSplitSigGenPrivate}{\JoinSplitSig\mathsf{.GenPrivate}}
\newcommand{\JoinSplitSigDerivePublic}{\JoinSplitSig\mathsf{.DerivePublic}}
\newcommand{\JoinSplitSigSign}[1]{\JoinSplitSig\mathsf{.Sign}_{#1}}
\newcommand{\JoinSplitSigVerify}[1]{\JoinSplitSig\mathsf{.Verify}_{#1}}
\newcommand{\JoinSplitSigSpecific}{\mathsf{Ed25519}}
\newcommand{\JoinSplitSigHashName}{\mathsf{SHA\mhyphen512}}
\newcommand{\ExcludedPointEncodings}{\mathsf{ExcludedPointEncodings}}

\newcommand{\SpendAuthSig}{\mathsf{SpendAuthSig}}
\newcommand{\SpendAuthSigPublic}{\SpendAuthSig\mathsf{.Public}}
\newcommand{\SpendAuthSigPrivate}{\SpendAuthSig\mathsf{.Private}}
\newcommand{\SpendAuthSigMessage}{\SpendAuthSig\mathsf{.Message}}
\newcommand{\SpendAuthSigSignature}{\SpendAuthSig\mathsf{.Signature}}
\newcommand{\SpendAuthSigGenPrivate}{\SpendAuthSig\mathsf{.GenPrivate}}
\newcommand{\SpendAuthSigDerivePublic}{\SpendAuthSig\mathsf{.DerivePublic}}
\newcommand{\SpendAuthSigSign}[1]{\SpendAuthSig\mathsf{.Sign}_{#1}}
\newcommand{\SpendAuthSigVerify}[1]{\SpendAuthSig\mathsf{.Verify}_{#1}}
\newcommand{\SpendAuthSigRandom}{\SpendAuthSig\mathsf{.Random}}
\newcommand{\SpendAuthSigGenRandom}{\SpendAuthSig\mathsf{.GenRandom}}
\newcommand{\SpendAuthSigRandomizePublic}{\SpendAuthSig\mathsf{.RandomizePublic}}
\newcommand{\SpendAuthSigRandomizePrivate}{\SpendAuthSig\mathsf{.RandomizePrivate}}
\newcommand{\SpendAuthSigRandomizerId}{\SpendAuthSig\mathsf{.Id}}
\newcommand{\SpendAuthSigRandomizer}{\alpha}
\newcommand{\SpendAuthSigSpecific}{\mathsf{RedJubjub}}

\newcommand{\BindingSig}{\mathsf{BindingSig}}
\newcommand{\BindingSigPublic}{\BindingSig\mathsf{.Public}}
\newcommand{\BindingSigPrivate}{\BindingSig\mathsf{.Private}}
\newcommand{\BindingSigMessage}{\BindingSig\mathsf{.Message}}
\newcommand{\BindingSigSignature}{\BindingSig\mathsf{.Signature}}
\newcommand{\BindingSigGenPrivate}{\BindingSig\mathsf{.GenPrivate}}
\newcommand{\BindingSigDerivePublic}{\BindingSig\mathsf{.DerivePublic}}
\newcommand{\BindingSigSign}[1]{\BindingSig\mathsf{.Sign}_{#1}}
\newcommand{\BindingSigVerify}[1]{\BindingSig\mathsf{.Verify}_{#1}}
\newcommand{\BindingSigSpecific}{\mathsf{RedJubjub}}
\newcommand{\BindingPublic}{\mathsf{bvk}}
\newcommand{\BindingPrivate}{\mathsf{bsk}}

\newcommand{\RandomSeedLength}{\mathsf{\ell_{Seed}}}
\newcommand{\RandomSeedType}{\bitseq{\mathsf{\ell_{Seed}}}}
\newcommand{\pksig}{\mathsf{pk_{sig}}}
\newcommand{\sk}{\mathsf{sk}}
\newcommand{\hSigInput}{\mathsf{hSigInput}}
\newcommand{\crhInput}{\mathsf{crhInput}}
\newcommand{\ockInput}{\mathsf{ockInput}}
\newcommand{\dataToBeSigned}{\mathsf{dataToBeSigned}}
\newcommand{\vBalance}{\mathsf{v^{balance}}}
\newcommand{\vBad}{\mathsf{v^{bad}}}
\newcommand{\vSum}{\mathsf{v^{*}}}
\newcommand{\OracleNewAddress}{\Oracle^{\mathsf{NewAddress}}}
\newcommand{\OracleDH}{\Oracle^{\mathsf{DH}}}

% Merkle tree

\newcommand{\MerkleDepth}{\mathsf{MerkleDepth}}
\newcommand{\MerkleDepthSprout}{\optSprout{\MerkleDepth}}
\newcommand{\MerkleDepthSapling}{\MerkleDepth^\mathsf{Sapling}}
\newcommand{\MerkleDepthSproutOrSapling}{\MerkleDepth^\mathsf{Sprout\sapling{,Sapling}}}
\newcommand{\MerkleNode}[2]{\mathsf{M}^{#1}_{#2}}
\newcommand{\MerkleSibling}{\mathsf{sibling}}
\newcommand{\MerkleCRH}{\mathsf{MerkleCRH}}
\newcommand{\MerkleCRHSprout}{\optSprout{\MerkleCRH}}
\newcommand{\MerkleCRHSapling}{\MerkleCRH^\mathsf{Sapling}}
\newcommand{\MerkleHashLength}{\mathsf{\ell_{Merkle}}}
\newcommand{\MerkleHashLengthSprout}{\mathsf{\ell_{\sprout{Merkle}\notsprout{MerkleSprout}}}}
\newcommand{\MerkleHashLengthSapling}{\mathsf{\ell_{MerkleSapling}}}
\newcommand{\MerkleHash}{\bitseq{\MerkleHashLength}}
\newcommand{\MerkleHashSprout}{\bitseq{\MerkleHashLengthSprout}}
\newcommand{\MerkleHashSapling}{\bitseq{\MerkleHashLengthSapling}}
\newcommand{\MerkleLayer}{\range{0}{\MerkleDepth-1}}
\newcommand{\MerkleLayerSprout}{\range{0}{\MerkleDepthSprout-1}}
\newcommand{\MerkleLayerSapling}{\range{0}{\MerkleDepthSapling-1}}

% Transactions

\newcommand{\headerField}{\mathtt{header}}
\newcommand{\fOverwintered}{\mathtt{fOverwintered}}
\newcommand{\versionField}{\mathtt{version}}
\newcommand{\nVersionGroupId}{\mathtt{nVersionGroupId}}
\newcommand{\txInCount}{\mathtt{tx\_in\_count}}
\newcommand{\txIn}{\mathtt{tx\_in}}
\newcommand{\txOutCount}{\mathtt{tx\_out\_count}}
\newcommand{\txOut}{\mathtt{tx\_out}}
\newcommand{\lockTime}{\mathtt{lock\_time}}
\newcommand{\nExpiryHeight}{\mathtt{nExpiryHeight}}
\newcommand{\valueBalance}{\mathtt{valueBalance}}
\newcommand{\nShieldedSpend}{\mathtt{nShieldedSpend}}
\newcommand{\vShieldedSpend}{\mathtt{vShieldedSpend}}
\newcommand{\nShieldedOutput}{\mathtt{nShieldedOutput}}
\newcommand{\vShieldedOutput}{\mathtt{vShieldedOutput}}
\newcommand{\nJoinSplit}{\mathtt{nJoinSplit}}
\newcommand{\vJoinSplit}{\mathtt{vJoinSplit}}
\newcommand{\vpubOldField}{\mathtt{vpub\_old}}
\newcommand{\vpubNewField}{\mathtt{vpub\_new}}
\newcommand{\anchorField}{\mathtt{anchor}}
\newcommand{\joinSplitSig}{\mathtt{joinSplitSig}}
\newcommand{\joinSplitPrivKey}{\mathtt{joinSplitPrivKey}}
\newcommand{\joinSplitPubKey}{\mathtt{joinSplitPubKey}}
\newcommand{\bindingSig}{\mathtt{bindingSig}}
\newcommand{\nullifierField}{\mathtt{nullifier}}
\newcommand{\nullifiersField}{\mathtt{nullifiers}}
\newcommand{\rkField}{\mathtt{rk}}
\newcommand{\cvField}{\mathtt{cv}}
\newcommand{\cmuField}{\mathtt{cmu}}
\newcommand{\commitmentsField}{\mathtt{commitments}}
\newcommand{\ephemeralKey}{\mathtt{ephemeralKey}}
\newcommand{\encCiphertext}{\mathtt{encCiphertext}}
\newcommand{\encCiphertexts}{\mathtt{encCiphertexts}}
\newcommand{\outCiphertext}{\mathtt{outCiphertext}}
\newcommand{\randomSeed}{\mathtt{randomSeed}}
\newcommand{\spendAuthSig}{\mathtt{spendAuthSig}}
\newcommand{\Varies}{\textit{\!Varies}}
\newcommand{\heading}[1]{\multicolumn{1}{c|}{#1}}
\newcommand{\type}[1]{\texttt{#1}}
\newcommand{\compactSize}{\type{compactSize uint}}


\newcommand{\SighashTxHashing}{\titleterm{SIGHASH Transaction Hashing}}
\newcommand{\sighash}{\term{SIGHASH}}
\newcommand{\sighashTxHash}{\term{SIGHASH transaction hash}}
\newcommand{\sighashTxHashes}{\termes{SIGHASH transaction hash}}
\newcommand{\sighashType}{\term{SIGHASH type}}
\newcommand{\sighashTypes}{\terms{SIGHASH type}}
\newcommand{\SIGHASHALL}{\mathsf{SIGHASH\_ALL}}
\newcommand{\SIGHASHSINGLE}{\mathsf{SIGHASH\_SINGLE}}
\newcommand{\SigHash}{\mathsf{SigHash}}
\newcommand{\scriptSig}{\mathtt{scriptSig}}
\newcommand{\scriptPubKey}{\mathtt{scriptPubKey}}
\newcommand{\ScriptOP}[1]{\texttt{OP\_{#1}}}

% Equihash and block headers

\newcommand{\Equihash}{\term{Equihash}}
\newcommand{\EquihashText}{\titleterm{Equihash}}
\newcommand{\validEquihashSolution}{\term{valid Equihash solution}}
\newcommand{\powtag}{\mathsf{powtag}}
\newcommand{\powheader}{\mathsf{powheader}}
\newcommand{\powcount}{\mathsf{powcount}}
\newcommand{\nVersion}{\mathtt{nVersion}}
\newcommand{\hashPrevBlock}{\mathtt{hashPrevBlock}}
\newcommand{\hashMerkleRoot}{\mathtt{hashMerkleRoot}}
\newcommand{\hashReserved}{\mathtt{hashReserved}}
\newcommand{\hashFinalSaplingRoot}{\mathtt{hashFinalSaplingRoot}}
\newcommand{\hashLightClientRoot}{\mathtt{hashLightClientRoot}}
\newcommand{\hashChainHistoryRoot}{\mathtt{hashChainHistoryRoot}}
\newcommand{\nTimeField}{\mathtt{nTime}}
\newcommand{\nTime}{\mathsf{nTime}}
\newcommand{\nBitsField}{\mathtt{nBits}}
\newcommand{\nBits}{\mathsf{nBits}}
\newcommand{\nNonce}{\mathtt{nNonce}}
\newcommand{\solutionSize}{\mathtt{solutionSize}}
\newcommand{\solution}{\mathtt{solution}}
\newcommand{\SHAd}{\term{SHA-256d}}

% Proving system

\newcommand{\ZK}{\mathsf{ZK}}
\newcommand{\ZKProvingKey}{\mathsf{ZK.ProvingKey}}
\newcommand{\ZKVerifyingKey}{\mathsf{ZK.VerifyingKey}}
\newcommand{\pk}{\mathsf{pk}}
\newcommand{\vk}{\mathsf{vk}}
\newcommand{\vkBytes}[1]{\bytes{\vk_{#1}}}
\newcommand{\ZKGen}{\mathsf{ZK.Gen}}
\newcommand{\ZKProof}{\mathsf{ZK.Proof}}
\newcommand{\ZKPrimary}{\mathsf{ZK.PrimaryInput}}
\newcommand{\ZKAuxiliary}{\mathsf{ZK.AuxiliaryInput}}
\newcommand{\ZKSatisfying}{\mathsf{ZK.SatisfyingInputs}}
\newcommand{\ZKProve}[1]{\mathsf{ZK.}\mathtt{Prove}_{#1}}
\newcommand{\ZKVerify}[1]{\mathsf{ZK.}\mathtt{Verify}_{#1}}
\newcommand{\Simulator}{\mathcal{S}}
\newcommand{\Distinguisher}{\mathcal{D}}
\newcommand{\JoinSplit}{\mathsf{ZKJoinSplit}}
\newcommand{\JoinSplitVerify}{\JoinSplit\mathsf{.Verify}}
\newcommand{\JoinSplitProve}{\JoinSplit\mathsf{.Prove}}
\newcommand{\JoinSplitProof}{\JoinSplit\mathsf{.Proof}}
\newcommand{\Spend}{\mathsf{ZKSpend}}
\newcommand{\SpendVerify}{\Spend\mathsf{.Verify}}
\newcommand{\SpendProve}{\Spend\mathsf{.Prove}}
\newcommand{\SpendProof}{\Spend\mathsf{.Proof}}
\newcommand{\Output}{\mathsf{ZKOutput}}
\newcommand{\OutputVerify}{\Output\mathsf{.Verify}}
\newcommand{\OutputProve}{\Output\mathsf{.Prove}}
\newcommand{\OutputProof}{\Output\mathsf{.Proof}}
\newcommand{\Proof}[1]{\pi_{\!{#1}}}
\newcommand{\ProofJoinSplit}{\pi_\JoinSplit}
\newcommand{\ProofSpend}{\pi_\Spend}
\newcommand{\ProofOutput}{\pi_\Output}
\newcommand{\zkproof}{\mathtt{zkproof}}
\newcommand{\POUR}{\texttt{POUR}}
\newcommand{\Prob}[2]{\mathrm{Pr}\scalebox{0.88}{\ensuremath{
  \left[\!\!\begin{array}{c}#1\end{array} \middle| \begin{array}{l}#2\end{array}\!\!\right]
}}}
\newcommand{\BNImpl}{\mathtt{ALT\_BN128}}

% JoinSplit

\newcommand{\hSig}{\mathsf{h_{Sig}}}
\newcommand{\hSigText}{\texorpdfstring{$\hSig$}{hSig}}
\newcommand{\h}[1]{\mathsf{h_{\mathnormal{#1}}}}
\newcommand{\rmN}{\mathrm{N}}
\newcommand{\NOld}{\rmN^\mathsf{old}}
\newcommand{\NNew}{\rmN^\mathsf{new}}
\newcommand{\allN}[1]{\oneto{\rmN^\mathsf{#1}}}
\newcommand{\allOld}{\allN{old}}
\newcommand{\allNew}{\allN{new}}
\newcommand{\setofOld}{\setof{\allOld}}
\newcommand{\setofNew}{\setof{\allNew}}
\newcommand{\vmacs}{\mathtt{vmacs}}
\newcommand{\vpubOld}{\mathsf{v_{pub}^{old}}}
\newcommand{\vpubNew}{\mathsf{v_{pub}^{new}}}
\newcommand{\nOld}[1]{\NoteTuple{#1}^\mathsf{old}}
\newcommand{\nNew}[1]{\NoteTuple{#1}^\mathsf{new}}
\newcommand{\vOld}[1]{\mathsf{v}_{#1}^\mathsf{old}}
\newcommand{\vNew}[1]{\mathsf{v}_{#1}^\mathsf{new}}
\newcommand{\RandomSeed}{\mathsf{randomSeed}}
\newcommand{\rt}{\mathsf{rt}}
\newcommand{\TreePath}[1]{\mathsf{path}_{#1}}
\newcommand{\Receive}{\mathsf{Receive}}
\newcommand{\EnforceMerklePath}[1]{\mathsf{enforceMerklePath}_{~\!\!#1}}

% Elliptic curve stuff

\newcommand{\Curve}{E}
\newcommand{\Zero}{\mathcal{O}}
\newcommand{\Generator}{\mathcal{P}}
\newcommand{\Selectu}{\scalebox{1.53}{$u$}}
\newcommand{\Selectv}{\scalebox{1.53}{$\varv$}}
\newcommand{\subgroupr}{(\kern-0.075emr\kern-0.075em)}
\newcommand{\Extract}{\mathsf{Extract}}
\newcommand{\GroupHash}{\mathsf{GroupHash}}
\newcommand{\FindGroupHash}{\mathsf{FindGroupHash}}
\newcommand{\Accum}[1]{\mathsf{Accum}_{#1}}

\newcommand{\ParamP}[1]{{{#1}_\mathbb{P}}}
\newcommand{\ParamPexp}[2]{{{#1}_\mathbb{P}\!}^{#2}}
\newcommand{\GroupP}[1]{\mathbb{P}_{#1}}
\newcommand{\GroupPstar}[1]{\GroupP{#1}^{\ast}}
\newcommand{\SubgroupP}[1]{\GroupP{#1}^{\subgroupr}}
\newcommand{\SubgroupPstar}[1]{\GroupP{#1}^{\subgroupr\ast}}
\newcommand{\SubgroupReprP}{\MakeRepr{\GroupP{}}{\subgroupr}}
\newcommand{\CurveP}[1]{\Curve_{\GroupP{#1}}}
\newcommand{\ZeroP}[1]{\Zero_{\GroupP{#1}}}
\newcommand{\OneP}{\ParamP{\mathbf{1}}}
\newcommand{\GenP}[1]{\Generator_{\GroupP{#1}}}
\newcommand{\ellP}[1]{\ell_{\GroupP{#1}}}
\newcommand{\reprP}[1]{\repr_{\GroupP{#1}}}
\newcommand{\abstP}[1]{\abst_{\GroupP{#1}}}
\newcommand{\PairingP}{\ParamP{\hat{e}}}

\newcommand{\ParamG}[1]{{{#1}_\mathbb{G}}}
\newcommand{\ParamGexp}[2]{{{#1}_\mathbb{G}\!}^{#2}}
\newcommand{\GroupG}[1]{\mathbb{G}_{#1}}
\newcommand{\GroupGstar}[1]{\GroupG{#1}^{\ast}}
\newcommand{\SubgroupG}[1]{\GroupG{#1}^{\subgroupr}}
\newcommand{\SubgroupGstar}[1]{\GroupG{#1}^{\subgroupr\ast}}
\newcommand{\SubgroupReprG}{\MakeRepr{\GroupG{}}{\subgroupr}}
\newcommand{\CurveG}[1]{\Curve_{\GroupG{#1}}}
\newcommand{\ZeroG}[1]{\Zero_{\GroupG{#1}}}
\newcommand{\OneG}{\ParamG{\mathbf{1}}}
\newcommand{\GenG}[1]{\Generator_{\GroupG{#1}}}
\newcommand{\ellG}[1]{\ell_{\GroupG{#1}}}
\newcommand{\ReprG}[1]{\bitseq{\ellG{#1}}}
\newcommand{\reprG}[1]{\repr_{\GroupG{#1}}}
\newcommand{\abstG}[1]{\abst_{\GroupG{#1}}}
\newcommand{\PairingG}{\ParamG{\hat{e}}}

\newcommand{\ExtractG}{\Extract_{\SubgroupG{}}}
\newcommand{\GroupGHash}[1]{\GroupHash^{\SubgroupG{}}_{#1}}
\newcommand{\GroupGHashURSType}{\GroupHash\mathsf{.URSType}}
\newcommand{\GroupGHashInput}{\GroupHash\mathsf{.Input}}
\newcommand{\URS}{\mathsf{URS}}

\newcommand{\ParamS}[1]{{{#1}_\mathbb{\hskip 0.03em S}}}
\newcommand{\ParamSexp}[2]{{{#1}_\mathbb{\hskip 0.03em S}\!}^{#2}}
\newcommand{\GroupS}[1]{\mathbb{S}_{#1}}
\newcommand{\GroupSstar}[1]{\GroupS{#1}^{\ast}}
\newcommand{\SubgroupS}[1]{\GroupS{#1}^{\subgroupr}}
\newcommand{\SubgroupSstar}[1]{\GroupS{#1}^{\subgroupr\ast}}
\newcommand{\SubgroupReprS}{\MakeRepr{\GroupS{}}{\subgroupr}}
\newcommand{\CurveS}[1]{\Curve_{\GroupS{#1}}}
\newcommand{\ZeroS}[1]{\Zero_{\GroupS{#1}}}
\newcommand{\OneS}{\ParamS{\mathbf{1}}}
\newcommand{\GenS}[1]{\Generator_{\GroupS{#1}}}
\newcommand{\ellS}[1]{\ell_{\GroupS{#1}}}
\newcommand{\reprS}[1]{\repr_{\GroupS{#1}}}
\newcommand{\abstS}[1]{\abst_{\GroupS{#1}}}
\newcommand{\PairingS}{\ParamS{\hat{e}}}
\newcommand{\MillerLoopS}{\ParamS{\mathsf{MillerLoop}}}
\newcommand{\FinalExpS}{\ParamS{\mathsf{FinalExp}}}
\newcommand{\GrothS}{\Groth_{\kern 0.05em\mathbb{S}}}
\newcommand{\GrothSProof}{\GrothS\mathsf{.Proof}}
\newcommand{\GrothSPrimaryInput}{\GrothS\mathsf{.PrimaryInput}}
\newcommand{\GrothSBatchEntry}{\GrothS\mathsf{.BatchEntry}}
\newcommand{\GrothSBatchVerify}{\GrothS\mathsf{.BatchVerify}}

\newcommand{\ParamJ}[1]{{{#1}_\mathbb{\hskip 0.01em J}}}
\newcommand{\ParamJexp}[2]{{{#1}_\mathbb{\hskip 0.01em J}\!}^{#2}}
\newcommand{\GroupJ}{\mathbb{J}}
\newcommand{\SubgroupJ}{\GroupJ^{\subgroupr}}
\newcommand{\SubgroupJstar}{\GroupJ^{\subgroupr\ast}}
\newcommand{\SubgroupReprJ}{\MakeRepr{\GroupJ}{\subgroupr}}
\newcommand{\CurveJ}{\Curve_{\GroupJ}}
\newcommand{\ZeroJ}{\Zero_{\GroupJ}}
\newcommand{\GenJ}{\Generator_{\GroupJ}}
\newcommand{\ellJ}{\ell_{\GroupJ}}
\newcommand{\ReprJ}{\bitseq{\ellJ}}
\newcommand{\ReprJBytes}{\byteseq{\ellJ/8}}
\newcommand{\reprJ}{\repr_{\GroupJ}}
\newcommand{\abstJ}{\abst_{\GroupJ}}
\newcommand{\SignedScalarLimitJ}{\frac{\ParamJ{r}-1}{2}}

\newcommand{\ExtractJ}{\Extract_{\SubgroupJ}}
\newcommand{\GroupJHash}[1]{\GroupHash^{\SubgroupJstar}_{#1}}
\newcommand{\GroupJHashURSType}{\GroupJHash{}\mathsf{.URSType}}
\newcommand{\GroupJHashInput}{\GroupJHash{}\mathsf{.Input}}
\newcommand{\HashOutput}{\bytes{H}}
\newcommand{\FindGroupJHash}{\FindGroupHash^{\SubgroupJstar}}

\newcommand{\MontCurve}{\mathbb{M}}
\newcommand{\ParamM}[1]{{{#1}_\mathbb{\hskip 0.03em M}}}
\newcommand{\ParamMexp}[2]{{{#1}_\mathbb{\hskip 0.03em M}\!}^{#2}}

\newcommand{\ctEdwards}[1]{E_{\kern 0.03em\mathsf{ctEdwards}({#1})}}
\newcommand{\Edwards}[1]{E_{\kern 0.03em\mathsf{Edwards}({#1})}} % only in history
\newcommand{\Montgomery}[1]{E_{\mathsf{Mont}({#1})}}

\newcommand{\pack}{\mathsf{pack}}

\newcommand{\Acc}{\mathsf{Acc}}
\newcommand{\Base}{\mathsf{Base}}
\newcommand{\Addend}{\mathsf{Addend}}
\newcommand{\Sum}{\mathsf{Sum}}
\newcommand{\Ainv}{A_{\mathsf{inv}}}
\newcommand{\Inv}[1]{{#1}_{\mathsf{inv}}}

\newcommand{\repr}{\mathsf{repr}}
\newcommand{\abst}{\mathsf{abst}}
\newcommand{\xP}{{x_{\hspace{-0.12em}P}}}
\newcommand{\yP}{{y_{\hspace{-0.03em}P}}}

% Conversions

\newcommand{\ECtoOSP}{\mathsf{EC2OSP}}
\newcommand{\ECtoOSPXL}{\mathsf{EC2OSP\mhyphen{}XL}}
\newcommand{\ECtoOSPXS}{\mathsf{EC2OSP\mhyphen{}XS}}
\newcommand{\FEtoIP}{\mathsf{FE2IP}}
\newcommand{\FEtoIPP}{\mathsf{FE2IPP}}
\newcommand{\ItoLEBSP}[1]{\mathsf{I2LEBSP}_{#1}}
\newcommand{\ItoLEBSPOf}[2]{\ItoLEBSP{#1}\!\left({#2}\right)}
\newcommand{\ItoBEBSP}[1]{\mathsf{I2BEBSP}_{#1}}
\newcommand{\ItoBEBSPOf}[2]{\ItoBEBSP{#1}\!\left({#2}\right)}
\newcommand{\LEBStoIP}[1]{\mathsf{LEBS2IP}_{#1}}
\newcommand{\LEBStoIPOf}[2]{\LEBStoIP{#1}\!\left({#2}\right)}
\newcommand{\LEOStoIP}[1]{\mathsf{LEOS2IP}_{#1}}
\newcommand{\LEOStoIPOf}[2]{\LEOStoIP{#1}\!\left({#2}\right)}
\newcommand{\LEBStoOSP}[1]{\mathsf{LEBS2OSP}_{#1}}
\newcommand{\LEBStoOSPOf}[2]{\LEBStoOSP{#1}\!\left({#2}\right)}
\newcommand{\LEOStoBSP}[1]{\mathsf{LEOS2BSP}_{#1}}
\newcommand{\LEOStoBSPOf}[2]{\LEOStoBSP{#1}\!\left({#2}\right)}

% Sapling circuits

\newcommand{\DecompressValidate}{\mathsf{DecompressValidate}}
\newcommand{\FixedScalarMult}{\mathsf{FixedScalarMult}}
\newcommand{\VariableScalarMult}{\mathsf{VariableScalarMult}}
\newcommand{\MontToCtEdwards}{\mathsf{MontToCtEdwards}}
\newcommand{\CtEdwardsToMont}{\mathsf{CtEdwardsToMont}}
\newcommand{\AffineCtEdwardsJubjub}{\mathsf{AffineCtEdwardsJubjub}}
\newcommand{\AffineMontJubjub}{\mathsf{AffineMontJubjub}}
\newcommand{\CompressedCtEdwardsJubjub}{\mathsf{CompressedCtEdwardsJubjub}}
\newcommand{\PedersenHash}{\mathsf{PedersenHash}}
\newcommand{\PedersenGenAlg}{\mathcal{I}}
\newcommand{\PedersenGen}[2]{\PedersenGenAlg^{\kern -0.05em{#1}}_{\kern 0.1em {#2}}}
\newcommand{\PedersenEncode}[1]{\langle{#1}\rangle}
\newcommand{\PedersenEncodeSub}[2]{\langle{#2}\rangle_{\kern -0.1em {#1}\vphantom{S'}}}
\newcommand{\PedersenEncodeNonneg}[1]{\langle{#1}\rangle^{\kern -0.1em\PedersenRangeOffset}}
\newcommand{\PedersenHashToPoint}{\mathsf{PedersenHashToPoint}}
\newcommand{\MixingPedersenHash}{\mathsf{MixingPedersenHash}}
\newcommand{\WindowedPedersenCommitAlg}{\mathsf{WindowedPedersenCommit}}
\newcommand{\WindowedPedersenCommit}[1]{\WindowedPedersenCommitAlg_{#1}}
\newcommand{\HomomorphicPedersenCommitAlg}{\mathsf{HomomorphicPedersenCommit}}
\newcommand{\HomomorphicPedersenCommit}[1]{\HomomorphicPedersenCommitAlg_{#1}}
\newcommand{\Digits}{\mathsf{Digits}}
\newcommand{\PedersenRangeOffset}{\mathsf{\Delta}}
\newcommand{\Sign}{\mathsf{\Theta}}

% Consensus rules

\newcommand{\consensusrule}[1]{\needspace{4ex}\vspace{2ex}\callout{}{Consensus rule:}{#1}}
\newenvironment{consensusrules}{\introlist\callout{}{Consensus rules:}\begin{itemize}}{\end{itemize}}

\newcommand{\prenufouritem}[1]{\item \prenufour{#1}}
\newcommand{\nufouronwarditem}[1]{\nufour{\item {[\Nufour onward]}\, {#1}}}
\newcommand{\preheartwooditem}[1]{\item \preheartwood{#1}}
\newcommand{\heartwoodonwarditem}[1]{\heartwood{\item {[\Heartwood onward]}\, {#1}}}
\newcommand{\preblossomitem}[1]{\item \preblossom{#1}}
\newcommand{\blossomonwarditem}[1]{\blossom{\item {[\Blossom onward]}\, {#1}}}
\newcommand{\presaplingitem}[1]{\item \presapling{#1}}
\newcommand{\saplingonwarditem}[1]{\sapling{\item {[\Sapling onward]}\, {#1}}}
\newcommand{\saplingandblossomitem}[1]{\sapling{\item \saplingandblossom{#1}}}
\newcommand{\preoverwinteritem}[1]{\item \preoverwinter{#1}}
\newcommand{\overwinteronlyitem}[1]{\overwinter{\item {[\Overwinter only, \sapling{pre-\Sapling}]}\, {#1}}}
\newcommand{\overwinteronwarditem}[1]{\overwinter{\item {[\Overwinter onward]}\, {#1}}}
\newcommand{\sproutspecificitem}[1]{\item \sproutspecific{#1}}

\newcommand{\prenufour}[1]{\notbeforenufour{\nufour{[Pre-\Nufour\!]\,}} {#1}}
\newcommand{\nufouronward}[1]{\nufour{[\Nufour onward]\, {#1}}}
\newcommand{\preheartwood}[1]{\notbeforeheartwood{\heartwood{[Pre-\Heartwood\!]\,}} {#1}}
\newcommand{\heartwoodonward}[1]{\heartwood{[\Heartwood onward]\, {#1}}}
\newcommand{\preblossom}[1]{\notbeforeblossom{\blossom{[Pre-\Blossom\!]\,}} {#1}}
\newcommand{\blossomonward}[1]{\blossom{[\Blossom onward]\, {#1}}}
\newcommand{\presapling}[1]{\notsprout{\sapling{[Pre-\Sapling\!]\,}} {#1}}
\newcommand{\saplingonward}[1]{\sapling{[\Sapling onward]\, {#1}}}
\newcommand{\saplingandblossom}[1]{\sapling{[\Sapling and \Blossom only, \heartwood{pre-\Heartwood}]\,} {#1}}
\newcommand{\preoverwinter}[1]{\notsprout{\overwinter{[Pre-\Overwinter\!]\,}} {#1}}
\newcommand{\overwinteronly}[1]{\overwinter{[\Overwinter only, \sapling{pre-\Sapling}]\, {#1}}}
\newcommand{\overwinteronward}[1]{\overwinter{[\Overwinter onward]\, {#1}}}
\newcommand{\sproutspecific}[1]{\notsprout{[\Sprout\!]\,} {#1}}

\newcommand{\securityrequirement}[1]{\needspace{4ex}\vspace{2ex}\callout{}{Security requirement:}{#1}}
\newenvironment{securityrequirements}{\introlist\callout{}{Security requirements:}\begin{itemize}}{\end{itemize}}
\newcommand{\vuln}[1]{\needspace{3ex}{\color{\vulncolor}\callout{}{Vulnerability disclosure:}{#1}}}
\newcommand{\pnote}[1]{\callout{}{Note:}{#1}}
\newenvironment{pnotes}{\introlist\callout{}{Notes:}\begin{itemize}}{\end{itemize}}
\newcommand{\nnote}[1]{\needspace{4ex}\vspace{2ex}\callout{}{Non-normative note:}{#1}}
\newenvironment{nnotes}{\introlist\callout{}{Non-normative notes:}\begin{itemize}}{\end{itemize}}

\newcommand{\prenufourpnote}[1]{\callout{\notbeforenufour{\nufour{[Pre-\Nufour\!]\,\,}}}{Note:}{#1}}
\newcommand{\preheartwoodpnote}[1]{\callout{\notbeforeheartwood{\heartwood{[Pre-\Heartwood\!]\,\,}}}{Note:}{#1}}
\newcommand{\presaplingpnote}[1]{\callout{\notsprout{\sapling{[Pre-\Sapling\!]\,\,}}}{Note:}{#1}}
\newcommand{\preoverwinterpnote}[1]{\callout{\notsprout{\overwinter{[Pre-\Overwinter\!]\,\,}}}{Note:}{#1}}
\newcommand{\overwinteronlypnote}[1]{\callout{\overwinter{[\Overwinter only, \sapling{pre-\Sapling}]\,\,}}{Note:}{#1}}
\newcommand{\overwinteronwardpnote}[1]{\callout{\overwinter{[\Overwinter onward]\,\,}}{Note:}{#1}}
\newcommand{\sproutspecificpnote}[1]{\callout{\notsprout{[\Sprout\!]\,\,}}{Note:}{#1}}

\newcommand{\fact}[1]{\callout{}{Fact:}{#1}}
\newcommand{\facts}[1]{\callout{}{Facts:}{#1}}
\newcommand{\snarkcondition}[2]{\callout{}{#1}\phantomsection\label{#2}}

\newcommand{\affiliation}{\hairspace$^\dagger$\;}

%\newcommand{\maspcolor}{green}
%\newcommand{\maspcolorname}{\maspcolor}
%\newcommand{\setmasp}{\color{\maspcolor}}
\usepackage{soul}
%\newcommand{\masp}[1]{\texorpdfstring{{\hl{#1}}}{#1}}
\newcommand{\masp}[1]{\texorpdfstring{{\color{purple}{#1}}}{#1}}
\newcommand{\maspaddition}[1]{\texorpdfstring{{\color{blue}{#1}}}{#1}}
    
\begin{document}

\title{\textbf{\doctitle} \\
\Large by Heliax AG \\
 \vspace{12pt}
\author{ based on the original Zcash spec by: \\
\Large \leadauthor\hairspace\thanks{\;Electric Coin Company} \\
\Large \coauthora\affiliation ‚Äî \coauthorb\affiliation ‚Äî \coauthorc\affiliation}
%\Large extended by Joseph Bebel\hairspace\thanks{\;Heliax AG}
}
\date{\today}
\maketitle
\vspace{-6ex}\sprout{\vspace{-3ex}}

\notsprout{
\begin{center}
%\hspace{0.6em}\includegraphics[scale=.1]{jubjub}
%\footnote{Jubjub bird image credit: Peter Newell 1902; Daira Hopwood 2018.}
\end{center}
\vspace{-6ex}
} %notsprout

\renewcommand{\abstractname}{}
\begin{abstract}
\normalsize \noindent \textbf{Abstract.}
Changes to the Sapling protocol to support multiple asset types. Research and experimental.

\sprout{\vspace{1ex}}\notsprout{\vspace{2.5ex}}
\noindent \textbf{Keywords:}~ \StrSubstitute[0]{\keywords}{,}{, }.

\ifxetex
\vspace{12pt}
\noindent {\setwarning
This document was built with Xe\TeX, which is \href{https://github.com/zcash/zips/issues/249}{not recommended}.
In particular, vertical spacing will be too cramped due to incorrect metrics for the Quattrocento font.}
\fi
\ifluatex
\vspace{12pt}
\noindent {\setwarning
This document was built with Lua\TeX, which is \href{https://github.com/zcash/zips/issues/249}{not recommended}.}
\fi

\end{abstract}

\introsection

The purpose of this document is to describe the changes made to the \Sapling circuits to allow for user-defined assets. Only the circuit-level changes are specified; protocol-level or contract-level specifications must be described as well.

The following discussions, proposals, and demos provide background and context for the development of this specification:

\begin{itemize}
\item \url{https://github.com/zcash/zips/pull/269}
\item \url{https://github.com/zcash/zcash/issues/830}
\item \url {https://github.com/zcash/zcash/issues/2277#issuecomment-321106819}
\item \url{https://github.com/str4d/librustzcash/tree/funweek-uda-demo} 
\end{itemize}

As well as the original \Sapling specification. Where possible, sections copied from the original \Sapling specification have changes \masp{highlighted in purple} and additional comments \maspaddition{highlighted in blue}.

\lsubsection{Overview and Approach}{overview}

The \Sapling circuits rely on homomorphic Pedersen commitments to represent the value of a shielded \Note. The homomorphic Pedersen commitment requires two  generators of the same subgroup: one to serve as the value base, and another as the randomness base. For security, no discrete log relationship should be known between these two generators. In \Sapling, both generators are carefully constructed and fixed outside of the circuits as images of a \pseudoRandomFunction.

 User-defined assets may be added by varying the generator used as the value base, using a custom asset generator for each distinct asset type. However, since the value base generator is no longer a fixed constant, each asset generator must be dynamically constructed with similar security properties to the construction of the original fixed generator of \Sapling.
 
 \maspaddition{This approach has several significant advantages:
 
 \begin{itemize}
 \item Based on the preliminary approach proposed in the ZIP
\item Allows most of the extensive Sapling feature set to be extended to multiple assets
 \item Leverages the significant effort invested in developing and auditing the high quality Sapling specification and codebase by making as few changes as possible
 \item General enough that the same multi-asset circuits can be reused in different contexts
 \end{itemize}
 
 
 }
 
\lsubsection{Asset Types: Notation and Nomenclature}{notation}

An \textit{asset type} is an abstract property added to a \Sapling \Note, in addition to the value. Notes only have one asset type and all transactions are balanced independently across all asset types. However, different mathematical and computational representations of an asset type will be necessary. To ensure consistency and unambiguity, we will use the following \textbf{names and nomenclature} for different representations of an \textit{asset type}:

\begin{itemize}
\item The \textit{name} of an asset is a user-defined bytestring of arbitrary length that uniquely represents a given asset type. Examples of this may include a combination of:
\begin{itemize}
\item a smart contract address
\item contract-specific data or fields
\item cryptographic salt
\item random beacon
\end{itemize}
\item The \textit{identifier} of an asset is a 32-byte string derived from the asset \textit{name} in a deterministic way. The asset \textit{identifier} differs from the asset \textit{name} in three respects:
\begin{enumerate}
\item The asset \textit{identifier} is a compressed representation of the asset type. The \textit{name} may be an arbitrary length whereas the \textit{identifier} is always 32 bytes.
\item Only a constant fraction (approximately 45\%) of 32 byte strings will be valid asset identifiers
\item The asset \textit{identifier} is always the Blake2s preimage of the asset \textit{generator} (defined next)
\end{enumerate}
\item The asset \textit{generator} (also known as the \textit{value base}) is a valid \ctEdwardsCurve point on the \jubjubCurve, whose compressed bit representation is the $\BlakeTwosGeneric$ image of the asset \textit{identifier}
\end{itemize}

The exact contents of the \textit{asset name} may be defined outside of the circuit specifications. The asset name could include the output of a random beacon or other unpredictable randomness to prevent the possibility of precomputation attacks against a particular asset type. 

In all cases, the asset \textit{identifier} should be derived from the asset \textit{name} in such a way that invalid identifiers are never generated and all generated identifiers are the same length. The simplest way to derive such identifiers is by rejection sampling. 

The asset \textit{generator} will be derived via a \pseudoRandomFunction from the asset \textit{identifier}. This computation must be efficient (it is computed in the Output circuit) and also be plausibly computationally infeasible to know a discrete log relationship between the asset generators of two distinct asset types.

Asset types may also be associated with a \textit{human-readable asset name} and/or a \textit{asset symbol}. The human-readable asset name and asset symbol may be used for user-facing presentations of the asset type, particularly if the \textit{asset name} is not suitable for this purpose. Assignment and use of human-readable asset names and asset symbols are outside the scope of this document.

\maspaddition{The 32 byte size of the asset identifier is somewhat arbitrary, but strongly motivated by the following observations:

\begin{itemize}
\item The asset identifier length should be constant size; this simplifies the circuit design, and also the encrypted note should use a constant size field to represent the asset type.
\item The asset identifier length should not be longer than 64 bytes unless explicitly necessary; otherwise the cost of hashing in the Output circuit increases significantly with every additional 64 byte input block. Additionally, if encrypted notes represent the note's asset type with an asset identifier field, longer asset identifiers increase the encrypted note size and use more storage space on the block chain.
\item The benefits of asset identifier length shorter than 32 bytes are not significant. There is insignificant benefit in the cost of the Output circuit, as the in-circuit hash uses  at least one 32 byte input block. If a shorter asset type representation is implementation-desired (e.g. for encrypted notes), the implementation could use a shorter asset name, truncated asset identifier, lookup table of assets, etc., as appropriate for the application.
\item The asset identifier should be long enough to include added entropy, if desired. For example, adding entropy from a randomness beacon (discussed later) to add to the unpredictability of the asset generator. A 32 byte asset identifier accommodates a large amount of potential added entropy without going over the 64 byte block input size.

\end{itemize}
}

\lsubsection{Derivation of Asset Generator from Asset Identifer}{derivation}

The asset generator associated with each asset type must be derived in such a way that plausibly no discrete log relationship is known between every two distinct asset types (or between an asset generator and the common randomness base generator).

In this specification, the asset generator associated with a given asset identifier is derived using a \pseudoRandomFunction; specifically, instantiating $\PRFvcgMASP{}$ with $\BlakeTwosGeneric$ similar to how other \pseudoRandomFunctions are instantiated in the original \Sapling specification. Therefore, the asset generator associated with asset identifier $\NoteToken$ should be $\abstJ(\PRFvcgMASP{\NoteToken})$, if it exists, and this derivation is verified in at least one circuit.

\maspaddition{The \pseudoRandomFunction $\PRFvcgMASP{}$ should take as input the 32 byte asset identifier, and produce as output a (potential) 32 byte \ctEdwardsCompressedEncoding on the \jubjubCurve. The output must be verified to be a valid \ctEdwardsCurve point, and when instantiated with $\BlakeTwosGeneric$, use a distinct personalization from the other \pseudoRandomFunctions used in the original Sapling specification and this specification.
}

One may wonder if it is necessary to verify the derivation of the asset generator from the asset identifier in circuit. The answer is ``yes'': if the asset generator was witnessed to the circuit's private inputs without checking its validity as an asset generator, then someone may witness the negation of an asset generator and produce notes with negative value of the actual asset (and therefore, creating notes of arbitrarily positive value that homomorphically balance with the negative value note)

One may also wonder if a Pedersen hash may be used instead (particularly as it is much more efficient to compute in the circuit than a \pseudoRandomFunction). The answer is that it may not be used: a Pedersen hash is not a \pseudoRandomFunction, and while it may offer collision resistance, it is possible to find related preimages easily. For example, because the Pedersen hash generators are publicly known, given an existing asset identifier and asset generator, someone may derive new asset identifiers and new asset generators that have some known fixed relationship to the existing asset generator. This may allow unwanted conversion between valid asset types.

\lsubsection{Rejection Sampling of Asset Identifiers Hashing to Curve Point}{rejection}

\maspaddition{The previous section noted that the asset generator associated with asset identifier $\NoteToken$ should be $\abstJ(\PRFvcgMASP{\NoteToken})$. However, $\abstJ(\PRFvcgMASP{\NoteToken})$ may not exist, in which case $\NoteToken$ is an \textit{invalid} asset identifier. To avoid excessive computation in the Output circuit, such invalid $\NoteToken$ identifiers should always be rejected by the Output circuit, and all external implementations should only use valid asset identifiers exclusively.}

 The asset identifier should be deterministically derived from the asset name. Since there is some probability of deriving an invalid asset identifier, one potential approach is to try potential asset identifiers, rejecting invalid ones, until a valid asset identifier that properly hashes to an asset generator. We can describe such a process as \textit{rejection sampling}.
 
 \maspaddition{$\GroupJHash{\URS}$, which is used to find generators for Pedersen commitments and hashes in $\Sapling$, may also be used to derive the asset identifier. In this case $\GroupJHash{\URS}\Of{\text{asset name}}$ may be the asset generator associated with some asset name; the asset identifier would be the preimage of the resulting asset generator (computed as an intermediate step of $\GroupJHash{\URS}$). Alternatively, the asset name may be hashed repeatedly until a valid asset identifier is found. The size of a 32 byte asset identifier is also intended to facilitate derivation of an asset identifier as the image of a hash function. }

     Hashing  \maspaddition{a uniformly random asset} identifier bytestring to a group element, a \ctEdwardsCurve point on the \jubjubCurve, can fail in one of three ways:

\begin{enumerate}

\item The identifier could hash to a small order point on the curve. Since the \jubjubCurve is the direct sum of a small order subgroup with a large prime order subgroup, the $\BlakeTwosGeneric$ image of the identifier may be the y  coordinate of a small order point on the curve, and so when  multiplied by the cofactor gives the identity. The small order subgroup contains very few elements, so the probability of hashing to one of these  points is extremely small (exponentially small).

Identifiers whose $\BlakeTwosGeneric$ hash is a small order point are rejected.

\item The identifier could hash to 256 bits, of which the leading 255 bits encode an integer that is at least the order of the underlying field of the \jubjubCurve, and therefore is not a  valid field element unless taken modulo the order of the field (which we cannot do, if we desire a uniformly random curve point in the random oracle model).

 The probability of this event is approximately 9.431\% and so it occurs reasonably often.
    
    Identifiers whose $\BlakeTwosGeneric$ hash is larger than the field modulus are rejected.

\item The identifier could hash to 256 bits, of which the leading 255 bits encode a field element such that no point on the curve has that field element as y coordinate. Then it is not possible to interpret the $\BlakeTwosGeneric$ hash image as a compressed representation of a curve point/group element at all.

The probability of this event is approximately (but not precisely) 1/2

Identifiers whose $\BlakeTwosGeneric$ hash is not the compressed representation of some \jubjubCurve point are rejected.
\end{enumerate}

The overall probability that a uniformly random identifier hashes successfully is approximately 0.5 * 0.9057 = 0.453 and so the expected number of identifiers tried is approximately 2.2.

Some theoretical attacks against the asset identifier generation process are noted:
\begin{enumerate}
\item Rejection sampling is not constant time, potentially allowing side channel attacks that leak the asset type.
\item An attacker may attempt to find asset names that generate long sequences of invalid asset identifiers before finding a valid one. Extremely long sequences are likely infeasible to precompute but shorter sequences are more feasible, causing the asset identifier generation process to use more computation than average for a certain asset.
\end{enumerate}

\maspaddition{
\lsubsection{Hash-to-curve RFC}{rfc}

There exists a draft RFC (\url{https://datatracker.ietf.org/doc/draft-irtf-cfrg-hash-to-curve/}) for hashing data to curves which differs substantially from the methods described to derive the asset generator. Indeed, the RFC explicitly disallows the use of rejection sampling. There are several advantages of using the RFC hash-to-curve methods:

\begin{enumerate}
\item The RFC describes a well documented and well analyzed approach to hash-to-curve 
\item The RFC hash-to-curve is designed to be implemented in constant time, mitigating certain information leakage
\item The RFC hash-to-curve may later be used in other projects and there is potential value in standardization
\end{enumerate}

However, there are also factors in favor of the rejection sampling approach:

\begin{enumerate}
\item Rejection sampling is conceptually somewhat simpler and easier to reason about
\item Rejection sampling is typically less expensive in total circuit operations, reducing the total cost
\item Rejection sampling primarily uses well-audited primitives and existing code/gadgets; potentially less novel code and fewer bugs than implementing new gadgets
\item Rejection sapling is already used widely in  $\Sapling$ to derive group hashes (for Pedersen hashes and commitments. In particular, the circuits permit using exactly the existing $\Sapling$ $\GroupJHash{}$ to derive the asset generator (among other possible choices) while the RFC is a draft.
\end{enumerate}

Unfortunately, supporting both RFC and rejection sampling based asset generator derivation in the same circuits appears impractical at the moment. At minimum, the added complexity of supporting both would increase the potential for implementation bugs. 

Implementation of RFC compatible hash-to-curve gadgets in the bellman library would allow the use of RFC hash-to-curve inside the circuits; however such an implementation still adds significant complexity and requires significant effort to achieve the same level of analysis and scrutiny that the simpler rejection sampling method would. The MASP demo only supports rejection sampling based asset generator derivation.

Not using the RFC hash-to-curve method does introduce some concrete risks. The asset generator derivation is now likely not constant time, introducing potential for side channel attacks and information leakage. It should be noted that constant time implementation and side channel attack prevention is not a goal of the MASP demo. Side channel and information leakage should be avoided by typical isolation of private data and computation as much as possible. 

Side channel information leakage and timing attacks may be slightly mitigated by observing that asset identifier derivation is a public process (in order to allow shielding/unshielding of transparent balance) and does not use private data. In this way the situation is slightly different than if private data is hashed to curve. Implementations could store derived asset identifiers and hash those in constant time to asset generators. It should be noted that since asset names are not specified in the circuits or this document that variable length asset names (or other properties of the asset identifier derivation process) may leak additional information besides timing. 

}
\lsubsection{Security}{security}

The homomorphic Pedersen value commitments are constructed similarly to the original Sapling circuit and should be similarly \textit{value hiding} (infeasible to recover the value from the commitment without knowledge of the trapdoor randomness) and \textit{non-forgeable} (infeasible to open the value commitment to another value). This requires that no discrete log relationship is known between the \textit{value base} (in this case, the \textit{asset generator}) and the \textit{randomness trapdoor generator}.

 When there are multiple assets, the value commitment should also be \textit{asset hiding} and \textit{non-exchangeable}: it should be infeasible to recover the asset type without knowledge of the trapdoor, and it should be infeasible to open the value commitment to another asset.  This requires that no discrete log relationship is known between every pair of asset generators. If asset generators are derived in a uniformly random way, then deriving a discrete log relationship between asset generators should be approximately as difficult as finding a discrete log relationship between a constant value base and fixed randomness base generator.
 
The security of these multiple asset value commitments relies on similar assumptions underlying the security of the homomorphic Pedersen commitments and Pedersen hashes of the original $\Sapling$ circuits. 

The security of those commitments and hashes is based on the hardness of the discrete log problem over a given elliptic curve group. For expository purposes, here is an informal argument sketch: Let $G_1, \ldots, G_k$ be $k$ uniformly random elliptic curve points. Assume there is an algorithm that finds a discrete log relationship between a single pair $G_i, G_j$ faster than finding a discrete log relationship between two chosen points $P, Q$. Then by choosing $2k$ uniformly random elements $a_i, b_i$ of the finite field of the same order as the curve, finding a discrete log relationship among a single pair of $R_i = [ a_i ] P + [ b_i ] Q$ should reveal a discrete log relationship between $P,Q$. A more rigorous proof may be found in the literature.

\maspaddition{Recall the use of a $\pseudoRandomFunction$ to derive the asset generator from the asset identifier. Continuing the example from earlier, it should be infeasible for someone to find two asset identifiers whose images are points $P$ and $[-1] P$; otherwise an unlimited amount of those assets can be created in notes that balance homomorphically to zero in a single transaction. In the concrete case of $\BlakeTwosGeneric$ and the $\jubjubCurve$, the points $P$ and $[-1] P$ differ by a single bit in the compressed point representation (the sign of the $x$ coordinate) and share the other 255 bits (the $y$ coordinate). Therefore, the non-forgeability of assets depends on the infeasibility of finding two $\BlakeTwosGeneric$ preimages that differ only in one (positioned) bit.

The (in)ability to witness the negation of an asset generator is one specific example of the security requirements from the $\pseudoRandomFunction$. This example is a particularly dramatic one, as well, since witnessing a valid asset identifier and the negation of its asset generator will potentially satisfy all constraints in the Output circuit except for a \textit{single bit} equality check (the sign bit). 

It is similarly important that for every pair of asset generators, no discrete log relationship should be feasibly known between them. Otherwise, the non-exchangeability or non-forgeability of those assets become broken; either a positive amount of one asset may be converted into a positive amount of the other asset, or positive amounts of both assets may be created from an overall zero incoming note value (depending on the exact discrete log relationship known). Therefore, a critically important security property of the $\BlakeTwosGeneric$ hash is \textit{Discrete Logarithm Independence} of its outputs interpreted as curve points. As the original $\Sapling$ specification describes, Discrete Logarithm Independence holds almost surely for a random oracle, and is stronger than (and implies) collision resistance. 

For the purposes of analyzing the security of the circuits, the desired security property is that it is infeasible to (adversarially) find two asset identifiers with a known discrete log relationship between their corresponding asset generators. The security of the circuits will be based on that hardness assumption. The security assumption may be weakened by not allowing the asset identifier to be selected entirely freely (e.g. including a randomness beacon, as in the $\Sapling$ $\GroupJHash{}$. 

}

\lsubsection{Multiple Asset Heterogenous Transactions}{multipleassets}

As in the single asset $\Sapling$ model, a transaction may consist of some number of incoming notes and some number of outgoing notes (typically at least two of each) such that the sum of values of outgoing (created) notes minus the sum of values of incoming (spent) notes is equal to the change in the total transparent value of the pool. In the case of multiple assets, this sum should be balanced independently across all possible asset types. While every note has only one asset type, it is possible that transactions may contain notes of different asset types (\textit{heterogenous transactions}). The use of homomorphic Pedersen commitments allows the sum to be balanced verifiably outside of the circuits even when the asset types of the notes are unknown.

\maspaddition{Since every asset generator is prime order, the theoretical possibility exists of overflow of the value field when notes are balanced in a transaction. It is not possible to externally observe overflow, as it may occur even if the value commitments balance. For example, in a transaction, the sum of incoming note values could equal 0, and the sum of outgoing note values could be some integer multiple of the prime order. Opening this transparent value change commitment to $0$ modulo the prime order would violating the desired non-forgeable property. This attack is likely impractical due to the limitation of each note value to an unsigned 64-bit integer; however there is no restriction inside the circuit to prevent overflow. The number of notes used in a transaction should be limited to a safe value to further mitigate this issue. The original Zcash $\Sapling$ protocol addresses this issue by limiting the maximum transaction size. 

Additionally, it should be noted that the binding signature in the original $\Sapling$ protocol only supports a single asset generator, and so only a single asset type can be shielded or unshielded with a nonzero transparent balance change in a given transaction. While this behavior is logical in the single asset shielded pool, in the multiple asset shielded pool this is an unnecessary restriction. Binding signatures for nonzero transparent balance change for multiple assets in a single transaction is a potential feature that can be implemented entirely outside of the circuits.
}

%CAUTION: The circuits \maspaddition{input} the value of a $\Note$ as a 64-bit unsigned integer. In addition to this limit on the maximum value of a given note, the external protocol or contract should be aware that issuing large value notes may theoretically allow overflow of the Pedersen commitment. While likely impractical, there is nothing in this specification or these circuits prohibiting transactions with total value exceeding the order of the \jubjubCurve. This may be addressed outside of the circuit by the implementing protocol or contract.

\lsubsection{Random beacon}{randombeacon}

Derivation of an asset identifier from a name may include the input of a random beacon, to lower the probability that some party did precomputation on the resulting asset generator prior to the asset name becoming public (or some other point in time). Various preexisting random beacons can be used, or new randomness beacons can be used for this purpose, or even dynamically used every time a new asset type is created.

\maspaddition{Since there is no provision inside of the circuits for an entropy source, all entropy that will be included in the final asset generator must be included in the asset identifier.  A randomness beacon is not used to derive the asset generator from the asset identifier inside the circuit because:

\begin{itemize}
\item Adding another 32 byte input block to the $\BlakeTwosGeneric$ hash inside the circuit would significantly increase the size of the Output circuit with a corresponding performance penalty.
\item A 32 byte asset identifier can contain a reasonable amount of entropy from a randomness beacon used to derive the asset identifier; therefore, the entropy from a beacon can be inserted in the asset identifier derivation, outside of the circuit, while still influencing the final asset generator.
\item The randomness beacon used to (ultimately) derive a particular asset generator does not need to be known at the time of circuit creation. New asset types could use a fresh randomness beacon, or randomness generated in some other way, depending on the specific case.
\end{itemize}

The randomness beacons used in the original \sapling system are based on hashes of specified bitcoin blocks; subsequently the entropy available from this source has slightly decreased and other randomness beacon sources (e.g. \url{https://blog.cloudflare.com/league-of-entropy/}) have become available.
}

\maspaddition{

\lsubsection{Personalizations}{personalizations}

The original \Sapling circuits and accompanying out-of-circuit implementations use unique personalizations for each instantiation of a pseudorandom function or collision resistant hash function. Each personalization is an 8 byte string prefixed by the 5 bytes ``Zcash''. The personalizations in the MASP beta demo version of librustzcash are modified to be the exact same strings prefixed by the 5 bytes ``MASP\_'' to add domain separation from the Zcash protocol, with the exceptions of the value base (now ``MASP\_\_v\_''), and of the randomness base (now ``MASP\_\_r\_'') 

}

\maspaddition{
\lsubsection{Risks}{risks}

The following (non-exhaustive) risks are noted and should be considered in all uses of the MASP demo:

\begin{itemize}
\item The use of non-constant time operations such as rejection sampling could allow side channel attacks and information leakage
\item The Discrete Log Independence assumption necessary for non-forgeability and non-exchangeability properties of a given asset may not hold, either because of implementation errors or because the assumptions are false for the $\pseudoRandomFunction$ used.
\item Other newly introduced implementation errors from the incorrect use of existing circuit constructs or gadgets 
\item Unintentional and unexpected behavior of the $\Sapling$ protocol when used in a multiple asset context
\item Unintentional and unexpected behavior of the $\Sapling$ protocol when used with assets with unlimited token issuance
\item Potential unknown design or implementation flaws preexisting in the $\Sapling$ protocol
\item Failure of the trusted setup process if Groth16 is used as the proving scheme for the Spend and Output circuits
\item High levels of effort required to patch even minor bugs in the Spend and Output circuits, because of the repeated trusted setup required
\item Catastrophic failures of even minor bugs, since bugs may be actively exploited for an indefinite period of time without publicly discovery, because of the zero knowledge properties of the proving system.
\item Bugs or vulnerabilities may not be publicly discovered until the entire shielded pool has been drained of assets
\item Privacy may be compromised by side channel attacks, information leakage, metadata and traffic analysis of transactions, payment of transparent fees to use the shielded pool, and other potential sources of information
\end{itemize}

}

\lsubsection{\Notes}{notes}

\sprout{
A \defining{\note} (denoted $\NoteTuple{}$) is a tuple $\changed{(\AuthPublic, \Value,
\NoteAddressRand, \NoteCommitRand)}$. It represents that a value $\Value$ is
spendable by the recipient who holds the \spendingKey $\AuthPrivate$ corresponding
to $\AuthPublic$, as described in the original \Sapling specification.
} %sprout
\notsprout{
A \defining{\note} (denoted $\NoteTuple{}$) can be a \Sprout \note\sapling{ or a
\Sapling \note}. In either case it represents that a value $\Value$ is
spendable by the recipient who holds the \spendingKey corresponding
to a given \paymentAddress.
} %notsprout

Let \sprout{$\MAXMONEY$ and $\PRFOutputLengthSprout$}
\notsprout{$\MAXMONEY$, $\PRFOutputLengthSprout$\sapling{, $\PRFOutputLengthNfSapling$, and $\DiversifierLength$}}
be as defined in the original \Sapling specification. %\crossref{constants}.

%Let $\NoteCommitSproutAlg$ be as defined in \crossref{concretesproutnotecommit}.

\masp{
Let $\NoteCommitMASPAlg$ be as defined as:

\begin{formulae}
  \item $\NoteCommitMASP{\NoteCommitRand}(\DiversifiedTransmitBaseRepr, \DiversifiedTransmitPublicRepr, \Value, \mathsf{vb\Repr}) :=
           \WindowedPedersenCommit{\NoteCommitRand}\left(\ones{6} \bconcat \mathsf{vb\Repr} \bconcat \ItoLEBSPOf{64}{\Value} \bconcat
             \DiversifiedTransmitBaseRepr \bconcat \DiversifiedTransmitPublicRepr \right)$
\end{formulae}


Let $\KASapling$ be as defined  in the original \Sapling specification.
} %masp

\masp{Let $\NoteTokenLength = 32$ bytes be the length of the asset identifier}.

\sapling{
\vspace{1ex}
\introlist
A \masp{MASP} \note is a tuple \masp{$(\Diversifier, \DiversifiedTransmitPublic,
\Value, \NoteCommitRand, \NoteToken)$}, where:
\begin{itemize}
  \item $\Diversifier \typecolon \DiversifierType$
        is the \diversifier of the recipient's \paymentAddress;
  \item $\DiversifiedTransmitPublic \typecolon \KASaplingPublicPrimeOrder$
        is the \diversifiedTransmissionKey of the recipient's \paymentAddress;
  \item $\Value \typecolon \range{0}{\MAXMONEY}$ is an integer
        representing the value of the \note in \zatoshi;
  \item $\NoteCommitRand \typecolon \NoteCommitSaplingTrapdoor$
        is a random \commitmentTrapdoor as defined in the original \Sapling specification.
   \item \masp{$\NoteToken \typecolon \NoteTokenType$ is a bytestring representing the asset identifier of
   the note}
\end{itemize}
}%sapling
\masp{
\introlist
Let $\NoteTypeMASP$ be the type of a MASP \note, i.e.
\begin{formulae}
  \item \masp{$\NoteTypeMASP := \DiversifierType \times \KASaplingPublicPrimeOrder \times \range{0}{\MAXMONEY}
           \times \NoteCommitSaplingTrapdoor \times \NoteTokenType$}.
\end{formulae}
} %masp

Creation of new \notes is as described in the original \Sapling specification. When \notes are sent,
only a commitment  to the above values is disclosed
publically, and added to a data structure called the \noteCommitmentTree.
This allows the value and recipient to be kept private, while the commitment is
used by the \zeroKnowledgeProof when the \note is spent, to check that it exists
on the \blockchain.


\masp{
\vspace{2ex}
\introlist
Let $\DiversifyHash$ be as defined in the original \Sapling specification. %\crossref{concretediversifyhash}.

A MASP \noteCommitment on a \note  
$\NoteTuple{} = (\Diversifier, \DiversifiedTransmitPublic, \Value, \NoteCommitRand, \NoteToken)$} is computed as

\begin{formulae}
  \item $\DiversifiedTransmitBase := \DiversifyHash(\Diversifier)$
        \vspace{-1ex}
  \item \masp{$\NoteCommitmentMASP(\NoteTuple{}) := \begin{cases}
          \bot, &\caseif \DiversifiedTransmitBase = \bot \\
          \NoteCommitMASP{\NoteCommitRand}(\reprJ\Of{\DiversifiedTransmitBase},
                                              \reprJ\Of{\DiversifiedTransmitPublic},
                                              \Value, \reprJ(\PRFvcgMASP{\NoteToken})), &\caseotherwise.
        \end{cases}$}
\end{formulae}
\vspace{-1.5ex}

\sapling{
Notice that the above definition of a \masp{MASP} \note does not have a
$\NoteAddressRand$ field. There is in fact a $\NoteAddressRand$ value associated
with each \masp{MASP} \note, but this can only be computed once its position in the
\noteCommitmentTree is known.
We refer to the combination of a \note and its \notePosition $\NotePosition$, as a
\positionedNote.}

\masp{
For a \positionedNote, we can compute the value
$\NoteAddressRand$ as described in the original \Sapling specification. %\crossref{commitmentsandnullifiers}.
} %masp

\vspace{2ex}
A \nullifier (denoted $\nf$) is derived from the $\NoteAddressRand$ value
of a \note and the recipient's
\spendingKey $\AuthPrivate$\sapling{ or \nullifierKey $\AuthProvePublic$}.
This computation uses a \pseudoRandomFunction,
as described  in the original \Sapling specification.

A \note is spent by proving knowledge of
$(\NoteAddressRand, \AuthPrivate)$\sapling{ or $(\NoteAddressRand, \AuthSignPublic, \AuthProvePrivate)$}
in zero knowledge while publically disclosing its \nullifier $\nf$,
allowing $\nf$ to be used to prevent double-spending. \sapling{In the case
of \Sapling, a \spendAuthSignature is also required, in order to demonstrate
knowledge of $\AuthSignPrivate$.}

\begin{comment}
\lsubsubsection{\NotePlaintexts{} and \Memos}{noteptconcept}

Transmitted \notes are stored on the \blockchain in encrypted form, together with
a representation of the \noteCommitment $\cm$.

\saplingonward{
The \notePlaintext in each \outputDescription is encrypted to the
\diversifiedPaymentAddress $(\Diversifier, \DiversifiedTransmitPublic)$.

\introlist
Each \Sapling{} \defining{\notePlaintext} (denoted $\NotePlaintext{}$) consists of

\vspace{-1ex}
\begin{formulae}
  \item \masp{$(\Diversifier \typecolon \DiversifierType, \Value \typecolon \ValueType,
          \NoteCommitRandBytes \typecolon \NoteCommitSaplingTrapdoorBytes, \Memo \typecolon \MemoType, \NoteToken \typecolon \NoteTokenType)$.}
\end{formulae}
} %saplingonward

\changed{
$\Memo$ represents a $\MemoByteLength$-byte \memo associated with this \note.
The usage of the \memo is by agreement between the sender and recipient of the \note.
}

Other fields are as defined in \crossref{notes}.

Encodings are given in \crossref{notept}.
The result of encryption forms part of a \noteOrNotesCiphertext.
For further details, see \crossref{sproutinband}\sapling{ and \crossref{saplinginband}}.
\end{comment}
\sapling{
\introlist
\lsubsubsection{Sending \Notes{} (\SaplingText)}{saplingsend}

\masp{This section describes potential outside of circuit implementation details}.

In order to send \masp{MASP} \shielded value, the sender constructs a \transaction
containing one or more \outputDescriptions.

Let $\ValueCommitAlg$, $\KASapling$, $\DiversifyHash$, $\abstJ$, $\reprJ$, $\ParamJ{r}$, and $\ParamJ{h}$ be as defined in the original \Sapling specification.

\vspace{1ex}
Let $\OutViewingKey$ be an \outgoingViewingKey that is intended to be able to decrypt
this payment. This may be one of:
\begin{itemize}
  \item the \outgoingViewingKey for the address (or one of the addresses) from which the
        payment was sent;
  \item the \outgoingViewingKey for all payments associated with an \definingquotedterm{account},
        to be defined in \cite{ZIP-32};
  \item $\bot$, if the sender should not be able to decrypt the payment once it has
        deleted its own copy.
\end{itemize}

\pnote{Choosing $\OutViewingKey = \bot$ is useful if the sender prefers to obtain
forward secrecy of the payment information with respect to compromise of its own secrets.}

\introlist
\vspace{2ex}
For each \outputDescription, the sender selects a value $\ValueNew{} \typecolon \range{0}{\MAXMONEY}$
and a destination \Sapling \paymentAddress $(\Diversifier, \DiversifiedTransmitPublic)$, and then
performs the following steps:

\vspace{0.5ex}
\begin{itemize}
  \item Check that $\DiversifiedTransmitPublic$ is of type $\KASaplingPublicPrimeOrder$, i.e.\ it
        is a valid \ctEdwardsCurve point on the \jubjubCurve (as defined in the original \Sapling specification)
        not equal to $\ZeroJ$, and $\scalarmult{\ParamJ{r}}{\DiversifiedTransmitPublic} = \ZeroJ$.

  \item Calculate $\DiversifiedTransmitBase = \DiversifyHash(\Diversifier)$
        and check that $\DiversifiedTransmitBase \neq \bot$.

  \item Choose independent uniformly random commitment trapdoors:

        \begin{tabular}{@{\hskip 2em}r@{\;}l}
          $\ValueCommitRandNew{}$ &$\leftarrowR \ValueCommitGenTrapdoor()$ \\
          $\NoteCommitRandNew{}$ &$\leftarrowR \NoteCommitSaplingGenTrapdoor()$
        \end{tabular}

\masp{
  \item Check that $\scalarmult{\ParamJ{h}} { \reprJ(\PRFvcgMASP{\NoteToken})}$ is of type $\KASaplingPublicPrimeOrder$, i.e.\ it
        is a valid \ctEdwardsCurve point on the \jubjubCurve (as defined in the original \Sapling specification)
        not equal to $\ZeroJ$.  If it is equal to $\ZeroJ$, $\NoteToken$ is an invalid \textit{asset identifier}. 
        
  \item Calculate
        \begin{tabular}{@{\hskip 2em}r@{\;}l}
%          $\cvNew{}$ &$:= \ValueCommit{\ValueCommitRandNew{}}(\ValueNew{})$ \\[1ex]$
	$\NoteValueBase$ &$:= \abstJ(\PRFvcgMASP{\NoteToken}) $\\[1ex]
          $\cvNew{}$ &$:= \scalarmult{\ValueNew{}\ParamJ{h}}{\NoteValueBase} + \scalarmult{\ValueCommitRandNew{}}{ \GroupJHash{\URS}\Of{\ascii{MASP\_\_r\_},\ascii{r}}} $ \\[1ex]
          $\cmNew{}$ &$:= \NoteCommitMASP{\NoteCommitRandNew{}}(\reprJ\Of{\DiversifiedTransmitBase},
                                                                   \reprJ\Of{\DiversifiedTransmitPublic},
                                                                   \ValueNew{},\reprJ\Of{\NoteValueBase})$
        \end{tabular}
}
  \item Let $\NotePlaintext{} = (\Diversifier, \ValueNew{}, \NoteCommitRandBytes, \Memo, \masp{\NoteToken})$, where
        $\NoteCommitRandBytes = \LEBStoOSPOf{256}{\ItoLEBSP{256}(\NoteCommitRandNew{})\kern-0.12em}$.

  \item Encrypt $\NotePlaintext{}$ to the recipient
        \diversifiedTransmissionKey $\DiversifiedTransmitPublic$ with
        \diversifiedTransmissionBase $\DiversifiedTransmitBase$, and to the
        \outgoingViewingKey $\OutViewingKey$, giving the \noteCiphertext
        $(\EphemeralPublic, \TransmitCiphertext{}, \OutCiphertext)$
        as described in the original \Sapling specification. This procedure also uses
        $\cvNew{}$ and $\cmNew{}$ to derive the \outgoingCipherKey.

  \item Generate a proof $\ProofOutput$ for the \outputStatement in \crossref{outputstatement}.

  \item Return $(\cvNew{}, \cmNew{}, \EphemeralPublic, \TransmitCiphertext{}, \OutCiphertext, \ProofOutput)$.
\end{itemize}

In order to minimize information leakage, the sender \SHOULD randomize the order
of \outputDescriptions in a \transaction. Other considerations relating to
information leakage from the structure of \transactions are beyond the
scope of this specification. The encoded \transaction is submitted to the network.
} %sapling


%\introsection
\lsubsection{\DummyNotes}{\sprout{sproutdummynotes}\notsprout{dummynotes}}

\sapling{
\introsection
\lsubsubsection{\DummyNotes{} (\SaplingText)}{saplingdummynotes}

In \masp{MASP} there is no need to use \dummy \notes simply in order to fill
otherwise unused inputs as in the case of a \joinSplitDescription; nevertheless
it may be useful for privacy to obscure the number of real \shieldedInputs from
\masp{MASP} \notes{}.

\vspace{0.5ex}
Let $\SpendingKeyLength$ , $\ParamJ{r}$, $\reprJ$, $\AuthProveBase$, $\PRFnfSapling{}$, $\NoteCommitSaplingAlg$ be as defined  in the original \Sapling specification.

\introlist
\vspace{0.5ex}
A \dummy{} \masp{MASP} input \note is constructed as follows:
\vspace{-0.5ex}
\begin{itemize}
  \item Choose uniformly random $\SpendingKey \leftarrowR \SpendingKeyType$.
  \item Generate a new \diversifiedPaymentAddress $(\Diversifier, \DiversifiedTransmitPublic)$
        for $\SpendingKey$ as described  in the original \Sapling specification.
  \item Set $\vOld{} = 0$, and set $\NotePosition = 0$.
  \item Choose uniformly random $\NoteCommitRand \leftarrowR \NoteCommitSaplingGenTrapdoor()$.
        and $\AuthProvePrivate \leftarrowR \GF{\ParamJ{r}}$.
  \item Compute $\AuthProvePublic = \scalarmult{\AuthProvePrivate}{\AuthProveBase}$ and
        $\AuthProvePublicRepr = \reprJ\Of{\AuthProvePublic}$\,.
  \item \masp{Compute $\NoteAddressRand{} = \cmOld{}
                                    = \NoteCommitMASP{\NoteCommitRand}(\reprJ\Of{\DiversifiedTransmitBase},
                                                                          \reprJ\Of{\DiversifiedTransmitPublic},
                                                                          \vOld{},
                                                                           \reprJ\Of{\GroupJHash{\URS}\Of{\ascii{MASP\_\_r\_},\ascii{r}}})$.}
  \item Compute $\nfOld{} = \PRFnfSapling{\AuthProvePublicRepr}(\reprJ(\NoteAddressRand))$.
  \item Construct a \dummy \merklePath $\TreePath{}$ for use in the
        \auxiliaryInput to the \spendStatement (this will not be checked, because $\vOld{} = 0$).
\end{itemize}

As in \masp{Sapling}, a \dummy{} \masp{MASP} output \note is constructed as normal but with
zero value, and sent to a random \paymentAddress.
} %sapling

\begin{comment}
\sapling{
\introsection
\lsubsection{Balance and \BindingSignature{} (\SaplingText)}{saplingbalance} \label{bindingsig}

\Sapling adds \spendTransfers and \outputTransfers to the transparent and
\joinSplitTransfers present in \Sprout.
The net value of \spendTransfers minus \outputTransfers in a \transaction is
called the \defining{\balancingValue}, measured in \zatoshi as a signed integer $\vBalance$.

$\vBalance$ is encoded explicitly in a \transaction as the field \valueBalance{};
see \crossref{txnencoding}.

A positive $\balancingValue$ takes value from the \saplingValuePool and adds it
to the \transparentValuePool. A negative $\balancingValue$ does the reverse.
As a result, positive $\vBalance$ is treated like an \emph{input} to the
\transparentValuePool, whereas negative $\vBalance$ is treated like an \emph{output}
from that pool.

Consistency of $\vBalance$ with the \valueCommitments in \spendDescriptions
and \outputDescriptions is enforced by the \defining{\bindingSignature}. This signature
has a dual r√¥le in the \Sapling protocol:

\begin{itemize}
  \item To prove that the total value spent by \spendTransfers, minus that
        produced by \outputTransfers, is consistent with the $\vBalance$ field
        of the \transaction;
  \item To prove that the signer knew the randomness used for the spend and output
        \valueCommitments, in order to prevent \outputDescriptions from being
        replayed by an adversary in a different \transaction.
        (A \spendDescription already cannot be replayed due to its \spendAuthSignature.)
\end{itemize}

Instead of generating a key pair at random, we generate it as a function of the
\valueCommitments in the \spendDescriptions and \outputDescriptions of the \transaction,
and the \balancingValue.

\vspace{2ex}
Let $\SubgroupJ$, $\SubgroupJstar$, and $\ParamJ{r}$ be as defined in the original \Sapling specification.

\introlist
Let $\ValueCommit{}$, $\ValueCommitValueBase$, and $\ValueCommitRandBase$
be as defined in the original \Sapling specification:
\vspace{-0.5ex}
\begin{formulae}
  \item $\ValueCommit{} \typecolon \ValueCommitTrapdoor \times \ValueCommitType \rightarrow \ValueCommitOutput$;
        \vspace{-1ex}
  \item $\ValueCommitValueBase \typecolon \SubgroupJstar$ is the value base in $\ValueCommit{}$;
  \item $\ValueCommitRandBase \typecolon \SubgroupJstar$ is the randomness base in $\ValueCommit{}$.
\end{formulae}

$\BindingSig$, $\combplus$, and $\grpplus$ are instantiated in \crossref{concretebindingsig}.
These and the derived notation $\combminus$, $\scombsum{i=1}{\rmN}$, $\grpminus$, and
$\sgrpsum{i=1}{\rmN}$ are specified in \crossref{abstractsigmono}.

\vspace{1.5ex}
\introlist
Suppose that the \transaction has:
\begin{itemize}
  \item $n$ \spendDescriptions with \valueCommitments $\cvOld{\alln}$,
        committing to values $\vOld{\alln}$ with randomness $\ValueCommitRandOld{\alln}$;
  \item $m$ \outputDescriptions with \valueCommitments $\cvNew{\allm}$,
        committing to values $\vNew{\allm}$ with randomness $\ValueCommitRandNew{\allm}$;
  \item \balancingValue $\vBalance$.
\end{itemize}

\vspace{-0.5ex}
In a correctly constructed \transaction, $\vBalance = \ssum{i=1}{n} \vOld{i} - \ssum{j=1}{m} \vNew{j}$,
but validators cannot check this directly because the values are hidden by the commitments.

\introlist
Instead, validators calculate the \txBindingVerificationKey as:
\begin{formulae}
% <https://twitter.com/hdevalence/status/984145085674676224> ¬Ø\_(„ÉÑ)_/¬Ø
  \item $\BindingPublic := \Bigg(\!\vcombsum{i=1}{n}\kern 0.2em \cvOld{i}\kern 0.05em\Bigg) \combminus\!
                           \Bigg(\kern-0.05em\vcombsum{j=1}{m}\kern 0.2em \cvNew{j}\kern 0.05em\Bigg) \combminus
                           \ValueCommit{0}\big(\vBalance\big)$.
\end{formulae}
\vspace{-1ex}
(This key is not encoded explicitly in the \transaction and must be recalculated.)

\introlist
\vspace{1ex}
The signer knows $\ValueCommitRandOld{\alln}$ and $\ValueCommitRandNew{\allm}$, and so can
calculate the corresponding signing key as:
\begin{formulae}
  \item $\BindingPrivate := \Bigg(\!\vgrpsum{i=1}{n} \ValueCommitRandOld{i}\Bigg) \grpminus\!
                            \Bigg(\!\vgrpsum{j=1}{m} \ValueCommitRandNew{j}\Bigg)$.
\end{formulae}

\introlist
\vspace{-1ex}
In order to check for implementation faults, the signer \SHOULD also check that
\begin{formulae}
  \item $\BindingPublic = \BindingSigDerivePublic(\BindingPrivate)$.
\end{formulae}

\vspace{0.5ex}
Let $\SigHash$ be the \sighashTxHash as defined in \cite{ZIP-243}, not associated with an input,
using the \sighashType $\SIGHASHALL$.

A validator checks balance by verifying that $\BindingSigVerify{\BindingPublic}(\SigHash, \bindingSig) = 1$.

\vspace{1ex}
We now explain why this works.

\vspace{1ex}
A \bindingSignature proves knowledge of the discrete logarithm $\BindingPrivate$ of
$\BindingPublic$ with respect to $\ValueCommitRandBase$.
That is, $\BindingPublic = \scalarmult{\BindingPrivate}{\ValueCommitRandBase}$.
So the value $0$ and randomness $\BindingPrivate$ is an opening of the \xPedersenCommitment
$\BindingPublic = \ValueCommit{\BindingPrivate}(0)$.
By the binding property of the \xPedersenCommitment, it is infeasible to find another
opening of this commitment to a different value.

Similarly, the binding property of the \valueCommitments in the \spendDescriptions and
\outputDescriptions ensures that an adversary cannot find an opening to more than one value
for any of those commitments, i.e.\ we may assume that $\vOld{\alln}$ are determined by
$\cvOld{\alln}$, and that $\vNew{\allm}$ are determined by $\cvNew{\allm}$. We may also
assume, from Knowledge Soundness of $\Groth$, that the Spend proofs could not have been
generated without knowing $\ValueCommitRandOld{\alln} \pmod{\ParamJ{r}}$, and the Output
proofs could not have been generated without knowing $\ValueCommitRandNew{\allm} \pmod{\ParamJ{r}}$.

\introlist
Using the fact that $\ValueCommit{\ValueCommitRand}(\Value) = \scalarmult{\Value}{\ValueCommitValueBase}\,
\combplus \scalarmult{\ValueCommitRand}{\ValueCommitRandBase}$, the expression for $\BindingPublic$ above is
equivalent to:

\vspace{1ex}
\begin{tabular}{@{\hskip 2em}r@{\;}l}
  $\BindingPublic$ &$= \Biggscalarmult{\Bigg(\!\vgrpsum{i=1}{n} \vOld{i}\Bigg) \grpminus\!
                                       \Bigg(\!\vgrpsum{j=1}{m} \vNew{j}\Bigg) \grpminus \vBalance}{\ValueCommitValueBase}\, \combplus
                       \Biggscalarmult{\Bigg(\!\vgrpsum{i=1}{n} \ValueCommitRandOld{i}\Bigg) \grpminus\!
                                       \Bigg(\!\vgrpsum{j=1}{m} \ValueCommitRandNew{j}\Bigg)}{\ValueCommitRandBase}$ \\[3.5ex]
                   &$= \ValueCommit{\BindingPrivate}\Bigg(\!\vsum{i=1}{n} \vOld{i} - \vsum{j=1}{m} \vNew{j} - \vBalance\Bigg)$.
\end{tabular}

\introlist
Let $\vSum = \vsum{i=1}{n} \vOld{i} - \vsum{j=1}{m} \vNew{j} - \vBalance$.

Suppose that $\vSum = \vBad \neq 0 \pmod{\ParamJ{r}}$.
Then $\BindingPublic = \ValueCommit{\BindingPrivate}(\vBad)$. If the adversary were able to
find the discrete logarithm of this $\BindingPublic$ with respect to $\ValueCommitRandBase$, say
$\BindingPrivate'$ (as needed to create a valid \bindingSignature), then $(\vBad, \BindingPrivate)$
and $(0, \BindingPrivate')$ would be distinct openings of $\BindingPublic$ to different values,
breaking the binding property of the \valueCommitmentScheme.

\introlist
The above argument shows only that $\Value^* = 0 \pmod{\ParamJ{r}}$; in order to show that
$\vSum = 0$, we will also demonstrate that it does not overflow $\ValueCommitType$.

The $\spendStatements$ prove that all of $\vOld{\alln}$ are in $\ValueType$.
Similarly the $\outputStatements$ prove that all of $\vNew{\allm}$ are in $\ValueType$.
$\vBalance$ is encoded in the \transaction as a signed two's complement $64$-bit integer
in the range $\range{-2^{63}}{2^{63}-1}$. $\ValueLength$ is defined as 64, so $\vSum$
is in the range $\range{-m \mult (2^{64}-1) - 2^{63} + 1}{n \mult (2^{64}-1) + 2^{63}}$.
The maximum \transaction size of $2$ MB limits $n$ to at most $\floor{\frac{2000000}{384}} = 5208$
and $m$ to at most $\floor{\frac{2000000}{948}} = 2109$, ensuring
$\vSum \in \range{-38913406623490299131842}{96079866507916199586728}$
which is a subrange of $\ValueCommitType$.

Thus checking the \bindingSignature ensures that the \transaction balances, without
the individual values of the \spendDescriptions and \outputDescriptions being revealed.

In addition this proves that the signer, knowing the $\biggrpplus$\kern-0.015em-sum of the \valueCommitment
randomnesses, authorized a \transaction with the given \sighashTxHash by signing $\SigHash$.

\vspace{1ex}
\pnote{
The spender \MAY reveal any strict subset of the \valueCommitment randomnesses to
other parties that are cooperating to create the \transaction. If all of the
\valueCommitment randomnesses are revealed, that could allow replaying the
\outputDescriptions of the \transaction.
} %pnote

\nnote{
The technique of checking signatures using a \publicKey derived from a sum of
\xPedersenCommitments is also used in the \Mimblewimble protocol \cite{Jedusor2016}.
The \privateKey $\BindingPrivate$ acts as a \definingquotedterm{synthetic blinding factor},
in the sense that it is synthesized from the other blinding factors (\trapdoors)
$\ValueCommitRandOld{\alln}$ and $\ValueCommitRandNew{\allm}$; this technique is
also used in \Bulletproofs \cite{Dalek-notes}.
} %nnote
} %sapling
\end{comment}
\begin{comment}
\sapling{
\lsubsection{\SpendAuthSignature}{spendauthsig}

$\SpendAuthSig$ is used in \Sapling to prove knowledge of the \spendingKey authorizing
spending of an input \note. It is instantiated in \crossref{concretespendauthsig}.

Knowledge of the \spendingKey could have been proven directly in the \spendStatement,
similar to the check in \crossref{sproutspendauthority} that is part of the \joinSplitStatement.
The motivation for a separate signature is to allow devices that are limited in memory
and computational capacity, such as hardware wallets, to authorize a \Sapling shielded spend.
Typically such devices cannot create, and may not be able to verify, \zkSNARKProofs for
a \statement of the size needed using the $\BCTV$ or $\Groth$ proving systems.

\vspace{1ex}
The verifying key of the signature must be revealed in the \spendDescription so that
the signature can be checked by validators. To ensure that the verifying key cannot
be linked to the \paymentAddress or \spendingKey from which the \note was spent, we
use a \rerandomizableSignatureScheme. The \spendStatement proves that this verifying
key is a re-randomization of the \spendAuthAddressKey $\AuthSignPublic$ with a randomizer
known to the signer. The \spendAuthSignature is over the \sighashTxHash, so that it cannot be
replayed in other \transactions.

\intropart
\vspace{2ex}
Let $\SigHash$ be the \sighashTxHash as defined in \cite{ZIP-243}, not associated with an input,
using the \sighashType $\SIGHASHALL$.

Let $\AuthSignPrivate$ be the \spendAuthPrivateKey as defined in \crossref{saplingkeycomponents}.

\vspace{2ex}
For each \spendDescription, the signer chooses a fresh \spendAuthRandomizer $\AuthSignRandomizer$:

\begin{enumerate}
  \item Choose $\AuthSignRandomizer \leftarrowR \SpendAuthSigGenRandom()$.
  \item Let $\AuthSignRandomizedPrivate = \SpendAuthSigRandomizePrivate(\AuthSignRandomizer, \AuthSignPrivate)$.
  \item Let $\AuthSignRandomizedPublic = \SpendAuthSigDerivePublic(\AuthSignRandomizedPrivate)$.
  \item Generate a proof $\ProofSpend$ of the \spendStatement (\crossref{spendstatement}),
        with $\AuthSignRandomizer$ in the \auxiliaryInput and $\AuthSignRandomizedPublic$
        in the \primaryInput.
  \item Let $\spendAuthSig = \SpendAuthSigSign{\AuthSignRandomizedPrivate}(\SigHash)$.
\end{enumerate}

\introlist
The resulting $\spendAuthSig$ and $\ProofSpend$ are included in the \spendDescription.

\vspace{1ex}
\pnote{
If the spender is computationally or memory-limited, step 4 (and only step 4) \MAY be delegated
to a different party that is capable of performing the \zkProof. In this case privacy will be
lost to that party since it needs $\AuthSignPublic$ and the \authProvingKey $\AuthProvePrivate$;
this allows also deriving the $\AuthProvePublic$ component of the \fullViewingKey. Together
$\AuthSignPublic$ and $\AuthProvePublic$ are sufficient to recognize spent \notes and to
recognize and decrypt incoming \notes. However, the other party will not obtain spending
authority for other \transactions, since it is not able to create a \spendAuthSignature by itself.
} %pnote
} %sapling


\intropart
\lsubsection{\NoteCommitments{} and \Nullifiers}{commitmentsandnullifiers}

A \transaction that contains one or more
\joinSplitDescriptions\sapling{ or \spendDescriptions}, when entered
into the \blockchain, appends to the \noteCommitmentTree with all constituent
\noteCommitments.

All of the constituent \nullifiers are also entered into the
\nullifierSet of the associated \treestate. A \transaction is not valid if it
would have added a \nullifier to the \nullifierSet that already exists in the set
(see \crossref{nullifierset}).

\vspace{2ex}
\sprout{Each}\notsprout{In \Sprout, each} \note has a $\NoteAddressRand$ component.

\sapling{
\vspace{2ex}
\introlist
In \Sapling, each \positionedNote has an associated $\NoteAddressRand$ value which
is computed from its \noteCommitment $\cm$ and \notePosition $\NotePosition$
as follows:

\begin{formulae}
  \item $\NoteAddressRand := \MixingPedersenHash(\cm, \NotePosition)$.
\end{formulae}

$\MixingPedersenHash$ is defined in the original \Sapling specification.
} %sapling

\vspace{2ex}
Let $\PRFnf{}{}$\sapling{ and $\PRFnfSapling{}{}$} be as instantiated in the original \Sapling specification.

\vspace{2ex}
\sprout{The \nullifier of a \note}\notsprout{For a \Sprout{} \note, the \nullifier}
is derived as $\PRFnf{\AuthPrivate}(\NoteAddressRand)$, where $\AuthPrivate$ is the
\spendingKey associated with the \note.

\vspace{2ex}
\sapling{
For a \Sapling{} \note, the \nullifier is derived as
$\PRFnfSapling{\AuthProvePublicRepr}(\NoteAddressRandRepr)$, where $\AuthProvePublicRepr$
is a representation of the \nullifierKey associated with the \note and $\NoteAddressRandRepr = \reprJ(\NoteAddressRand)$.
} %sapling


\notsprout{\pagebreak}\sprout{\intropart}
\lsubsection{\ZkSNARKStatements}{snarkstatements}

\vspace{-1ex}
\lsubsubsection{\JoinSplitStatement\pSproutOrNothingText}{joinsplitstatement}

\vspace{-2ex}
Let $\MerkleHashLengthSprout$, $\PRFOutputLengthSprout$, $\MerkleDepthSprout$, $\ValueLength$,
$\AuthPrivateLength$, $\NoteAddressPreRandLength$, $\hSigLength$, $\NOld$, $\NNew$ be as defined in \crossref{constants}.

\vspace{-1ex}
Let $\PRFaddr{}$, $\PRFnf{}$, $\PRFpk{}$, \changed{and $\PRFrho{}$} be as defined in \crossref{abstractprfs}.

\vspace{-1ex}
Let $\NoteCommitSprout{}$ be as defined in \crossref{abstractcommit}, and
let $\NoteTypeSprout$ and $\NoteCommitmentSprout$ be as defined in \crossref{notes}.

A valid instance of $\ProofJoinSplit$ assures that given a \primaryInput:

\vspace{-1ex}
\begin{formulae}
  \item $\oparen\rt \typecolon \MerkleHashSprout,\\
         \hparen\nfOld{\allOld} \typecolon \typeexp{\PRFOutputSprout}{\NOld},\\
         \hparen\cmNew{\allNew} \typecolon \typeexp{\NoteCommitSproutOutput}{\NNew},\vspace{0.6ex}\\
         \hparen\changed{\vpubOld \typecolon \ValueType,}\vspace{0.6ex}\\
         \hparen\vpubNew \typecolon \ValueType,\\
         \hparen\hSig \typecolon \hSigType,\\
         \hparen\h{\allOld} \typecolon \smash{\typeexp{\PRFOutputSprout}{\NOld}\cparen}$,
\end{formulae}
\vspace{-1.5ex}
the prover knows an \auxiliaryInput:
\vspace{-0.5ex}
\begin{formulae}
  \item $\oparen\TreePath{\allOld} \typecolon \typeexp{\typeexp{\MerkleHashSprout}{\MerkleDepthSprout}}{\NOld},\\
         \hparen\NotePosition_{\allOld} \typecolon \typeexp{\NotePositionTypeSprout}{\NOld},\\
         \hparen\nOld{\allOld} \typecolon \typeexp{\NoteTypeSprout}{\NOld},\\
         \hparen\AuthPrivateOld{\allOld} \typecolon \typeexp{\bitseq{\AuthPrivateLength}}{\NOld},\\
         \hparen\nNew{\allNew} \typecolon \typeexp{\NoteTypeSprout}{\NNew}\changed{,}\vspace{0.8ex}\\
         \hparen\changed{\NoteAddressPreRand \typecolon \bitseq{\NoteAddressPreRandLength},}\vspace{-0.5ex}\\
         \hparen\changed{\EnforceMerklePath{\allOld} \typecolon \bitseq{\NOld}}\cparen$,
\end{formulae}
\vspace{-2ex}
where:
\vspace{-0.5ex}
\begin{formulae}
  \item for each $i \in \setofOld$: $\nOld{i} = (\AuthPublicOld{i},
\vOld{i}, \NoteAddressRandOld{i}, \NoteCommitRandOld{i})$;
  \item for each $i \in \setofNew$: $\nNew{i} = (\AuthPublicNew{i},
\vNew{i}, \NoteAddressRandNew{i}, \NoteCommitRandNew{i})$
\end{formulae}
\vspace{-1ex}
such that the following conditions hold:

\snarkcondition{Merkle path validity}{sproutmerklepathvalidity}
for each $i \in \setofOld$ \changed{$\mid$ $\EnforceMerklePath{i} = 1$}:
$(\TreePath{i}, \NotePosition_i)$ is a valid \merklePath (see \crossref{merklepath}) of depth
$\MerkleDepthSprout$ from $\NoteCommitmentSprout(\nOld{i})$ to the \anchor $\rt$.

\pnote{Merkle path validity covers conditions 1.\,(a) and 1.\,(d) of the NP \statement
in \cite[section 4.2]{BCGGMTV2014}.}

\changed{\snarkcondition{Merkle path enforcement}{sproutmerklepathenforcement}}
for each $i \in \setofOld$, if $\vOld{i} \neq 0$ then $\EnforceMerklePath{i} = 1$.

\snarkcondition{Balance}{sproutbalance}
$\changed{\vpubOld\; +} \ssum{i=1}{\NOld} \vOld{i} = \vpubNew + \ssum{i=1}{\NNew} \vNew{i} \in \ValueType$.

\snarkcondition{\Nullifier{} integrity}{sproutnullifierintegrity}
for each $i \in \setofOld$:
$\nfOld{i} = \PRFnf{\AuthPrivateOld{i}}(\NoteAddressRandOld{i})$.

\snarkcondition{Spend authority}{sproutspendauthority}
for each $i \in \setofOld$:
$\AuthPublicOld{i} = \changed{\PRFaddr{\AuthPrivateOld{i}}(0)}$.

\snarkcondition{Non-malleability}{sproutnonmalleablejs}
for each $i \in \setofOld$:
$\h{i} = \PRFpk{\AuthPrivateOld{i}}(i, \hSig)$.

\changed{\snarkcondition{Uniqueness of $\NoteAddressRandNew{i}$}{sproutuniquerho}
for each $i \in \setofNew$:
$\NoteAddressRandNew{i} = \PRFrho{\NoteAddressPreRand}(i, \hSig)$.}

\snarkcondition{Note commitment integrity}{sproutcommitmentintegrity}
for each $i \in \setofNew$: $\cmNew{i} = \NoteCommitmentSprout(\nNew{i})$.

\vspace{1ex}
For details of the form and encoding of proofs, see \crossref{bctv}.

\end{comment}
\sapling{
\lsubsubsection{\SpendStatement{} (\masp{MASP})}{spendstatement}

\masp{The new MASP Spend circuit has 100637 constraints. The original \Sapling Spend circuit has 98777 constraints.}

\vspace{-1ex}
Let $\MerkleHashLengthSapling$, $\PRFOutputLengthNfSapling$, $\ScalarLength$, $\ValueCommitAlg$, $\NoteCommitSaplingAlg$, $\SpendAuthSig$, $\GroupJ$, $\SubgroupJ$, $\reprJ$, $\ParamJ{q}$, $\ParamJ{r}$, $\ParamJ{h}$, \\ 
$\ExtractJ \typecolon \SubgroupJ \rightarrow \MerkleHashSapling$ ,  $\AuthProveBase$ be as defined in the original \Sapling specification.

\intropart
\vspace{0.5ex}
A valid instance of $\ProofSpend$ assures that given a \primaryInput:

\vspace{-1ex}
\begin{formulae}
  \item $\oparen\rt \typecolon \MerkleHashSapling,\\
         \hparen\cvOld{} \typecolon \ValueCommitOutput,\\
         \hparen\nfOld{} \typecolon \bitseq{\PRFOutputLengthNfSapling},\\
         \hparen\AuthSignRandomizedPublic \typecolon \SpendAuthSigPublic\cparen$,
\end{formulae}

\vspace{-2ex}
\introlist
the prover knows an \auxiliaryInput:

\vspace{-1ex}
\begin{formulae}
  \item $\oparen\TreePath{} \typecolon \typeexp{\MerkleHash}{\MerkleDepthSapling},\\
         \hparen\NotePosition \typecolon \NotePositionTypeSapling,\vspace{0.4ex}\\
         \hparen\DiversifiedTransmitBase \typecolon \GroupJ,\\
         \hparen\DiversifiedTransmitPublic \typecolon \GroupJ,\vspace{0.6ex}\\
         \hparen\vOld{} \typecolon \ValueType,\\
         \hparen\ValueCommitRandOld{} \typecolon \binaryrange{\ScalarLength},\\
         \hparen\cmOld{} \typecolon \GroupJ,\\
         \hparen\NoteCommitRandOld{} \typecolon \binaryrange{\ScalarLength},\\
         \hparen\AuthSignRandomizer \typecolon \binaryrange{\ScalarLength},\\
         \hparen\AuthSignPublic \typecolon \SpendAuthSigPublic,\\
         \hparen\AuthProvePrivate \typecolon \binaryrange{\ScalarLength},\\
         \masp{\hparen\NoteValueBase \typecolon \GroupJ}\cparen$ %masp
\end{formulae}
\vspace{-1.5ex}
such that the following conditions hold:

\vspace{0.5ex}
\snarkcondition{Note commitment integrity}{spendnotecommitmentintegrity}
$\cmOld{} = \NoteCommitMASP{\NoteCommitRandOld{}}(\reprJ\Of{\DiversifiedTransmitBase},
                                                     \reprJ\Of{\DiversifiedTransmitPublic},
                                                     \vOld{}\masp{, \reprJ\Of{\NoteValueBase}})$.%masp

\snarkcondition{Merkle path validity}{spendmerklepathvalidity}
Either $\vOld{} = 0$; or $(\TreePath{}, \NotePosition)$ is a valid \merklePath of depth $\MerkleDepthSapling$,
as defined in the original \Sapling specification, from $\cmU = \ExtractJ(\cmOld{})$ to the \anchor $\rt$.

\snarkcondition{Value commitment integrity}{spendvaluecommitmentintegrity}
%$\cvOld{} = \ValueCommit{\ValueCommitRandOld{}}(\vOld{})$.
\masp{$\cvOld{} = \scalarmult{\ValueOld{} \ParamJ{h} }{\NoteValueBase} + \scalarmult{\ValueCommitRandOld{}}{ \GroupJHash{\URS}\Of{\ascii{MASP\_\_r\_},\ascii{r}}} $}

\snarkcondition{Small order checks}{spendnonsmall}
$\DiversifiedTransmitBase$ and $\AuthSignPublic$ \masp{and $\NoteValueBase$}
are not of small order, i.e.\ $\scalarmult{\ParamJ{h}}{\DiversifiedTransmitBase} \neq \ZeroJ$
and $\scalarmult{\ParamJ{h}}{\AuthSignPublic} \neq \ZeroJ$ \masp{and $\scalarmult{\ParamJ{h}}{\NoteValueBase} \neq \ZeroJ$}.

\snarkcondition{\Nullifier{} integrity}{spendnullifierintegrity}
$\nfOld{} = \PRFnfSapling{\AuthProvePublicRepr}(\NoteAddressRandRepr)$ where
\vspace{-1ex}
\begin{formulae}
  \item $\AuthProvePublicRepr = \reprJ\Of{\scalarmult{\AuthProvePrivate}{\AuthProveBase}}$
        \vspace{-1ex}
  \item $\NoteAddressRandRepr = \reprJ\big(\MixingPedersenHash(\cmOld{}, \NotePosition)\kern-0.12em\big)$.
\end{formulae}

\snarkcondition{Spend authority}{spendauthority}
$\AuthSignRandomizedPublic = \SpendAuthSigRandomizePublic(\AuthSignRandomizer, \AuthSignPublic)$.

\snarkcondition{Diversified address integrity}{spendaddressintegrity}
$\DiversifiedTransmitPublic = \scalarmult{\InViewingKey}{\DiversifiedTransmitBase}$ where
\vspace{-1ex}
\begin{formulae}
  \item $\InViewingKey = \CRHivk(\AuthSignPublicRepr, \AuthProvePublicRepr)$
        \vspace{-1ex}
  \item $\AuthSignPublicRepr = \reprJ\Of{\AuthSignPublic}$\,.
\end{formulae}

\masp{The form and encoding of \spendStatement proofs may be Groth16 as in the original \Sapling specification.}

\begin{pnotes}
  \item Public and \auxiliaryInputs{} \MUST be constrained to have the types specified. In particular,
        see the original \Sapling specifcation, for required validity checks on compressed
        representations of \jubjubCurve points.

        The $\ValueCommitOutput$ and $\SpendAuthSigPublic$ types also represent points, i.e. $\GroupJ$.
  \item In the Merkle path validity check, each \merkleLayer does \emph{not} check that its
        input bit sequence is a canonical encoding (in $\range{0}{\ParamS{r}-1}$) of the integer
        from the previous \merkleLayer.
  \item It is \emph{not} checked in the \spendStatement that $\AuthSignRandomizedPublic$ is not of
        small order. However, this \emph{is} checked outside the \spendStatement, as specified in
        the original \Sapling specifcation.
  \item It is \emph{not} checked that $\ValueCommitRandOld{} < \ParamJ{r}$ or that $\NoteCommitRandOld{} < \ParamJ{r}$.
  \item $\SpendAuthSigRandomizePublic(\AuthSignRandomizer, \AuthSignPublic) = \AuthSignPublic + \scalarmult{\AuthSignRandomizer}{\AuthSignBase}$.
        ($\AuthSignBase$ is as defined in the original \Sapling specifcation.)
        
        \item \masp{
        Note that the asset identifier is \textit{not} witnessed in the $\SpendStatement$. Since the validity of $\NoteValueBase$ is witnessed in the $\OutputStatement$ and included in the $\Note$ commitment, the asset generator is validated when the $\Note$ commitment is validated.
        }
\end{pnotes}
} %sapling


\sapling{
\introsection
\lsubsubsection{\OutputStatement{} (\masp{MASP})}{outputstatement}

\masp{The new MASP Output circuit has 31205 constraints. The original Sapling Output circuit has 7827 constraints. Most of the extra cost comes from computing one Blake2s hash in the circuit.}

Let $\MerkleHashLengthSapling$, $\PRFOutputLengthNfSapling$, $\ScalarLength$, $\ValueCommitAlg$, $\GroupJ$, $\reprJ$, and $\ParamJ{h}$ be as defined in the original \Sapling specification.

\vspace{1ex}
A valid instance of $\ProofOutput$ assures that given a \primaryInput:

\begin{formulae}
  \item $\oparen\cvNew{} \typecolon \ValueCommitOutput,\\
         \hparen\cmU \typecolon \MerkleHashSapling,\\
         \hparen\EphemeralPublic \typecolon \GroupJ\cparen$,
\end{formulae}

\vspace{-1ex}
\introlist
the prover knows an \auxiliaryInput:

\begin{formulae}
  \item $(\DiversifiedTransmitBase \typecolon \GroupJ,\\[0.5ex]
   \hparen\DiversifiedTransmitPublicRepr \typecolon \ReprJ,\\
   \hparen\vNew{} \typecolon \ValueType,\\
   \hparen\ValueCommitRandNew{} \typecolon \binaryrange{\ScalarLength},\\
   \hparen\NoteCommitRandNew{} \typecolon \binaryrange{\ScalarLength},\\
   \hparen\EphemeralPrivate \typecolon \binaryrange{\ScalarLength},\\
   \masp{\hparen\NoteValueBase \typecolon \GroupJ},\\ %masp
   \masp{\hparen\NoteToken \typecolon \NoteTokenType}\cparen$%masp
\end{formulae}
\vspace{-1ex}
such that the following conditions hold:

\vspace{1ex}
\snarkcondition{Note commitment integrity}{outputnotecommitmentintegrity}\masp{
$\cmU = \ExtractJ\big(\NoteCommitMASP{\NoteCommitRandNew{}}(\DiversifiedTransmitBaseRepr,
                                                               \DiversifiedTransmitPublicRepr,
                                                               \vNew{},
                                                               \NoteValueBase\Repr)\kern-0.12em\big)$,}
where $\DiversifiedTransmitBaseRepr = \reprJ\Of{\DiversifiedTransmitBase}$ and \masp{$\NoteValueBase\Repr = \reprJ\Of{vb}$}\,.

\snarkcondition{Value commitment integrity}{outputvaluecommitmentintegrity}
%$\cvNew{} = \ValueCommit{\ValueCommitRandNew{}}(\vNew{})$.
\masp{$\cvNew{} =  \scalarmult{\ValueNew{} \ParamJ{h}}{\NoteValueBase} + \scalarmult{\ValueCommitRandNew{}}{ \GroupJHash{\URS}\Of{\ascii{MASP\_\_r\_},\ascii{r}}} $  }

\masp{
\snarkcondition{Value base integrity}{outputvaluebaseintegrity}
$\reprJ\Of{vb} = \PRFvcgMASP{\NoteToken}$. The comparison is done as bits.
}

\snarkcondition{Small order check}{outputnonsmall}
$\DiversifiedTransmitBase$ \masp{and $\NoteValueBase$ are} not of small order,
i.e.\ $\scalarmult{\ParamJ{h}}{\DiversifiedTransmitBase} \neq \ZeroJ$.

\vspace{0.5ex}
\snarkcondition{Ephemeral \publicKey integrity}{outputepkintegrity}
$\EphemeralPublic = \scalarmult{\EphemeralPrivate}{\DiversifiedTransmitBase}$.

\vspace{2ex}
\masp{The form and encoding of \outputStatement proofs may be Groth16 as in the original \Sapling specification.}

\begin{pnotes}
  \item Public and \auxiliaryInputs{} \MUST be constrained to have the types specified. In particular,
        see the original \Sapling specification, for required validity checks on compressed
        representations of \jubjubCurve points.

        The $\ValueCommitOutput$ type also represents points, i.e. $\GroupJ$.
  \item The validity of $\DiversifiedTransmitPublicRepr$ is \emph{not} checked in this circuit.
  \item It is \emph{not} checked that $\ValueCommitRandOld{} < \ParamJ{r}$ or that $\NoteCommitRandOld{} < \ParamJ{r}$.
\end{pnotes}
} %sapling

\masp{
  Some private inputs such as $\alpha,\EphemeralPrivate,\AuthProvePrivate \in \{0, \ldots, 2^\ScalarLength - 1\}$ 
  represent the bit-decomposition of an element in the scalar field of an elliptic curve with order $\ParamJ{r}$. 
  Unlike the variables $rcm, rcv$, the specification does not mention explicitly that the corresponding field 
  elements do not need to constrained to the range $\{0, \ldots , \ParamJ{r} - 1\}$. This would require more 
  constraints in the circuit which are unnecessary since they are only used to compute a group scalar 
  multiplication (which requires the bit-decomposition). If a congruent representation is given, the 
  resulting group element would be the same, even if an overflow occurs. Witnessing this value serves 
  only as a proof-of-knowledge of the secret. Moreover, since the Groth16 proofs are already randomized 
  for zero-knowledge, it therefore does not make a difference if the prover uses a (possible) congruent 
  value of $\alpha, \EphemeralPrivate, \AuthProvePrivate$.
    }

\begin{comment}
\sapling{
\lsubsection{In-band secret distribution (\SaplingText)}{saplinginband}

In \Sapling, the secrets that need to be transmitted to a recipient of funds
in order for them to later spend, are $\Diversifier$, $\Value$, and $\NoteCommitRand$.
A \memo (\crossref{noteptconcept}) is also transmitted.

To transmit these secrets securely to a recipient \emph{without} requiring
an out-of-band communication channel, the \diversifiedTransmissionKey
$\DiversifiedTransmitPublic$ is used to encrypt them. The recipient's
possession of the associated \incomingViewingKey $\InViewingKey$ is used to
reconstruct the original \note and \memo.

Unlike in a \Sprout{} \joinSplitDescription, each \Sapling{} \shieldedOutput
is encrypted by a fresh ephemeral \publicKey.

\vspace{0.5ex}
\introlist
For both encryption and decryption,
\vspace{0.5ex}
\begin{itemize}
  \item let $\OutViewingKeyLength$ be as defined in \crossref{constants};
  \item let $\Sym$ be the scheme instantiated in \crossref{concretesym};
  \item let $\KDFSapling$ be the \keyDerivationFunction instantiated in \crossref{concretesaplingkdf};
  \item let $\KASapling$ be the \keyAgreementScheme instantiated in \crossref{concretesaplingkeyagreement};
  \item let $\ellJ$ and $\reprJ$ be as defined in \crossref{jubjub};
  \item let $\ExtractJ$ be as defined in \crossref{concreteextractorjubjub};
        \vspace{-0.5ex}
  \item let $\PRFock{}$ be as instantiated in \crossref{concreteprfs}.
\end{itemize}
} %sapling


\sapling{
\lsubsubsection{Encryption (\SaplingText)}{saplingencrypt}

Let $\DiversifiedTransmitPublicNew \typecolon \KASaplingPublicPrimeOrder$ be the
\diversifiedTransmissionKey for the intended recipient address of a new \Sapling{} \note,
and let $\DiversifiedTransmitBaseNew \typecolon \KASaplingPublicPrimeOrder$ be the corresponding
\diversifiedBase computed as $\DiversifyHash(\Diversifier)$.

Since \Sapling \note encryption is used only in the context of \crossref{saplingsend}, we may assume that
$\DiversifiedTransmitBaseNew$ has already been calculated and is not $\bot$.

Let $\OutViewingKey \typecolon \maybe{\OutViewingKeyType}$ be as described in \crossref{saplingsend},
i.e.\ the \outgoingViewingKey of the \paymentAddress from which the \note is being spent, or an
\outgoingViewingKey associated with a \cite{ZIP-32} account, or $\bot$.

\introsection
Let \masp{$\NotePlaintext{} = (\Diversifier, \Value, \NoteCommitRandBytes, \Memo, \NoteToken)$} be the \Sapling{} \notePlaintext.

$\NotePlaintext{}$ is encoded as defined in \crossref{notept}.

Let $\cvNew{}$ be the \valueCommitment for the new \note, and let $\cmNew{}$ be the \noteCommitment.

\introlist
\vspace{1ex}
Then to encrypt:
\begin{algorithm}
\vspace{-1ex}
  \item choose a uniformly random ephemeral \privateKey $\EphemeralPrivate \leftarrowR \KASaplingPrivate \setminus \setof{0}$
  \item let $\EphemeralPublic = \KASaplingDerivePublic(\EphemeralPrivate, \DiversifiedTransmitBaseNew)$
  \item let $\TransmitPlaintext{}$ be the raw encoding of $\NotePlaintext{}$
  \item let $\DHSecret{} = \KASaplingAgree(\EphemeralPrivate, \DiversifiedTransmitPublicNew)$
  \item let $\TransmitKey{} = \KDFSapling(\DHSecret{}, \EphemeralPublic)$
  \item let $\TransmitCiphertext{} = \SymEncrypt{\TransmitKey{}}(\TransmitPlaintext{})$
  \item if $\OutViewingKey = \bot$:
  \item \tab choose random $\OutCipherKey \leftarrowR \Keyspace$ and $\OutPlaintext \leftarrowR \byteseq{(\ellJ + 256)/8}$
  \item else:
  \item \tab let $\cvField = \LEBStoOSP{\ellJ}\big(\reprJ(\cvNew{})\kern-0.12em\big)$
  \item \tab let $\cmuField = \LEBStoOSP{256}\big(\ExtractJ(\cmNew{})\kern-0.12em\big)$
  \item \tab let $\ephemeralKey = \LEBStoOSPOf{\ellJ}{\reprJ\Of{\EphemeralPublic}\kern 0.03em}$
  \item \tab let $\OutCipherKey = \PRFock{\OutViewingKey}(\cvField, \cmuField, \ephemeralKey)$
        \vspace{0.5ex}
  \item \tab let $\OutPlaintext = \LEBStoOSPOf{\ellJ + 256}{\reprJ(\DiversifiedTransmitPublicNew) \,\bconcat\, \ItoLEBSPOf{256}{\EphemeralPrivate}\kern-0.12em}$
  \item \vspace{-2ex}
  \item let $\OutCiphertext = \SymEncrypt{\OutCipherKey}(\OutPlaintext)$
\end{algorithm}

The resulting \noteCiphertext is $(\EphemeralPublic, \TransmitCiphertext{}, \OutCiphertext)$.

\pnote{
It is technically possible to replace $\TransmitCiphertext{}$ for a given \note
with a random (and undecryptable) dummy ciphertext, relying instead on out-of-band
transmission of the \note to the recipient. In this case the ephemeral key \MUST
still be generated as a random \publicKey (rather than a random bit sequence) to ensure
indistinguishability from other \outputDescriptions. This mode of operation raises
further security considerations, for example of how to validate a \Sapling{} \note
received out-of-band, which are not addressed in this document.
} %pnote
} %sapling
\end{comment}
\begin{comment}
\sapling{
\lsubsubsection{Decryption using an Incoming Viewing Key (\SaplingText)}{saplingdecryptivk}

Let $\InViewingKey \typecolon \InViewingKeyTypeSapling$ be the recipient's \incomingViewingKey,
as specified in \crossref{saplingkeycomponents}.

Let $(\EphemeralPublic, \TransmitCiphertext{}, \OutCiphertext)$ be the \noteCiphertext from the
\outputDescription{}. Let $\cmuField$ be that field of the \outputDescription (encoding the
$u$-coordinate of the \noteCommitment).

\introlist
The recipient will attempt to decrypt the $\EphemeralPublic$ and $\TransmitCiphertext{}$
components of the \noteCiphertext as follows:
\begin{algorithm}
\vspace{-0.5ex}
  \item let $\DHSecret{} = \KASaplingAgree(\InViewingKey, \EphemeralPublic)$
  \item let $\TransmitKey{} = \KDFSapling(\DHSecret{}, \EphemeralPublic)$
  \item let $\TransmitPlaintext{} = \SymDecrypt{\TransmitKey{}}(\TransmitCiphertext{})$
\vspace{-0.25ex}
  \item if $\TransmitPlaintext{} = \bot$, return $\bot$
\vspace{-0.25ex}
  \item extract $\NotePlaintext{} = (\Diversifier \typecolon \DiversifierType, \Value \typecolon \ValueType,
\NoteCommitRandBytes \typecolon \NoteCommitSaplingTrapdoorBytes, \Memo \typecolon \MemoType)$ from $\TransmitPlaintext{}$
  \item let $\NoteCommitRand = \LEOStoIPOf{256}{\NoteCommitRandBytes}$
        and $\DiversifiedTransmitBase = \DiversifyHash(\Diversifier)$
  \item if $\NoteCommitRand \geq \ParamJ{r}$ or $\DiversifiedTransmitBase = \bot$, return $\bot$
  \item let $\DiversifiedTransmitPublic = \KASaplingDerivePublic(\InViewingKey, \DiversifiedTransmitBase)$
  \item let $\cmU' = \ExtractJ\big(\NoteCommitSapling{\NoteCommitRandNew{}}(\reprJ\Of{\DiversifiedTransmitBase},
                                                                            \reprJ\Of{\DiversifiedTransmitPublic},
                                                                            \Value)\kern-0.12em\big)$.
  \item if $\LEBStoOSPOf{256}{\cmU'} \neq \cmuField$, return $\bot$, else return $\NotePlaintext{}$.
\end{algorithm}

\vspace{-0.5ex}
A received \Sapling{} \note is necessarily a \positionedNote, and so its
$\NoteAddressRand$ value can immediately be calculated as described in
\crossref{commitmentsandnullifiers}.

To test whether a \Sapling{} \note is unspent in a particular \blockchain also requires
the \nullifierKey $\AuthProvePublicRepr$; the coin is unspent if and only if
$\nf = \PRFnfSapling{\AuthProvePublicRepr}\big(\reprJ(\NoteAddressRand)\kern-0.15em\big)$ is not in the
\nullifierSet for that \blockchain.

\pnote{
A \note can change from being unspent to spent as a node's view of the
\bestValidBlockchain is extended by new \transactions. Also, \blockchainReorganizations
can cause a node to switch to a different \bestValidBlockchain that does not
contain the \transaction in which a \note was output.
} %pnote
} %sapling


\sapling{
\lsubsubsection{Decryption using a Full Viewing Key (\SaplingText)}{saplingdecryptovk}

\vspace{-0.5ex}
Let $\OutViewingKey \typecolon \OutViewingKeyType$ be the \outgoingViewingKey, as specified
in \crossref{saplingkeycomponents}, that is to be used for decryption.
(If $\OutViewingKey = \bot$ was used for encryption, the payment is not decryptable by
this method.)

Let $(\EphemeralPublic, \TransmitCiphertext{}, \OutCiphertext)$ be the \noteCiphertext,
and let $\cvField$, $\cmuField$, and $\ephemeralKey$ be those
fields of the \outputDescription (encoding the \valueCommitment, the $u$-coordinate
of the \noteCommitment, and $\EphemeralPublic$).

\introlist
\vspace{0.5ex}
The \outgoingViewingKey holder will attempt to decrypt the \noteCiphertext as follows:

\introlist
\vspace{-0.5ex}
\begin{algorithm}
  \item let $\OutCipherKey = \PRFock{\OutViewingKey}(\cvField, \cmuField, \ephemeralKey)$
  \item let $\OutPlaintext = \SymDecrypt{\OutCipherKey}(\OutCiphertext)$
  \item if $\OutPlaintext = \bot$, return $\bot$
\vspace{-0.25ex}
  \item extract $(\DiversifiedTransmitPublicRepr \typecolon \ReprJ,
        \EphemeralPrivateBytes \typecolon \EphemeralPrivateBytesType)$ from $\OutPlaintext$
  \item let $\EphemeralPrivate = \LEOStoIPOf{256}{\EphemeralPrivateBytes}$
        and $\DiversifiedTransmitPublic = \abstJ\Of{\DiversifiedTransmitPublicRepr}$
  \item if $\EphemeralPrivate \geq \ParamJ{r}$ or $\DiversifiedTransmitPublic \notin \KASaplingPublicPrimeOrder$, return $\bot$
  \item let $\DHSecret{} = \KASaplingAgree(\EphemeralPrivate, \DiversifiedTransmitPublic)$
  \item let $\TransmitKey{} = \KDFSapling(\DHSecret{}, \EphemeralPublic)$
  \item let $\TransmitPlaintext{} = \SymDecrypt{\TransmitKey{}}(\TransmitCiphertext{})$
\vspace{-0.25ex}
  \item if $\TransmitPlaintext{} = \bot$, return $\bot$
\vspace{-0.25ex}
  \item extract $\NotePlaintext{} = (\Diversifier \typecolon \DiversifierType, \Value \typecolon \ValueType,
\NoteCommitRandBytes \typecolon \NoteCommitSaplingTrapdoorBytes, \Memo \typecolon \MemoType)$ from $\TransmitPlaintext{}$
  \item let $\NoteCommitRand = \LEOStoIPOf{256}{\NoteCommitRandBytes}$
        and $\DiversifiedTransmitBase = \DiversifyHash(\Diversifier)$
  \item if $\NoteCommitRand \geq \ParamJ{r}$ or $\DiversifiedTransmitBase = \bot$, return $\bot$
  \item if $\KASaplingDerivePublic(\EphemeralPrivate, \DiversifiedTransmitBase) \neq \EphemeralPublic$,
        return $\bot$
  \item let $\cmU' = \ExtractJ\big(\NoteCommitSapling{\NoteCommitRandNew{}}(\reprJ\Of{\DiversifiedTransmitBase},
                                                                            \reprJ\Of{\DiversifiedTransmitPublic},
                                                                            \Value)\kern-0.12em\big)$.
  \item if $\LEBStoOSPOf{256}{\cmU'} \neq \cmuField$, return $\bot$, else return $\NotePlaintext{}$.
\end{algorithm}
} %sapling

\vspace{-0.5ex}
\pnote{For a valid \transaction it must be the case that
$\ephemeralKey = \LEBStoOSP{\ellJ}\big(\reprJ\Of{\EphemeralPublic}\kern-0.15em\big)$.}


\lsubsection{\Blockchain{} Scanning\pSproutOrNothingText}{sproutscan}

Let $\PRFOutputLengthSprout$ be as defined in \crossref{constants}.

Let $\NoteTypeSprout$ be as defined in \crossref{notes}.

Let $\KASprout$ be as defined in \crossref{concretesproutkeyagreement}.

\vspace{1ex}
\introsection
The following algorithm can be used, given the \blockchain and a
\SproutOrNothing{} \spendingKey $\AuthPrivate$, to obtain each \note sent
to the corresponding \paymentAddress, its \memo field, and its final status
(spent or unspent).

\vspace{1ex}
Let $\InViewingKey = (\AuthPublic \typecolon \PRFOutputSprout, \TransmitPrivate \typecolon \KASproutPrivate)$
be the \incomingViewingKey corresponding to $\AuthPrivate$, and let $\TransmitPublic$ be the associated
\transmissionKey, as specified in \crossref{sproutkeycomponents}.

\vspace{1ex}
\begin{algorithm}
  \item Initialize $\ReceivedSet \typecolon \powerset{\NoteTypeSprout \times \MemoType} = \setof{}$.
  \item Initialize $\SpentSet \typecolon \powerset{\NoteTypeSprout} = \setof{}$.
  \item Initialize $\NullifierMap \typecolon \PRFOutputSprout \rightarrow \NoteTypeSprout$ to the empty mapping.
        \vspace{1ex}
  \item For each \transaction $\tx$,
  \item \tab For each \joinSplitDescription in $\tx$,
  \item \tab \tab Let $(\EphemeralPublic, \TransmitCiphertext{\allNew})$ be the \notesCiphertext
                  of the \joinSplitDescription.
  \item \tab \tab For $i$ in $\allNew$,
  \item \tab \tab \tab Attempt to decrypt the \noteCiphertext component
                       $(\EphemeralPublic, \TransmitCiphertext{i})$ using $\InViewingKey$ with the
                       \vspace{-1.2ex}
  \item \tab \tab \tab algorithm in \crossref{sproutdecrypt}. If this succeeds giving $\NotePlaintext{}$:
  \item \tab \tab \tab \tab Extract $\NoteTuple{}$ and $\Memo \typecolon \MemoType$ from $\NotePlaintext{}$
                            (taking the $\AuthPublic$ field of the \note to be $\AuthPublic$ from
                            $\InViewingKey$).
  \item \tab \tab \tab \tab Add $(\NoteTuple{}, \Memo)$ to $\ReceivedSet$.
  \item \tab \tab \tab \tab Calculate the nullifier $\nf$ of $\NoteTuple{}$ using $\AuthPrivate$
                            as described in \crossref{notes}.
  \item \tab \tab \tab \tab Add the mapping $\nf \rightarrow \NoteTuple{}$ to $\NullifierMap$.
  \item \vspace{-2ex}
  \item \tab \tab Let $\nf_{\allOld}$ be the \nullifiers of the \joinSplitDescription.
  \item \tab \tab For $i$ in $\allOld$,
  \item \tab \tab \tab If $\nf_i$ is present in $\NullifierMap$, add $\NullifierMap(\nf_i)$
                       to $\SpentSet$.
  \item \vspace{-2ex}
  \item Return $(\ReceivedSet, \SpentSet)$.
\end{algorithm}


\sapling{
\lsubsection{\Blockchain{} Scanning (\SaplingText)}{saplingscan}

In \Sapling, \blockchain scanning requires only the $\AuthProvePublic$ and $\InViewingKey$
key components, rather than a \spendingKey as in \Sprout.

Typically, these components are derived from a \fullViewingKey as described in
\crossref{saplingkeycomponents}.

\vspace{1ex}
Let $\PRFOutputLengthNfSapling$ be as defined in \crossref{constants}.

Let $\NoteTypeSapling$ be as defined in \crossref{notes}.

Let $\KASapling$ be as defined in \crossref{concretesaplingkeyagreement}.

\introsection
\vspace{1ex}
The following algorithm can be used, given the \blockchain and
$(\AuthProvePublic \typecolon \SubgroupJ, \InViewingKey \typecolon \InViewingKeyTypeSapling)$,
to obtain each \note sent to the corresponding \paymentAddress, its \memo field,
and its final status (spent or unspent).

\vspace{1ex}
\begin{algorithm}
  \item Initialize $\ReceivedSet \typecolon \powerset{\NoteTypeSapling \times \MemoType} = \setof{}$.
  \item Initialize $\SpentSet \typecolon \powerset{\NoteTypeSapling} = \setof{}$.
  \item Initialize $\NullifierMap \typecolon \PRFOutputNfSapling \rightarrow \NoteTypeSapling$ to the empty mapping.
        \vspace{1ex}
  \item For each \transaction $\tx$,
  \item \tab For each \outputDescription in $\tx$ with \notePosition $\NotePosition$,
  \item \tab \tab Attempt to decrypt the \noteCiphertext components
                  $\EphemeralPublic$ and $\TransmitCiphertext{}$ using $\InViewingKey$ with the algorithm\vspace{-1.2ex}%
  \item \tab \tab in \crossref{saplingdecryptivk}. If this succeeds giving $\NotePlaintext{}$:
  \item \tab \tab \tab Extract $\NoteTuple{}$ and $\Memo \typecolon \MemoType$ from $\NotePlaintext{}$.
  \item \tab \tab \tab Add $(\NoteTuple{}, \Memo)$ to $\ReceivedSet$.
  \item \tab \tab \tab Calculate the nullifier $\nf$ of $\NoteTuple{}$ using $\AuthProvePublic$
                       and $\NotePosition$ as described in \crossref{notes}.
  \item \tab \tab \tab Add the mapping $\nf \rightarrow \NoteTuple{}$ to $\NullifierMap$.
  \item \vspace{-2ex}
  \item \tab For each \spendDescription in $\tx$,
  \item \tab \tab Let $\nf$ be the \nullifier of the \spendDescription.
  \item \tab \tab If $\nf$ is present in $\NullifierMap$, add $\NullifierMap(\nf)$ to $\SpentSet$.
  \item \vspace{-2ex}
  \item Return $(\ReceivedSet, \SpentSet)$.
\end{algorithm}

\begin{nnotes}
  \item The above algorithm does not use the $\OutViewingKey$ key component, or the $\OutCiphertext$
        \noteCiphertext component. When scanning the whole \blockchain, these are indeed not necessary.
        The advantage of supporting decryption using $\OutViewingKey$ as described in \crossref{saplingdecryptovk},
        is that it allows recovering information about the \notePlaintexts sent in a \transaction from that
        \transaction alone.
  \item When scanning only part of a \blockchain, it may be useful to augment the above algorithm with
        decryption of $\OutCiphertext$ components for each \transaction, in order to obtain information
        about \notes that were spent in the scanned period but received outside it.
  \item The above algorithm does not detect \notes that were sent ``out-of-band'' or with incorrect
        \noteCiphertexts. It is possible to detect whether such \notes were spent only if their \nullifiers
        are known.
\end{nnotes}
} %sapling

\end{comment}

\end{document}
